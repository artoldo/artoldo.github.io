<!-- Version: 7.7.1 | Last Update: 2025-11-24 | Author: Sacrisoft | © All rights reserved -->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Sacrisoft CORE Creator™ — Compose Online Ready Experiences</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="noindex, nofollow" name="robots"/>
<link href="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/css/uikit.min.css" rel="stylesheet"/>
<style>

/* positioning for existing edit / remove buttons (you provided) */
.editor-remove-btn {
position: absolute;
top: 16px;
right: 32px;
z-index: 20;
}
.editor-edit-btn {
position: absolute;
top: 16px;
left: 20px;
z-index: 20;
}

/* same visual / z placement for move buttons — centered */
.editor-move-wrapper {
position: absolute;
top: 16px;
left: 50%;
transform: translateX(-50%);
z-index: 20;
display: flex;
gap: 6px;
}

/* keep the same button shape/look as other icon buttons */
.editor-move-up,
.editor-move-down {
position: relative; /* keep them flow inside the wrapper */
top: 0;
z-index: 20;
}

/* small optional tweak so disabled buttons visually match UIkit's disabled look */
.editor-move-up[disabled],
.editor-move-down[disabled],
.editor-remove-btn[disabled],
.editor-edit-btn[disabled] {
opacity: 0.6;
cursor: not-allowed;
}

.live-paragraph { font-size: 1.13rem; max-width: 40em; margin-left:auto; margin-right:auto;}

/* Simple 3-size system for text blocks */
.live-heading.h-sm { font-size: 2.2rem; line-height: 1.15; }
.live-heading.h-md { font-size: 3.2rem; line-height: 1.12; }
.live-heading.h-lg { font-size: 4.2rem; line-height: 1.08; }

.live-subtitle.sub-sm { font-size: 1.1rem; font-weight: 500; }
.live-subtitle.sub-md { font-size: 1.35rem; font-weight: 500; }
.live-subtitle.sub-lg { font-size: 1.7rem; font-weight: 500; }

.live-paragraph.p-sm { font-size: 1.0rem; }
.live-paragraph.p-md { font-size: 1.13rem; }
.live-paragraph.p-lg { font-size: 1.30rem; }

@media (max-width: 640px) {
.live-heading.h-lg { font-size: 2.6rem; }
.live-heading.h-md { font-size: 2.0rem; }
.live-heading.h-sm { font-size: 1.6rem; }

.live-subtitle.sub-lg { font-size: 1.2rem; }
.live-subtitle.sub-md { font-size: 1.05rem; }
.live-subtitle.sub-sm { font-size: 0.95rem; }

.live-paragraph.p-lg { font-size: 1.05rem; }
.live-paragraph.p-md { font-size: 0.98rem; }
.live-paragraph.p-sm { font-size: 0.92rem; }
}

.live-paragraph.uk-text-large { font-size: 1.45rem; }
@media (max-width: 640px) {
.live-paragraph { font-size: 1rem;}
.live-paragraph.uk-text-large { font-size: 1.1rem;}
}
.uk-navbar-container.sticky-colored {
background: #fff !important;
}
.sticky-colored .uk-navbar-item,
.sticky-colored .uk-navbar-item span,
.sticky-colored .uk-navbar-item svg,
.sticky-colored .uk-navbar-item .uk-icon {
color: #fff !important;
fill: #fff !important;
}
.sticky-colored .uk-navbar-item .uk-icon [stroke] {
stroke: #fff !important;
}
.uk-sortable-handle { cursor: move; }

@media (max-width: 640px) {
.live-heading, .live-subtitle, .live-paragraph {
text-align: center !important;
word-break: break-word;
white-space: normal;
}
}      

/* Style the file input button */
#media-file::file-selector-button,
#gm-images::file-selector-button,
#navbar-logo::file-selector-button,
#site-social-file::file-selector-button,
#site-favicon-file::file-selector-button {
padding: 10px 20px;       /* make button bigger */
font-size: 16px;           /* larger text */
font-weight: bold;         /* optional */
color: #fff;               /* text color */
background-color: #000;    /* black button */
border: none;
border-radius: 25px;        /* rounded corners */
cursor: pointer;
transition: background-color 0.2s;
}

#media-file::file-selector-button:hover,
#gm-images::file-selector-button:hover,
#navbar-logo::file-selector-button:hover,
#site-social-file::file-selector-button:hover,
#site-favicon-file::file-selector-button:hover {
background-color: orange;    
}

.navbar-scroll {
display: flex;
flex-wrap: nowrap;        /* keep one line */
gap: 1rem;
overflow-x: auto;
white-space: nowrap;      /* keep text on one line */
-webkit-overflow-scrolling: touch;
padding: 0.5rem 1rem;
align-items: center; /* vertical center */
list-style: none;    /* when used as <ul> */
margin: 0;
}

.navbar-scroll a {
flex: 0 0 auto;          /* avoid shrinking/wrapping */
text-decoration: none;
color: inherit;
}

.navbar-scroll a.uk-active {
font-weight: bold;
border-bottom: 2px solid currentColor;
}

.navbar-group {
display: flex;
gap: 0.5rem;
flex: 0 0 auto;
align-items: center; /* ensure icons align with text */
}

#nav-title {
display: flex;
align-items: center;
gap: 0.3rem;
}
    
.navbar-logo {
height: 40px !important;
width: auto !important;
max-height: 40px !important;
object-fit: contain;
flex-shrink: 0 !important;
flex-grow: 0 !important;
}

.navbar-scroll {
display: flex;
flex-wrap: nowrap;
overflow-x: auto;
-webkit-overflow-scrolling: touch;
white-space: nowrap;
gap: 1rem;
padding: 0.5rem 1rem;

}
.navbar-scroll li {
flex: 0 0 auto;
list-style: none;
}

.visually-hidden {
position: absolute !important;
width: 1px; height: 1px;
margin: -1px; padding: 0; border: 0;
overflow: hidden; clip: rect(0 0 0 0); clip-path: inset(50%);
white-space: nowrap;
}

:root {
--navbar-link-color: #000000;
}

.navbar-scroll::-webkit-scrollbar {
height: 6px;
}
.navbar-scroll::-webkit-scrollbar-thumb {
background: var(--navbar-link-color);
border-radius: 3px;
}
.navbar-scroll::-webkit-scrollbar-track {
background: var(--gray, #eee);
}

.navbar-scroll {
-ms-overflow-style: none;  /* IE & Edge */
scrollbar-width: none;     /* Firefox */
}
.navbar-scroll::-webkit-scrollbar {
display: none;             /* Chrome, Safari, Opera */
}

#main-navbar .navbar-scroll {
display: flex;
justify-content: center; /* centers horizontally */
}

#site-title-h1 {
display: none !important;
}

#dynamic-navbar-container .navbar-scroll a img {
display: block;
}
#dynamic-navbar-container .navbar-scroll a:has(img) {
text-decoration: none !important;
border-bottom: none !important;
}

.wrap {
min-height:100%;
display:flex;align-items:center;justify-content:center;
overflow:hidden;
}
.wrap iframe, .wrap video {
position:absolute;
top:50%; left:50%;
transform:translate(-50%,-50%);
min-width:100%; min-height:100%;
width:auto; height:auto;
}

/* Gallery Maker drag hint */
#gallery-modal #gm-gallery .uk-card { cursor: grab; }
#gallery-modal #gm-gallery .uk-card:active { cursor: grabbing; }

/* optional: prevent accidental dragging/selection of the image itself */
#gallery-modal #gm-gallery img {
user-select: none;
-webkit-user-drag: none;
}

/* Label row with text + toggle */
.switch-label {
display: flex;
align-items: center;
gap: 10px;
font-weight: 600;
margin-top: 20px;
color: #000;
}

/* Toggle shell */
.switch {
position: relative;
display: inline-block;
width: 50px;
height: 28px;
}

/* Hide native checkbox */
.switch input {
opacity: 0;
width: 0;
height: 0;
}

/* Track */
.slider {
position: absolute;
cursor: pointer;
inset: 0;
background-color: #ccc;
transition: 0.4s;
border-radius: 34px;
}

/* Knob */
.slider::before {
content: "";
position: absolute;
height: 20px;
width: 20px;
left: 4px;
bottom: 4px;
background-color: #fff;
transition: 0.4s;
border-radius: 50%;
}

/* On state */
.switch input:checked + .slider {
background-color: orange;
}
.switch input:checked + .slider::before {
transform: translateX(22px);
}

/* Focus ring / disabled */
.switch input:focus + .slider {
box-shadow: 0 0 0 2px rgba(255, 165, 0, 0.35);
}
.switch input:disabled + .slider {
opacity: 0.5;
cursor: not-allowed;
}

/* Color picker styling */
input[type="color"] {
-webkit-appearance: none; /* remove default styling */
appearance: none;
width: 3em;
height: 3em;
border-radius: 50%;
border: 8px solid transparent; /* outer border */
padding: 0; /* remove default padding */
cursor: pointer;
box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
background: none; /* JS will paint the background */
transition: transform 0.2s ease;
background-clip: padding-box;
}

/* Remove inner shadow / border in Chrome */
input[type="color"]::-webkit-color-swatch-wrapper {
padding: 0;
border: none;
}

input[type="color"]::-webkit-color-swatch {
border: none;
border-radius: 50%;
padding: 0;
background-color: var(--fallback-color, #ffffff); /* fallback if JS fails */
}

input[type="color"]:hover {
transform: scale(1.1);
}

.color-row {
display: flex;
justify-content: space-between;
align-items: center;
gap: 1.4em;
margin-top: 1.4em;
}

.color-row label {
display: flex;
flex-direction: column;
align-items: center;
flex: 1;
text-align: center;
}

.color-row input[type="color"] {
margin-top: 0.6em;
align-self: center;
}

/* Prevent repaint flicker when color pickers are inside a modal */
.uk-modal input[type="color"] {
transition: none !important;
transform: none !important;
}

/* 1) Blur the background behind UIkit modals (no fade) */
.uk-modal {
/* must have some alpha for backdrop-filter to apply */
background: rgba(17, 18, 20, 0.25) !important;
-webkit-backdrop-filter: blur(12px) saturate(120%);
backdrop-filter: blur(12px) saturate(120%);
transition: none !important;
}
.uk-modal.uk-open { opacity: 1 !important; }

/* 2) While any modal is open, "freeze" the page behind it */
#page { contain: paint; } /* cheaper repaints by default */
html.uk-modal-page #page {
backface-visibility: hidden;
transform: translateZ(0);
pointer-events: none; /* prevents hover/animations under overlay */
}

/* 3) Cancel hover transforms that might still run under the overlay */
html.uk-modal-page input[type="color"]:hover { transform: none !important; }
html.uk-modal-page .hover-zoom { transition: none !important; transform: none !important; }

/* Keep layout width stable when UIkit toggles scrolling */
:root { scrollbar-gutter: stable; }
/* Fallback (older Safari): keep vertical scrollbar reserved */
html { overflow-y: scroll; }

/* Reserve vertical scrollbar gap so page width doesn't jump */
:root { scrollbar-gutter: stable; }
html { overflow-y: scroll; } /* fallback for older browsers */

/* Make modal dialogs stable and avoid ancestor transforms.
Apply a soft max-height with internal scrolling for tall content. */
.uk-modal-dialog {
max-height: 90vh;            /* keep modal inside viewport */
overflow: auto;              /* allow internal scroll instead of page scrollbar */
-webkit-overflow-scrolling: touch;
will-change: transform, opacity;
backface-visibility: hidden;
transform: translateZ(0);    /* promote to its own layer (GPU) */
}

/* if you use uk-modal-full or similar, limit its content as well */
.uk-modal.full .uk-modal-dialog {
max-height: 100vh;
}

/* avoid forced reflow by not toggling transitions that cause layout */
.uk-modal { transition: opacity .12s ease-out; }
.uk-modal.uk-open { opacity: 1; }

.uk-modal { opacity: 0; transition: opacity .12s linear; }
.uk-modal.uk-open { opacity: 1; }


/* Make the group visually one pill: rounded left on first, rounded right on last */
#text-align-group .uk-button {
border-radius: 0;              /* remove radius for all by default so sides join cleanly */
}

/* First button: rounded left corners */
#text-align-group .uk-button:first-child {
border-top-left-radius: 25px;
border-bottom-left-radius: 25px;
}

/* Last button: rounded right corners */
#text-align-group .uk-button:last-child {
border-top-right-radius: 25px;
border-bottom-right-radius: 25px;
}

/* Optional: ensure no gaps / overlap from borders — make group overflow hidden */
#text-align-group {
display: inline-flex; /* keeps buttons inline and removes gaps between inline-block children */
overflow: hidden;     /* clips any radiused corners cleanly */
align-items: stretch;
vertical-align: middle;
}

/* Optional: remove double borders between buttons (if present) */
#text-align-group .uk-button + .uk-button {
margin-left: 0; /* ensure no gaps — adjust if you want a tiny separator */
border-left-width: 0; /* hide left border to avoid double border glitch */
}

/* Show placeholder when div is empty */
#text-paragraph:empty::before {
content: "Type your text here..."; /* placeholder text */
color: #999;                       /* placeholder color */
pointer-events: none;              /* clicks go through */
display: block;
}

/* put this in your modal CSS */
#text-modal input,
#text-modal textarea,
#text-modal .uk-input,
#text-modal .uk-textarea {
  text-align: left !important;
}

/* ========================================================================
Style modifiers
========================================================================== */

.uk-icon-button {
background: #fff;
color: #000;
}

.uk-icon-button:hover {
background-color: #000;
color: #fff;
}

.uk-icon-button:active,
.uk-active > .uk-icon-button {
background-color: #000;
color: #fff;
}

:root {
--stripe-color: #000;        /* default stripe color */
--stripe-focus: orange;    /* orange on focus — change to your brand hex */
}

/* Base: remove global rounded corners & show 3px bottom stripe only */
.uk-input,
.uk-select,
.uk-textarea {
box-sizing: border-box;
background-color: #fff;
color: #000;
border: none;                     /* remove all borders */
border-radius: 0 !important;      /* override global radius */
outline: none;
padding: 0.5em 0.5em 0.5em 0.5em; /* adjust to taste */
border-bottom: 3px solid var(--stripe-color);
transition: border-color 160ms ease, box-shadow 160ms ease;
-webkit-appearance: none;         /* normalize select on Safari/Chrome */
}

/* Focus: change bottom stripe to orange */
.uk-input:focus,
.uk-select:focus,
.uk-textarea:focus {
border-bottom-color: var(--stripe-focus);
/* optionally add a subtle glow on focus for visibility */
box-shadow: 0 6px 10px -8px rgba(0,0,0,0.15);
}

/* Prefer keyboard-only focus indicator with :focus-visible (optional) */
.uk-input:focus:not(:focus-visible),
.uk-select:focus:not(:focus-visible),
.uk-textarea:focus:not(:focus-visible) {
/* keep visual focus change only for keyboard users — still change stripe color */
/* If you want stripe color change only for keyboard focus replace rules above with :focus-visible */
}

/* If you want the stripe animated between states */
.uk-input,
.uk-select,
.uk-textarea {
transition: border-bottom-color 180ms cubic-bezier(.2,.8,.2,1), box-shadow 180ms ease;
}

/* Hide native radio input */
.radio-wrapper .uk-radio {
position: absolute;
opacity: 0;
width: 0;
height: 0;
}

/* Label wrapper */
.radio-wrapper {
display: flex;
align-items: center;
cursor: pointer;
margin-bottom: 4px; /* smaller spacing */
font-size: 14px;    /* smaller font */
}

/* Custom radio circle */
.radio-custom {
width: 16px;          /* smaller circle */
height: 16px;
border: 2px solid #000;
border-radius: 50%;
margin-right: 6px;    /* less space between circle and text */
position: relative;
flex-shrink: 0;
background-color: #fff;
}

/* Checked state: black dot */
.uk-radio:checked + .radio-custom::after {
content: '';
position: absolute;
top: 50%;
left: 50%;
width: 8px;          /* smaller dot */
height: 8px;
background-color: #000;
border-radius: 50%;
transform: translate(-50%, -50%);
}

/* Disabled state */
.uk-radio:disabled + .radio-custom {
border-color: #888;
background-color: #eee;
cursor: not-allowed;
}

/* ========================================================================
Button 
========================================================================== */

/* Primary Button */
.uk-button-primary {
background-color: #000;
color: #fff;
}

/* Primary Button Hover */
.uk-button-primary:hover {
background-color: #000;
color: #fff;
}

/* Primary Button Active */
.uk-button-primary:active,
.uk-button-primary.uk-active {
background-color: #000;
color: #fff;
}

/* Secondary Button */
.uk-button-secondary {
background-color: #000;
color: #fff;
border: 1px solid transparent;
}

/* Secondary Button Hover */
.uk-button-secondary:hover {
background-color: #fff;
color: #000;
}

/* Secondary Button Active */
.uk-button-secondary:active,
.uk-button-secondary.uk-active {
background-color: #000;
color: #fff;
}

/* Contextual Secondary Button Overrides for UIkit Sections/Cards/Overlay */
.uk-light .uk-button-secondary,
.uk-section-primary:not(.uk-preserve-color) .uk-button-secondary,
.uk-section-secondary:not(.uk-preserve-color) .uk-button-secondary,
.uk-tile-primary:not(.uk-preserve-color) .uk-button-secondary,
.uk-tile-secondary:not(.uk-preserve-color) .uk-button-secondary,
.uk-card-primary.uk-card-body .uk-button-secondary,
.uk-card-primary > :not([class*='uk-card-media']) .uk-button-secondary,
.uk-card-secondary.uk-card-body .uk-button-secondary,
.uk-card-secondary > :not([class*='uk-card-media']) .uk-button-secondary,
.uk-overlay-primary .uk-button-secondary,
.uk-offcanvas-bar .uk-button-secondary {
background-color: #000;
color: #fff;
}

/* Save Button with Rainbow Effect */
.save {
margin-top: 0.8em;
padding: 0.5em 1.2em; /* keep width/height reasonable for UIkit */
font-size: 1.2em;
font-weight: bold;
color: #fff;
background: linear-gradient(270deg, red, orange, yellow, green, cyan, blue, violet, red);
background-size: 400% 400%;
border: none;
border-radius: 50px;
cursor: pointer;
box-shadow: 0 0 20px rgba(0,0,0,0.25);
transition: transform 0.2s ease, background-color 0.2s, color 0.2s;
animation: rainbowFlow 6s ease infinite;
}

/* secondary Button Hover */
.save:hover {
transform: scale(1.05); /* from your controls button */
background-color: #000;  /* keep your original hover effect */
color: #fff;
}

/* Rainbow Flow Animation */
@keyframes rainbowFlow {
0% { background-position: 0% 50%; }
50% { background-position: 100% 50%; }
100% { background-position: 0% 50%; }
}

/* ========================================================================
Background
========================================================================== */

/* Background utility */
.uk-background-primary {
background-color: #fff;
}

.uk-background-secondary {
background-color: #000;
}

/* ========================================================================
Links
========================================================================== */

.uk-link {
text-decoration: underline;
cursor: pointer;
}

.uk-link:hover,
.uk-link-toggle:hover .uk-link {
text-decoration: none;
}

/* ========================================================================
Tooltip
========================================================================== */

.uk-tooltip {
/* 1 */
display: none;
/* 2 */
position: absolute;
z-index: 1030;
--uk-position-offset: 10px;
--uk-position-viewport-offset: 10;
/* 3 */
top: 0;
/* 4 */
box-sizing: border-box;
max-width: 200px;
padding: 6px 12px;
/* 5 */
background: #000;
border-radius: 15px;
color: #fff;
font-size: 12px;
}

/* ========================================================================
Lightbox
========================================================================== */

.uk-lightbox-button {
box-sizing: border-box;
width: 50px;
height: 50px;
background: rgba(0, 0, 0, 0.3);
color: rgba(255, 255, 255, 0.7);
border-radius: 100%;
/* 1 */
display: inline-flex;
justify-content: center;
align-items: center;
}

.uk-lightbox-iframe {
width: 90%;
height: 90%;
border: 0px solid black;
border-radius: 0; /* Default: no rounding for Chrome, Brave, etc. */
}

/* Safari-only override */
@supports (-webkit-hyphens: none) and (not (-moz-appearance: none)) {
.uk-lightbox-iframe {
border-radius: 25px;
}
}

.uk-lightbox-toolbar {
padding: 5px 5px;
background: transparent;
color: rgba(255, 255, 255, 0.7);
}
.uk-lightbox-toolbar > * {
color: rgba(255, 255, 255, 0.7);
}

.uk-lightbox-toolbar-icon {
box-sizing: border-box;
width: 50px;
height: 50px;
background: #000;
color: #fff;
border-radius: 100%;
/* 1 */
display: inline-flex;
justify-content: center;
align-items: center;
}

/* ===== keep only the close button always visible (preserve exact look) ===== */

/* wide selector to match common UIkit close button variants */
.uk-lightbox .uk-lightbox-button.uk-close,
.uk-lightbox .uk-lightbox-button.uk-close svg,
.uk-lightbox .uk-close,
.uk-lightbox [data-uk-close],
.uk-lightbox [data-uk-close] > * {
/* DO NOT change visual properties (width/height/background/color/border-radius/flex)
— we only override visibility/stacking/interaction and remove hide transforms. */
position: fixed !important;        /* remove from hidden parent so it stays visible */
top: 5px !important;               /* align with toolbar padding — preserves placement */
right: 5px !important;             /* align with toolbar padding */
z-index: 999999 !important;        /* above overlays */
display: inline-flex !important;   /* keep your inline-flex layout */
opacity: 0.7 !important;             /* force fully visible */
visibility: visible !important;    /* force visible */
pointer-events: auto !important;   /* clickable even if parent is disabled */
transform: none !important;        /* cancel hide transforms */
transition: none !important;       /* prevent fade-out transitions */
animation: none !important;        /* stop any hiding animations */
}

/* If UIkit sets helper classes, undo them for close only */
.uk-lightbox .uk-lightbox-button.uk-close.uk-hidden,
.uk-lightbox .uk-lightbox-button.uk-close.uk-invisible,
.uk-lightbox .uk-close.uk-hidden,
.uk-lightbox .uk-close.uk-invisible,
.uk-lightbox [data-uk-close].uk-hidden,
.uk-lightbox [data-uk-close].uk-invisible {
display: inline-flex !important;
opacity: 0.7 !important;
visibility: visible !important;
pointer-events: auto !important;
}

/* keep SVG/icon inside intact (do not change color/size) */
.uk-lightbox .uk-lightbox-button.uk-close svg,
.uk-lightbox .uk-close svg {
position: static !important;
width: auto !important;
height: auto !important;
}

/* mobile tweak to avoid overlap while preserving look (keeps same size) */
@media (max-width: 480px) {
.uk-lightbox .uk-lightbox-button.uk-close,
.uk-lightbox .uk-close,
.uk-lightbox [data-uk-close] {
top: 8px !important;
right: 8px !important;
}
}

/* ========================================================================
Slider
========================================================================== */

.uk-slidenav {
padding: 5px 10px;
color: rgba(102, 102, 102, 0.5);
transition: color 0.1s ease-in-out;
width: 50px;
height: 50px;
background: rgba(0, 0, 0, 0.3);
color: rgba(255, 255, 255, 0.7);
border-radius: 100%;
display: inline-flex;
justify-content: center;
align-items: center;

}

/* ========================================================================
Additional CSS:
========================================================================== */

html {
-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
}

button:focus,
button:active {
-moz-outline: 0 !important;
-ms-outline:0 !important;
-o-outline: 0 !important;
-webkit-outline: 0 !important;
}

.uk-border-rounded {
border-radius: 25px;
}

/* Tweak notification container (UIkit) */

/* Warning message style */
.uk-notification .uk-notification-message.uk-notification-message-warning,
.uk-notification .uk-notification-message.uk-notification-warning {
background-color: #ffffff; /* white background */
color: #ff9000; /* orange text color */
padding: 14px 18px;
border: 3px dashed #ff9000; /* orange border */
border-radius: 25px; /* fully rounded corners */
max-width: 360px;
box-shadow: 0 8px 20px rgba(0,0,0,0.08);
overflow: hidden; /* important to make corners fully rounded */
font-size: 14px;
}

/* Remove background from inner elements if they exist */
.uk-notification .uk-notification-message-warning > * {
background: transparent;
}

/* Smaller bold label, clearer spacing */
.uk-notification .uk-notification-message.uk-notification-message-warning strong {
display: block;
font-weight: 700;
margin-bottom: 6px;
}

/* Ensure the custom radio circle is always visible */
.radio-custom {
  display: inline-block;
  position: relative;
  width: 16px;
  height: 16px;
  border: 2px solid #000;
  border-radius: 50%;
  background-color: #fff;
  flex-shrink: 0;
}

/* Checked state: black dot centered inside */
.radio-wrapper input.uk-radio:checked + .radio-custom::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 8px;
  height: 8px;
  background-color: #000;
  border-radius: 50%;
  transform: translate(-50%, -50%);
}

/* Disabled state styling */
.radio-wrapper input.uk-radio:disabled + .radio-custom {
  border-color: #888;
  background-color: #eee;
  cursor: not-allowed;
}

/* Optional: smooth transition when checking/unchecking */
.radio-wrapper .radio-custom::after {
  transition: all 0.2s ease;
}

/* ============================
Dynamic Navbar & Mobile Menu
============================ */

/* Mobile + Tablet: up to 1024px */
@media (max-width: 1024px) {

  /* ============================
     Mobile Menu Toggle (Hamburger)
  ============================ */
  #mobile-menu-toggle {
    display: flex;
    position: fixed;
    top: 12.5px;
    right: 10px;
    width: 40px;
    height: 40px;
    cursor: pointer;
    align-items: center;
    justify-content: center;

    z-index: 9999;       /* always above menu */
    isolation: isolate;  /* new stacking context */
    background: transparent;
  }
  /* Hide mobile menu toggle when Dynamic Nav Bar is disabled */
  body[data-navbar-enabled="0"] #mobile-menu-toggle,
  body[data-navbar-enabled="0"] #mobile-menu {
    display: none !important;
  }


  #mobile-menu-toggle .bar {
    width: 30px;
    height: 2px;
    background-color: var(--navbar-link-color, #000);
    position: absolute;
    border-radius: 1px;
    transition: all 0.4s ease;
    z-index: 2;          /* keep bars visible */
  }

  #mobile-menu-toggle .bar1 { top: 12px; }
  #mobile-menu-toggle .bar2 { top: 22px; }

  #mobile-menu-toggle.open .bar1 {
    top: 50%;
    transform: translateY(-50%) rotate(45deg);
  }

  #mobile-menu-toggle.open .bar2 {
    top: 50%;
    transform: translateY(-50%) rotate(-45deg);
  }

  /* ============================
     Mobile Menu Panel
  ============================ */
  #mobile-menu {
    display: none;
    position: fixed;
    top: 60px;
    left: 0;
    width: 100%;
    background-color: var(--navbar-bg-color, #fff);
    color: var(--navbar-text-color, #000);
    padding: 1rem 0;
    flex-direction: column;
    align-items: center;
    text-align: center;

    z-index: 9998;        /* below toggle */
  }

  #mobile-menu.show {
    display: flex;
  }

  #mobile-menu a {
    display: block;
    width: 100%;
    margin: 0.5rem 0;
    padding: 0.5rem 1.25rem;
    text-align: center;
    white-space: normal;
    word-break: break-word;
    overflow-wrap: break-word;
    color: var(--navbar-text-color, #000);
    text-decoration: none;
    background: transparent;
  }

  /* ============================
     Navbar container
  ============================ */
  #dynamic-navbar-container {
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    background-color: var(--navbar-bg-color, #fff);
    width: 100%;

    position: relative;
    z-index: 1;           /* always below toggle */
  }

  /* Hide navbar text links (optional) */
  #dynamic-navbar-container ul.navbar-scroll a:not(:has(img)) {
    display: none !important;
  }
}

/* ============================
Large screens: 1025px and above
=========================== */
@media (min-width: 1025px) {
  #mobile-menu-toggle { display: none !important; }
  #mobile-menu { display: none !important; }

  #dynamic-navbar-container ul.navbar-scroll a { display: inline-block !important; }
  #dynamic-navbar-container {
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    background-color: var(--navbar-bg-color, #fff);
    width: 100%;
    position: relative;
    z-index: 1;
  }
}

#mobile-menu .navbar-logo { display: none; }

/* Hide hamburger + panel ONLY in editor (toolbar exists there) */
#main-navbar ~ #page #mobile-menu-toggle,
#main-navbar ~ #page #mobile-menu {
  display: none !important;
}


/* FAQ Builder */
.faq-handle { cursor: move; }
.faq-item-card { padding: 12px; }
.faq-item-card .uk-input, .faq-item-card .uk-textarea { width: 100%; }

/* Slider Builder */
.slider-handle{cursor:move;}
.slider-item-card{padding:12px;}
.slider-thumb{width:84px;height:54px;object-fit:cover;border-radius:10px;}
.slider-thumb-wrap{width:84px;height:54px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.06);border-radius:10px;}
.slider-item-card .uk-input,.slider-item-card .uk-select{width:100%;}

/* Dynamic Nav Bar custom links */
.navbar-links-handle { cursor: move; }
.navbar-links-card { padding: 12px; }

</style>
</head>
<body id="top">
<h1 class="visually-hidden" id="site-title-h1">${siteSettings.title}</h1>
<div class="uk-background-secondary uk-text-center">
<img src="./images/icon.webp" width="50px"><span class="uk-heading" style="color:white;"><span class="uk-text-lighter">Sacrisoft</span> <strong>CORE</strong> Creator™</span>
</div>
<!-- Sticky Navbar (Toolbar) -->
<nav class="uk-navbar-container uk-navbar-transparent uk-sticky" id="main-navbar" uk-sticky="top: 100; animation: uk-animation-slide-top;">
<div class="navbar-scroll">
<div class="navbar-group">
<a class="uk-icon-button" id="loadJSON" uk-icon="upload" uk-tooltip="title: Load Website (JSON); pos: bottom"></a>
<a class="uk-icon-button" id="saveJSON" uk-icon="download" uk-tooltip="title: Save Website (JSON); pos: bottom"></a>
<a class="uk-icon-button" id="settingsBtn" uk-icon="settings" uk-tooltip="title: Site Settings; pos: bottom"></a>
<a class="uk-icon-button" id="navBarBtn" uk-icon="cog" uk-tooltip="title: Dynamic Nav Bar; pos: bottom"></a>
<a class="uk-icon-button" id="footerBtn" uk-icon="more" uk-tooltip="title: Footer Settings; pos: bottom"></a>
<a class="uk-icon-button" id="addTextBtn" uk-icon="file-text" uk-tooltip="title: Add Text; pos: bottom"></a>
<a class="uk-icon-button" id="addImageBtn" uk-icon="image" uk-tooltip="title: Add Image; pos: bottom"></a>
<a class="uk-icon-button" id="addGalleryBtn" uk-icon="thumbnails" uk-tooltip="title: Add Image Gallery; pos: bottom"></a>
<a class="uk-icon-button" id="addVideoBtn" uk-icon="video-camera" uk-tooltip="title: Add Video; pos: bottom"></a>
<a class="uk-icon-button" id="addSliderBtn" uk-icon="play-circle" uk-tooltip="title: Add Slideshow; pos: bottom"></a>
<a class="uk-icon-button" id="addFaqBtn" uk-icon="question" uk-tooltip="title: Add FAQ; pos: bottom"></a>
<a class="uk-icon-button" id="embedCodeBtn" uk-icon="code" uk-tooltip="title: Add Embed Code; pos: bottom"></a>
<a class="uk-icon-button" id="previewBtn" uk-icon="eye" uk-tooltip="title: Preview Website; pos: bottom"></a>
<a class="uk-icon-button" id="exportHTML" uk-icon="world" uk-tooltip="title: Export Website (HTML); pos: bottom"></a>
<input accept=".json" id="jsonFileInput" style="display:none" type="file"/>
</div>
</div>
</nav>

<!-- Second navbar container (rendered dynamically below the toolbar in editor) -->
<!-- Wrap the editor canvas (leave all modals as direct children of <body>) -->
<div id="page">
<div id="dynamic-navbar-container"></div>

<!-- Mobile Menu HTML -->
<div id="mobile-menu-toggle" aria-label="Toggle mobile menu">
  <div class="bar bar1"></div>
  <div class="bar bar2"></div>
</div>

<div id="mobile-menu" aria-hidden="true"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const enableNavbarCheckbox = document.getElementById('enable-navbar');
  const dynamicNavContainer = document.getElementById('dynamic-navbar-container');

  let observer;
  let menuBuilt = false;

  // Helpers
  const isSmallScreen = () => window.innerWidth <= 1024;
  const isNavbarEnabled = () => enableNavbarCheckbox && enableNavbarCheckbox.checked;
  const isMenuOpen = () => mobileMenu.classList.contains('show');

  // Populate mobile menu safely
  function populateMobileMenu(force = false) {
    if (!force && (menuBuilt || isMenuOpen())) return;

    const nav = dynamicNavContainer?.querySelector('ul.navbar-scroll');
    if (!nav || !mobileMenu) return;

    const navbarBg = getComputedStyle(nav.parentElement).backgroundColor;
    const navbarText = getComputedStyle(nav).color;

    document.documentElement.style.setProperty('--navbar-bg-color', navbarBg);
    document.documentElement.style.setProperty('--navbar-text-color', navbarText);
    document.documentElement.style.setProperty('--navbar-link-color', navbarText);

    const fragment = document.createDocumentFragment();
    mobileMenu.innerHTML = '';

    nav.querySelectorAll('a').forEach(link => {
      const clone = link.cloneNode(true);
      clone.removeAttribute('id');

      clone.addEventListener('click', (e) => {
        e.stopPropagation();
        closeMobileMenu();
      });

      fragment.appendChild(clone);
    });

    mobileMenu.appendChild(fragment);
    menuBuilt = true;
  }

  // Open/Close Menu
  function openMobileMenu() {
    populateMobileMenu();
    mobileMenu.classList.add('show');
    mobileMenuToggle.classList.add('open');
    mobileMenu.setAttribute('aria-hidden', 'false');
  }

  function closeMobileMenu() {
    mobileMenu.classList.remove('show');
    mobileMenuToggle.classList.remove('open');
    mobileMenu.setAttribute('aria-hidden', 'true');

    // Delay rebuild until animation finishes
    setTimeout(() => {
      menuBuilt = false;
      populateMobileMenu(true);
    }, 350); // match CSS transition
  }

  // Update visibility based on screen size and navbar checkbox
  function updateMobileMenuVisibility() {
    if (isNavbarEnabled() && isSmallScreen()) {
      mobileMenuToggle.style.display = 'flex';
    } else {
      mobileMenuToggle.style.display = 'none';
      closeMobileMenu();
    }
  }

  // Hardened MutationObserver
  function setupObserver() {
    if (!dynamicNavContainer) return;

    observer = new MutationObserver(() => {
      if (isMenuOpen()) return; // ignore mutations while menu is open
      menuBuilt = false;
      populateMobileMenu(true);
    });

    observer.observe(dynamicNavContainer, {
      childList: true,
      subtree: false
    });
  }

  // Events
  mobileMenuToggle.addEventListener('click', () => {
    isMenuOpen() ? closeMobileMenu() : openMobileMenu();
  });

  window.addEventListener('resize', updateMobileMenuVisibility);

  enableNavbarCheckbox?.addEventListener('change', () => {
    menuBuilt = false;
    populateMobileMenu(true);
    updateMobileMenuVisibility();
  });

  // Initial setup
  populateMobileMenu(true);
  updateMobileMenuVisibility();
  setupObserver();
});
</script>
<ul id="live-editor-root" class="uk-list uk-sortable" id="live-editor-root" uk-sortable="handle: .editor-section"></ul>
</div>

<!-- Modal: media edit -->
<div id="media-modal" uk-modal="">
<div class="uk-modal-dialog uk-modal-body uk-border-rounded">
<button class="uk-modal-close-default uk-border-rounded" type="button" uk-close=""></button>
<h3 class="uk-modal-title" id="media-modal-title">Add Media</h3>
<form id="media-form">
<input id="section-index" type="hidden" value=""/>

<!-- Media Options -->
<div class="uk-margin">
<label class="uk-form-label">From URL</label>
<input class="uk-input uk-border-rounded" id="media-url" placeholder="https://example.com/your-file" type="url"/>
</div>

<div class="uk-margin">
<label class="uk-form-label">Or Upload</label>
<input accept="" id="media-file" type="file"/>
<div class="uk-text-meta uk-margin-small-top" id="prev-file" style="display:none;">
File: <span id="prev-file-name"></span>
<label style="display:none;">
<input checked="" id="keep-prev-file" type="checkbox"/> Keep previous file
</label>
</div>
<div class="uk-margin" id="youtube-vimeo-options" style="display:none;">
<label class="uk-form-label">Or YouTube / Vimeo</label>
<div class="uk-text-meta uk-margin-small-bottom">Embed (no autoplay) or Background (muted autoplay)</div>

<div class="uk-flex uk-flex-wrap uk-grid-small" uk-grid>
  <div>
    <button type="button" class="uk-button uk-button-default uk-border-rounded" onclick="__pendingProviderVideo=null; promptYouTube()">
      <span uk-icon="icon: youtube; ratio: 1.2"></span> YouTube (Embed)
    </button>
  </div>
  <div>
    <button type="button" class="uk-button uk-button-default uk-border-rounded" onclick="__pendingProviderVideo=null; promptVimeo()">
      <span uk-icon="icon: vimeo; ratio: 1.2"></span> Vimeo (Embed)
    </button>
  </div>
  <div>
    <button type="button" class="uk-button uk-button-primary uk-border-rounded" onclick="promptYouTubeBg()">
      <span uk-icon="icon: plus-circle; ratio: 1.1"></span> YouTube (BG autoplay)
    </button>
  </div>
  <div>
    <button type="button" class="uk-button uk-button-primary uk-border-rounded" onclick="promptVimeoBg()">
      <span uk-icon="icon: plus-circle; ratio: 1.1"></span> Vimeo (BG autoplay)
    </button>
  </div>
</div>
</div>
</div>

<div class="uk-margin">
<label class="uk-form-label">Media Size &amp; Position</label>
<select class="uk-select uk-border-rounded" id="media-size">
<option value="full">Full Screen</option>
<option value="left">Left</option>
<option value="center">Center</option>
<option value="right">Right</option>
</select>
</div>

<h4 class="uk-heading-bullet">Add Background</h4>
<div class="uk-margin">
<label class="uk-form-label">Background Color</label>
<input id="bg-color" type="color" value="#000000"/>
</div>

<h4 class="uk-heading-bullet">Add Headline</h4>
<!-- Heading Options -->
<div class="uk-margin">
<label class="uk-form-label">Heading</label>
<input class="uk-input uk-border-rounded" id="media-heading" type="text" value="Your Headline"/>
</div>

<div class="uk-margin">
<label class="uk-form-label">Heading Size</label>
<select class="uk-select uk-border-rounded" id="heading-size">
<option value="uk-heading-large">Small</option>
<option value="uk-heading-xlarge">Medium</option>
<option selected="" value="uk-heading-2xlarge">Large</option>
</select>
</div>

<div class="uk-margin">
<label class="uk-form-label">Heading Color</label>
<input id="media-color" type="color" value="#ffffff"/>
</div>

<h4 class="uk-heading-bullet">Add Subtitle</h4>
<!-- Text Options -->
<div class="uk-margin">
<label class="uk-form-label">Subtitle</label>
<input class="uk-input uk-border-rounded" id="media-subtitle" placeholder="Your Subtitle" type="text"/>
</div>

<div class="uk-margin">
<label class="uk-form-label">Subtitle Size</label>
<select class="uk-select uk-border-rounded" id="subtitle-size">
<option value="uk-heading-medium">Small</option>
<option value="uk-heading-large">Medium</option>
<option value="uk-heading-xlarge">Large</option>
</select>
</div>

<div class="uk-margin">
<label class="uk-form-label">Subtitle Color</label>
<input id="subtitle-color" type="color" value="#ffffff"/>
</div>

<h4 class="uk-heading-bullet">Add Text</h4>
<div class="uk-margin">
<label class="uk-form-label">Paragraph</label>
<textarea class="uk-textarea uk-border-rounded" id="media-paragraph" placeholder="Type your text here..." rows="6"></textarea>
</div>

<div class="uk-margin" style="display:none;">
<label class="uk-form-label">Paragraph Size</label>
<select class="uk-select uk-border-rounded" id="paragraph-size">
<option value="large">Default</option>
</select>
</div>

<div class="uk-margin">
<label class="uk-form-label">Paragraph Color</label>
<input id="paragraph-color" type="color" value="#ffffff"/>
</div>

<h4 class="uk-heading-bullet">Add Button</h4>
<!-- Button Options -->
<div class="uk-margin">
<label class="uk-form-label">Button Label</label>
<input class="uk-input uk-border-rounded" id="btn-label" placeholder="Button Text" type="text"/>
</div>

<div class="uk-margin">
<label class="uk-form-label">Button URL</label>
<input class="uk-input uk-border-rounded" id="btn-url" placeholder="https://your-link.com" type="url"/>
</div>

<div class="uk-margin">
<label class="uk-form-label">Button Style</label>
<select class="uk-select uk-border-rounded" id="btn-color">
<option value="default">Default</option>
<option value="primary">Light</option>
<option value="secondary">Dark</option>
<option value="text">Text</option>
</select>
</div>

<button class="save uk-width-1-1 uk-margin-top uk-border-rounded" type="submit">Save</button>
</form>
</div>
</div>

<!-- Modal: embed -->
<div id="embed-modal" uk-modal="">
<div class="uk-modal-dialog uk-modal-body uk-border-rounded">
<button class="uk-modal-close-default uk-border-rounded" type="button" uk-close=""></button>
<h3 class="uk-modal-title" id="embed-modal-title">Add Embed Code</h3>
<form id="embed-form">
<input id="embed-index" type="hidden" value=""/>
<div class="uk-margin">
<label class="uk-form-label">Paste Code</label>
<textarea class="uk-textarea uk-border-rounded" id="embed-code" placeholder="Paste HTML, CSS, or JS here" rows="8"></textarea>
</div>
<h4 class="uk-heading-bullet">Add Background</h4>
<div class="uk-margin">
<label class="uk-form-label">Background Color</label>
<input id="embed-bgcolor" type="color" value="#000000" />
</div>
<button class="save uk-width-1-1 uk-margin-top uk-border-rounded" type="submit">Save</button>
</form>
</div>
</div>

<!-- Modal: YouTube -->
<div id="youtube-modal" uk-modal>
  <div class="uk-modal-dialog uk-modal-body uk-border-rounded">
    <button class="uk-modal-close-default uk-border-rounded" type="button" uk-close></button>
    <h3 class="uk-modal-title">Add YouTube URL</h3>
    <form id="youtube-form" onsubmit="(function(e){e.preventDefault(); const v=document.getElementById('youtube-input').value.trim(); if(v){mediaUrl.value=v;} UIkit.modal('#youtube-modal').hide();})(event)">
      <div class="uk-margin">
        <label class="uk-form-label">YouTube URL</label>
        <input id="youtube-input" class="uk-input uk-border-rounded" type="url" placeholder="https://www.youtube.com/watch?v=..." />
      </div>
      <div class="uk-text-right">
        <button class="uk-button uk-button-default uk-border-rounded uk-modal-close" type="button">Cancel</button>
        <button class="uk-button uk-button-primary uk-border-rounded" type="submit">Insert</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Vimeo -->
<div id="vimeo-modal" uk-modal>
  <div class="uk-modal-dialog uk-modal-body uk-border-rounded">
    <button class="uk-modal-close-default uk-border-rounded" type="button" uk-close></button>
    <h3 class="uk-modal-title">Add Vimeo URL</h3>
    <form id="vimeo-form" onsubmit="(function(e){e.preventDefault(); const v=document.getElementById('vimeo-input').value.trim(); if(v){mediaUrl.value=v;} UIkit.modal('#vimeo-modal').hide();})(event)">
      <div class="uk-margin">
        <label class="uk-form-label">Vimeo URL</label>
        <input id="vimeo-input" class="uk-input uk-border-rounded" type="url" placeholder="https://vimeo.com/..." />
      </div>
      <div class="uk-text-right">
        <button class="uk-button uk-button-default uk-border-rounded uk-modal-close" type="button">Cancel</button>
        <button class="uk-button uk-button-primary uk-border-rounded" type="submit">Insert</button>
      </div>
    </form>
  </div>
</div>

<!-- Save JSON Modal -->
<div id="save-json-modal" uk-modal>
  <div class="uk-modal-dialog uk-modal-body uk-border-rounded">
    <button class="uk-modal-close-default uk-border-rounded" type="button" uk-close></button>
    <h3 class="uk-modal-title">Save Website JSON</h3>
    <form id="save-json-form">
      <div class="uk-margin">
        <label class="uk-form-label" for="json-filename">File Name</label>
        <input id="json-filename" class="uk-input uk-border-rounded" type="text" placeholder="my-website.json" required>
      </div>
      <div class="uk-text-right">
        <button type="button" class="uk-button uk-button-default uk-border-rounded uk-modal-close">Cancel</button>
        <button type="submit" class="uk-button uk-button-primary uk-border-rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Export HTML -->
<div id="export-html-modal" uk-modal>
  <div class="uk-modal-dialog uk-modal-body uk-border-rounded">
    <button class="uk-modal-close-default" type="button" uk-close></button>
    <h3 class="uk-modal-title">Export Website HTML</h3>
    <input id="export-filename" class="uk-input uk-border-rounded" type="text" placeholder="homepage.zip">
    <div class="uk-text-right uk-margin-small-top">
      <button class="uk-button uk-button-default uk-border-rounded uk-modal-close">Cancel</button>
      <button id="export-confirm" class="uk-button uk-button-primary uk-border-rounded">Save</button>
    </div>
  </div>
</div>

<!-- Modal: Text -->
<div id="text-modal" uk-modal="">
<div class="uk-modal-dialog uk-modal-body uk-border-rounded">
<button class="uk-modal-close-default uk-border-rounded" type="button" uk-close=""></button>
<h3 class="uk-modal-title" id="text-modal-title">Add Text</h3>
<form id="text-form">
<input id="text-index" type="hidden" value=""/>
<h4 class="uk-heading-bullet">Title</h4>
<div class="uk-margin">
<label class="uk-form-label">Heading</label>
<input class="uk-input uk-border-rounded" id="text-heading" placeholder="Your Headline" type="text"/>
<select class="uk-select uk-border-rounded uk-margin-small-top" id="text-heading-size">
<option value="h-sm">Small</option>
<option value="h-md">Medium</option>
<option selected="" value="h-lg">Large</option>
</select>
</div>
<h4 class="uk-heading-bullet">Subtitle</h4>
<div class="uk-margin">
<label class="uk-form-label">Subheading</label>
<input class="uk-input uk-border-rounded" id="text-subtitle" placeholder="Your Subtitle" type="text"/>
<select class="uk-select uk-border-rounded uk-margin-small-top" id="text-subtitle-size">
<option value="sub-sm">Small</option>
<option selected="" value="sub-md">Medium</option>
<option value="sub-lg">Large</option>
</select>
</div>
<h4 class="uk-heading-bullet">Text</h4>
<div class="uk-margin">
<label class="uk-form-label">Paragraph</label>
<div class="toolbar uk-margin-small-bottom">
  <button class="uk-icon-button" onclick="formatText('bold')" type="button" uk-icon="bold" uk-tooltip="title:Bold Style; pos:bottom"></button>
  <button class="uk-icon-button" onclick="formatText('italic')" type="button" uk-icon="italic" uk-tooltip="title:Italic Style; pos:bottom"></button>

<div class="uk-inline">
  <button class="uk-icon-button" type="button" uk-icon="link" uk-tooltip="title:Add Link; pos:bottom"></button>

<div class="uk-card uk-card-body uk-card-default uk-border-rounded uk-width-large" 
     style="min-width: 400px;" uk-drop="mode: click; boundary: !body">
  <div class="uk-form-stacked">
    <label class="uk-form-label">Link URL</label>
    <div class="uk-form-controls uk-flex uk-flex-middle">
      <input id="link-input" class="uk-input uk-border-rounded uk-flex-1" type="url" placeholder="https://example.com">
      <button id="link-input-add-button" class="uk-button uk-button-primary uk-border-rounded uk-margin-small-left">Add</button>
    </div>
  </div>
</div>

<button class="uk-icon-button" onclick="removeLink()" type="button" uk-icon="ban" uk-tooltip="title:Remove Link; pos:bottom"></button>
</div>
<div class="uk-textarea uk-border-rounded" contenteditable="true" id="text-paragraph" style="min-height:120px;"></div>
<select class="uk-select uk-border-rounded uk-margin-small-top" id="text-paragraph-size">
<option value="p-sm">Small</option>
<option selected="" value="p-md">Medium</option>
<option value="p-lg">Large</option>
</select>
</div>
<h4 class="uk-heading-bullet">Change Alignment</h4>
<div class="uk-margin">
<label class="uk-form-label">Text Align</label><br>
<div id="text-align-group" class="uk-button-group">
<button type="button" class="uk-button uk-button-default align-option" data-align="left">Left</button>
<button type="button" class="uk-button uk-button-primary align-option" data-align="center">Center</button>
<button type="button" class="uk-button uk-button-default align-option" data-align="right">Right</button>
<button type="button" class="uk-button uk-button-default align-option" data-align="justify">Justify</button>
</div>
<input type="hidden" id="text-align" value="center"/>
</div>
<h4 class="uk-heading-bullet">Add Animation</h4>
<div class="uk-margin">
<label class="uk-form-label">Animation Style</label>
<select class="uk-select uk-border-rounded" id="text-animation">
<option value="uk-animation-fade">Fade</option>
<option value="uk-animation-slide-top">Slide Top</option>
<option value="uk-animation-slide-bottom">Slide Bottom</option>
<option value="uk-animation-slide-left">Slide Left</option>
<option value="uk-animation-slide-right">Slide Right</option>
</select>
</div>
<h4 class="uk-heading-bullet">Choose Colors</h4>
<div class="uk-margin">
<label class="uk-form-label">Background Color</label>
<input id="text-bgcolor" type="color" value="#ffffff"/>
</div>
<div class="uk-margin">
<label class="uk-form-label">Text Color</label>
<input id="text-color" type="color" value="#000000"/>
</div>
<button class="save uk-width-1-1 uk-border-rounded" type="submit">Save</button>
</form>
</div>
</div>

<!-- Modal: FAQ Builder -->
<div id="faq-modal" uk-modal="">
  <div class="uk-modal-dialog uk-modal-body uk-border-rounded">
    <button class="uk-modal-close-default uk-border-rounded" type="button" uk-close=""></button>
    <h3 class="uk-modal-title" id="faq-modal-title">Add FAQ</h3>

    <form id="faq-form">
      <input id="faq-index" type="hidden" value=""/>

      <div class="uk-margin">
        <label class="uk-form-label">Section Title</label>
        <input class="uk-input uk-border-rounded" id="faq-title" type="text" placeholder="Frequently Asked Questions"/>
      </div>

      <div class="uk-grid-small" uk-grid>
        <div class="uk-width-1-2@s">
          <label class="uk-form-label">Background Color</label>
          <input id="faq-bgcolor" type="color" value="#ffffff"/>
        </div>
        <div class="uk-width-1-2@s">
          <label class="uk-form-label">Text Color</label>
          <input id="faq-textcolor" type="color" value="#000000"/>
        </div>
      </div>

      <div class="uk-grid-small uk-margin" uk-grid>
        <div class="uk-width-1-2@s">
          <label class="switch-label" style="margin-top:0;">
            <span class="switch">
              <input type="checkbox" id="faq-multiple"/>
              <span class="slider"></span>
            </span>
            <span>Allow multiple open</span>
          </label>
        </div>
        <div class="uk-width-1-2@s">
          <label class="switch-label" style="margin-top:0;">
            <span class="switch">
              <input type="checkbox" id="faq-open-first" checked/>
              <span class="slider"></span>
            </span>
            <span>Open first item</span>
          </label>
        </div>
      </div>

      <div class="uk-flex uk-flex-between uk-flex-middle uk-margin">
        <div class="uk-button-group">
          <button class="uk-button uk-button-default uk-border-rounded" type="button" id="faq-sort-az">Sort A→Z</button>
          <button class="uk-button uk-button-default uk-border-rounded" type="button" id="faq-sort-za">Sort Z→A</button>
        </div>
        <button class="uk-button uk-button-primary uk-border-rounded" type="button" id="faq-add-item">
          <span uk-icon="plus"></span> Add Q&amp;A
        </button>
      </div>

      <div class="uk-margin">
        <div class="uk-text-meta">Drag items to reorder (grab the handle).</div>
        <ul id="faq-items" class="uk-list uk-sortable uk-margin-small-top" uk-sortable="handle: .faq-handle; animation: 150"></ul>
      </div>

      <button class="save uk-width-1-1 uk-border-rounded" type="submit">Save</button>
    </form>
  </div>
</div>

<!-- Modal: Slider Builder -->
<div id="slider-modal" uk-modal="">
  <div class="uk-modal-dialog uk-modal-body uk-border-rounded uk-width-1-1 uk-margin-auto">
    <button class="uk-modal-close-default uk-border-rounded" type="button" uk-close=""></button>
    <h3 class="uk-modal-title" id="slider-modal-title">Add Slideshow</h3>

    <form id="slider-form">
      <input id="slider-index" type="hidden" value=""/>

      <div class="uk-margin">
        <label class="uk-form-label">Section Title (optional)</label>
        <input class="uk-input uk-border-rounded" id="slider-title" type="text" placeholder="Featured"/>
      </div>

      <div class="uk-grid-small uk-margin" uk-grid>
          <label class="switch-label" style="margin-top:0;">
            <span class="switch">
              <input type="checkbox" id="slider-autoplay" checked/>
              <span class="slider"></span>
            </span>
            <span>Autoplay</span>
          </label>

          <label class="switch-label" style="margin-top:0;">
            <span class="switch">
              <input type="checkbox" id="slider-dots" checked/>
              <span class="slider"></span>
            </span>
            <span>Dots</span>
          </label>

          <label class="switch-label" style="margin-top:0;">
            <span class="switch">
              <input type="checkbox" id="slider-arrows" checked/>
              <span class="slider"></span>
            </span>
            <span>Arrows</span>
          </label>

          <label class="switch-label" style="margin-top:0;">
            <span class="switch">
              <input type="checkbox" id="slider-finite"/>
              <span class="slider"></span>
            </span>
            <span>Finite (no loop)</span>
          </label>       
      </div>

        <div class="uk-width-1-3@s uk-padding uk-padding-remove-top uk-padding-remove-left">
          <label class="uk-form-label">Autoplay interval (ms)</label>
          <input class="uk-input uk-border-rounded" id="slider-interval" type="number" min="1200" step="100" value="4000"/>
        </div>

      <div class="uk-grid-small" uk-grid>
        <div class="uk-width-1-2@s">
          <label class="uk-form-label">Background</label>
          <input id="slider-bgcolor" type="color" value="#000000"/>

          <label class="uk-margin-left uk-form-label">Text Color</label>
          <input id="slider-textcolor" type="color" value="#ffffff"/>
        </div>
      </div>

      <div class="uk-flex uk-flex-between uk-flex-middle uk-margin">
        <div class="uk-button-group">
          
          <button class="uk-button uk-button-default uk-border-rounded uk-margin-right" type="button" id="slider-sort-az">A→Z</button>
          <button class="uk-button uk-button-default uk-border-rounded" type="button" id="slider-sort-za">Z→A</button>
        </div>
        <button class="uk-button uk-button-primary uk-border-rounded" type="button" id="slider-add-item">
          <span uk-icon="plus"></span> Add Slide
        </button>
      </div>

      <div class="uk-margin">
        <ul id="slider-items" class="uk-list uk-sortable uk-margin-small-top" uk-sortable="handle: .slider-handle; animation: 150"></ul>
      </div>

      <button class="save uk-width-1-1 uk-border-rounded" type="submit">Save</button>
    </form>
  </div>
</div>


<!-- Modal: site settings -->
<div id="settings-modal" uk-modal="">
<div class="uk-modal-dialog uk-modal-body uk-border-rounded">
<button class="uk-modal-close-default uk-border-rounded" type="button" uk-close=""></button>
<h3 class="uk-modal-title">Site Settings</h3>
<form id="settings-form">
<h4 class="uk-heading-bullet">Search Engine Optimization</h4>
<div class="uk-margin">
<label class="uk-form-label">Site Language</label>
<select class="uk-select uk-border-rounded" id="site-language">
<option selected="" value="en">English</option>
<option value="ab">Abkhaz</option>
<option value="aa">Afar</option>
<option value="af">Afrikaans</option>
<option value="ak">Akan</option>
<option value="sq">Albanian</option>
<option value="am">Amharic</option>
<option value="ar">Arabic</option>
<option value="an">Aragonese</option>
<option value="hy">Armenian</option>
<option value="as">Assamese</option>
<option value="av">Avaric</option>
<option value="ae">Avestan</option>
<option value="ay">Aymara</option>
<option value="az">Azerbaijani</option>
<option value="bm">Bambara</option>
<option value="ba">Bashkir</option>
<option value="eu">Basque</option>
<option value="be">Belarusian</option>
<option value="bn">Bengali</option>
<option value="bh">Bihari</option>
<option value="bi">Bislama</option>
<option value="bs">Bosnian</option>
<option value="br">Breton</option>
<option value="bg">Bulgarian</option>
<option value="my">Burmese</option>
<option value="ca">Catalan</option>
<option value="ch">Chamorro</option>
<option value="ce">Chechen</option>
<option value="ny">Chichewa</option>
<option value="zh">Chinese</option>
<option value="cv">Chuvash</option>
<option value="kw">Cornish</option>
<option value="co">Corsican</option>
<option value="cr">Cree</option>
<option value="hr">Croatian</option>
<option value="cs">Czech</option>
<option value="da">Danish</option>
<option value="dv">Divehi</option>
<option value="nl">Dutch</option>
<option value="dz">Dzongkha</option>
<option value="en" selected>English</option>
<option value="eo">Esperanto</option>
<option value="et">Estonian</option>
<option value="ee">Ewe</option>
<option value="fo">Faroese</option>
<option value="fj">Fijian</option>
<option value="fi">Finnish</option>
<option value="fr">French</option>
<option value="ff">Fula</option>
<option value="gl">Galician</option>
<option value="ka">Georgian</option>
<option value="de">German</option>
<option value="el">Greek</option>
<option value="gn">Guaraní</option>
<option value="gu">Gujarati</option>
<option value="ht">Haitian</option>
<option value="ha">Hausa</option>
<option value="he">Hebrew</option>
<option value="hz">Herero</option>
<option value="hi">Hindi</option>
<option value="ho">Hiri Motu</option>
<option value="hu">Hungarian</option>
<option value="ia">Interlingua</option>
<option value="id">Indonesian</option>
<option value="ie">Interlingue</option>
<option value="ga">Irish</option>
<option value="ig">Igbo</option>
<option value="ik">Inupiaq</option>
<option value="io">Ido</option>
<option value="is">Icelandic</option>
<option value="it">Italian</option>
<option value="iu">Inuktitut</option>
<option value="ja">Japanese</option>
<option value="jv">Javanese</option>
<option value="kl">Kalaallisut</option>
<option value="kn">Kannada</option>
<option value="kr">Kanuri</option>
<option value="ks">Kashmiri</option>
<option value="kk">Kazakh</option>
<option value="km">Khmer</option>
<option value="ki">Kikuyu</option>
<option value="rw">Kinyarwanda</option>
<option value="ky">Kirghiz</option>
<option value="kv">Komi</option>
<option value="kg">Kongo</option>
<option value="ko">Korean</option>
<option value="ku">Kurdish</option>
<option value="kj">Kwanyama</option>
<option value="la">Latin</option>
<option value="lb">Luxembourgish</option>
<option value="lg">Ganda</option>
<option value="li">Limburgish</option>
<option value="ln">Lingala</option>
<option value="lo">Lao</option>
<option value="lt">Lithuanian</option>
<option value="lu">Luba-Katanga</option>
<option value="lv">Latvian</option>
<option value="gv">Manx</option>
<option value="mk">Macedonian</option>
<option value="mg">Malagasy</option>
<option value="ms">Malay</option>
<option value="ml">Malayalam</option>
<option value="mt">Maltese</option>
<option value="mi">Māori</option>
<option value="mr">Marathi</option>
<option value="mh">Marshallese</option>
<option value="mn">Mongolian</option>
<option value="na">Nauru</option>
<option value="nv">Navajo</option>
<option value="nd">North Ndebele</option>
<option value="nr">South Ndebele</option>
<option value="ng">Ndonga</option>
<option value="ne">Nepali</option>
<option value="no">Norwegian</option>
<option value="nb">Norwegian Bokmål</option>
<option value="nn">Norwegian Nynorsk</option>
<option value="ii">Sichuan Yi</option>
<option value="oc">Occitan</option>
<option value="oj">Ojibwe</option>
<option value="cu">Church Slavic</option>
<option value="om">Oromo</option>
<option value="or">Oriya</option>
<option value="os">Ossetian</option>
<option value="pa">Panjabi</option>
<option value="pi">Pāli</option>
<option value="fa">Persian</option>
<option value="pl">Polish</option>
<option value="ps">Pashto</option>
<option value="pt">Portuguese</option>
<option value="qu">Quechua</option>
<option value="rm">Romansh</option>
<option value="rn">Kirundi</option>
<option value="ro">Romanian</option>
<option value="ru">Russian</option>
<option value="sa">Sanskrit</option>
<option value="sc">Sardinian</option>
<option value="sd">Sindhi</option>
<option value="se">Northern Sami</option>
<option value="sm">Samoan</option>
<option value="sg">Sango</option>
<option value="sr">Serbian</option>
<option value="gd">Scottish Gaelic</option>
<option value="sn">Shona</option>
<option value="si">Sinhala</option>
<option value="sk">Slovak</option>
<option value="sl">Slovene</option>
<option value="so">Somali</option>
<option value="st">Southern Sotho</option>
<option value="es">Spanish</option>
<option value="su">Sundanese</option>
<option value="sw">Swahili</option>
<option value="ss">Swati</option>
<option value="sv">Swedish</option>
<option value="ta">Tamil</option>
<option value="te">Telugu</option>
<option value="tg">Tajik</option>
<option value="th">Thai</option>
<option value="ti">Tigrinya</option>
<option value="bo">Tibetan</option>
<option value="tk">Turkmen</option>
<option value="tl">Tagalog</option>
<option value="tn">Tswana</option>
<option value="to">Tonga</option>
<option value="tr">Turkish</option>
<option value="ts">Tsonga</option>
<option value="tt">Tatar</option>
<option value="tw">Twi</option>
<option value="ty">Tahitian</option>
<option value="ug">Uighur</option>
<option value="uk">Ukrainian</option>
<option value="ur">Urdu</option>
<option value="uz">Uzbek</option>
<option value="ve">Venda</option>
<option value="vi">Vietnamese</option>
<option value="vo">Volapük</option>
<option value="wa">Walloon</option>
<option value="cy">Welsh</option>
<option value="wo">Wolof</option>
<option value="xh">Xhosa</option>
<option value="yi">Yiddish</option>
<option value="yo">Yoruba</option>
<option value="za">Zhuang</option>
<option value="zu">Zulu</option>
<!-- (list trimmed for brevity, keep your full list if needed) -->
</select>
</div>
<div class="uk-margin">
<label class="uk-form-label">Title</label>
<input class="uk-input uk-border-rounded" id="site-title" placeholder="Your Website Title" type="text"/>
</div>
<div class="uk-margin">
<label class="uk-form-label">Description</label>
<textarea class="uk-textarea uk-border-rounded" id="site-description" placeholder="Short description or slogan for Search Engines" rows="2"></textarea>
</div>
<div class="uk-margin">
<label class="uk-form-label">Author</label>
<input class="uk-input uk-border-rounded" id="site-author" placeholder="Your Name or Company" type="text"/>
</div>
<div class="uk-margin">
<label class="uk-form-label">Robots</label>
<select class="uk-select uk-border-rounded" id="site-robots">
<option value="index, follow">Index, Follow</option>
<option value="noindex, nofollow">NoIndex, NoFollow</option>
</select>
</div>
<h4 class="uk-heading-bullet"> Favicon </h4>
<div class="uk-margin">
<label class="uk-form-label">Favicon URL</label>
<input class="uk-input uk-border-rounded" id="site-favicon" placeholder="https://example.com/favicon.png" type="url"/>
<div class="uk-margin-small-top">
<label class="uk-form-label">Or Upload Favicon</label>
<input accept="image/x-icon,image/png,image/svg+xml,image/jpeg,image/jpg,image/webp" id="site-favicon-file" type="file"/>
<div class="uk-margin-small-top" id="site-favicon-preview" style="max-height:40px;"></div>
</div>
</div>
<h4 class="uk-heading-bullet">Open Graph Images</h4>
<div class="uk-margin">
<label class="uk-form-label">Social Preview Image URL</label>
<input class="uk-input uk-border-rounded" id="site-social" placeholder="https://example.com/social.png" type="url"/>
<div class="uk-margin-small-top">
<label class="uk-form-label">Or Upload Social Image</label>
<input accept="image/*" id="site-social-file" type="file"/>
<div class="uk-margin-small-top" id="site-social-preview" style="max-height:80px;"></div>
</div>
</div>
<h4 class="uk-heading-bullet">Custom Font</h4>
<div class="uk-margin">
<!-- Text input -->
<label class="uk-form-label">Insert Google Font name</label>
<input class="uk-input uk-border-rounded" id="site-font-name" placeholder="e.g. Orbitron" type="text"/>

<label class="uk-form-label">&nbsp;</label>

<!-- Radio buttons -->
<div class="uk-form-controls">
<label class="radio-wrapper">
<input class="uk-radio" type="radio" name="font-target" value="all" id="apply-to-all">
<span class="radio-custom"></span>
All (Text + Headings)
</label><br>

<label class="radio-wrapper">
<input class="uk-radio" type="radio" name="font-target" value="body" id="apply-to-body">
<span class="radio-custom"></span>
Text
</label><br>

<label class="radio-wrapper">
<input class="uk-radio" type="radio" name="font-target" value="headings" id="apply-to-headings">
<span class="radio-custom"></span>
Headings
</label><br>

<label class="radio-wrapper">
<input class="uk-radio" type="radio" name="font-target" value="none" id="apply-to-none" checked>
<span class="radio-custom"></span>
None
</label>
</div>
</div>

<h4 class="uk-heading-bullet">Structured Data and Rich Snippets</h4>
<div class="uk-margin">
<label class="uk-form-label">Add custom Schema.org JSON code</label>
<textarea class="uk-textarea uk-border-rounded" id="site-head-script" placeholder='&lt;script type="application/ld+json"&gt;...&lt;/script&gt;' rows="4"></textarea>
</div>
<h4 class="uk-heading-bullet">Custom Style and Design</h4>
<div class="uk-margin">
<label class="uk-form-label">Custom CSS</label><textarea class="uk-textarea uk-border-rounded" id="site-custom-css" placeholder="Write custom CSS here..." rows="6"></textarea></div><div class="uk-margin">
</div>

<button class="save uk-width-1-1 uk-margin-top uk-border-rounded" type="submit">Save</button>

</form>
</div>
</div>
<!-- UIKit modal for delete warning -->
<div id="delete-modal" uk-modal="">
<div class="uk-modal-dialog uk-modal-body uk-border-rounded">
<h2 class="uk-modal-title">Really delete item?</h2>
<p>This action cannot be undone.</p>
<p class="uk-text-right">
<button class="uk-button uk-button-default uk-modal-close uk-border-rounded" type="button">Cancel</button>
<button class="uk-button uk-button-danger uk-border-rounded" id="confirm-delete" type="button">Delete</button>
</p>
</div>
</div>
<!-- Footer Settings Modal -->
<div id="footer-modal" uk-modal="">
<div class="uk-modal-dialog uk-modal-body uk-border-rounded">
<button class="uk-modal-close-default uk-border-rounded" type="button" uk-close=""></button>
<h3 class="uk-modal-title">Footer Settings</h3>
<form id="footer-form">
<div class="uk-margin">
<label class="switch-label">
<span class="switch">
<input type="checkbox" id="enable-footer">
<span class="slider"></span>
</span>
<span>Enable Footer</span>
</label>
</div>
<h4 class="uk-heading-bullet">Choose Colors</h4>
<div class="uk-margin">
<label class="uk-form-label">Background Color</label>
<input id="footer-bg" type="color" value="#000000"/>
</div>
<div class="uk-margin">
<label class="uk-form-label">Text Color</label>
<input id="footer-text" type="color" value="#ffffff"/>
</div>
<h4 class="uk-heading-bullet">Add Contact</h4>
<div class="uk-margin">
<label class="uk-form-label">Phone</label>
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="receiver"></span>
<input class="uk-input uk-border-rounded" id="footer-phone" placeholder="+1 (555) 123-4567" type="tel"/>
</div>
</div>
<div class="uk-margin">
<label class="uk-form-label">Email</label>
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="mail"></span>
<input class="uk-input uk-border-rounded" id="footer-email" placeholder="you@example.com" type="email"/>
</div>
</div>
<div class="uk-margin">
<label class="uk-form-label">Address</label>
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="location"></span>
<input class="uk-input uk-border-rounded" id="footer-address" placeholder="123 Main St, City, Country" type="text"/>
</div>
<h4 class="uk-heading-bullet">Add Website Links (URL)</h4>
<div class="uk-grid-small" uk-grid="">
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="info"></span>
<input class="uk-input uk-border-rounded" id="footer-info" placeholder="About" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="comments"></span>
<input class="uk-input uk-border-rounded" id="footer-comments" placeholder="Community" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="mail"></span>
<input class="uk-input uk-border-rounded" id="footer-mail" placeholder="Contact" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="heart"></span>
<input class="uk-input uk-border-rounded" id="footer-heart" placeholder="Donate" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="calendar"></span>
<input class="uk-input uk-border-rounded" id="footer-calendar" placeholder="Events" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="question"></span>
<input class="uk-input uk-border-rounded" id="footer-question" placeholder="FAQ" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="rss"></span>
<input class="uk-input uk-border-rounded" id="footer-rss" placeholder="Feed" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="star"></span>
<input class="uk-input uk-border-rounded" id="footer-star" placeholder="Jobs" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="bell"></span>
<input class="uk-input uk-border-rounded" id="footer-bell" placeholder="News" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="users"></span>
<input class="uk-input uk-border-rounded" id="footer-users" placeholder="Organization" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="social"></span>
<input class="uk-input uk-border-rounded" id="footer-social" placeholder="Press" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="lock"></span>
<input class="uk-input uk-border-rounded" id="footer-lock" placeholder="Privacy" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="cart"></span>
<input class="uk-input uk-border-rounded" id="footer-cart" placeholder="Shop" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="hashtag"></span>
<input class="uk-input uk-border-rounded" id="footer-hashtag" placeholder="Sitemap" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="warning"></span>
<input class="uk-input uk-border-rounded" id="footer-warning" placeholder="Status" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="tag"></span>
<input class="uk-input uk-border-rounded" id="footer-tag" placeholder="Tags" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="menu"></span>
<input class="uk-input uk-border-rounded" id="footer-menu" placeholder="Terms" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="user"></span>
<input class="uk-input uk-border-rounded" id="footer-user" placeholder="User" type="url"/>
</div>
</div>
</div>
<h4 class="uk-heading-bullet">Add Social Links (URL)</h4>
<div class="uk-grid-small" uk-grid="">
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="android-robot"></span>
<input class="uk-input uk-border-rounded" id="footer-android-robot" placeholder="Android" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="apple"></span>
<input class="uk-input uk-border-rounded" id="footer-apple" placeholder="Apple" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="behance"></span>
<input class="uk-input uk-border-rounded" id="footer-behance" placeholder="Behance" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="discord"></span>
<input class="uk-input uk-border-rounded" id="footer-discord" placeholder="Discord" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="dribbble"></span>
<input class="uk-input uk-border-rounded" id="footer-dribbble" placeholder="Dribbble" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="etsy"></span>
<input class="uk-input uk-border-rounded" id="footer-etsy" placeholder="Etsy" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="facebook"></span>
<input class="uk-input uk-border-rounded" id="footer-facebook" placeholder="Facebook" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="flickr"></span>
<input class="uk-input uk-border-rounded" id="footer-flickr" placeholder="Flickr" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="foursquare"></span>
<input class="uk-input uk-border-rounded" id="footer-foursquare" placeholder="Foursquare" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="github"></span>
<input class="uk-input uk-border-rounded" id="footer-github" placeholder="GitHub" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="google"></span>
<input class="uk-input uk-border-rounded" id="footer-google" placeholder="Google" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="instagram"></span>
<input class="uk-input uk-border-rounded" id="footer-instagram" placeholder="Instagram" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="joomla"></span>
<input class="uk-input uk-border-rounded" id="footer-joomla" placeholder="Joomla" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="linkedin"></span>
<input class="uk-input uk-border-rounded" id="footer-linkedin" placeholder="LinkedIn" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="mastodon"></span>
<input class="uk-input uk-border-rounded" id="footer-mastodon" placeholder="Mastodon" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="microsoft"></span>
<input class="uk-input uk-border-rounded" id="footer-microsoft" placeholder="Microsoft" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="pinterest"></span>
<input class="uk-input uk-border-rounded" id="footer-pinterest" placeholder="Pinterest" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="reddit"></span>
<input class="uk-input uk-border-rounded" id="footer-reddit" placeholder="Reddit" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="bag"></span>
<input class="uk-input uk-border-rounded" id="footer-bag" placeholder="Shopify" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="signal"></span>
<input class="uk-input uk-border-rounded" id="footer-signal" placeholder="Signal" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="soundcloud"></span>
<input class="uk-input uk-border-rounded" id="footer-soundcloud" placeholder="SoundCloud" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="telegram"></span>
<input class="uk-input uk-border-rounded" id="footer-telegram" placeholder="Telegram" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="threads"></span>
<input class="uk-input uk-border-rounded" id="footer-threads" placeholder="Threads" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="tiktok"></span>
<input class="uk-input uk-border-rounded" id="footer-tiktok" placeholder="TikTok" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="tripadvisor"></span>
<input class="uk-input uk-border-rounded" id="footer-tripadvisor" placeholder="Tripadvisor" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="tumblr"></span>
<input class="uk-input uk-border-rounded" id="footer-tumblr" placeholder="Tumblr" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="twitch"></span>
<input class="uk-input uk-border-rounded" id="footer-twitch" placeholder="Twitch" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="vimeo"></span>
<input class="uk-input uk-border-rounded" id="footer-vimeo" placeholder="Vimeo" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="whatsapp"></span>
<input class="uk-input uk-border-rounded" id="footer-whatsapp" placeholder="WhatsApp" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="wordpress"></span>
<input class="uk-input uk-border-rounded" id="footer-wordpress" placeholder="WordPress" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="x"></span>
<input class="uk-input uk-border-rounded" id="footer-x" placeholder="X (Twitter)" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="xing"></span>
<input class="uk-input uk-border-rounded" id="footer-xing" placeholder="Xing" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="yelp"></span>
<input class="uk-input uk-border-rounded" id="footer-yelp" placeholder="Yelp" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="youtube"></span>
<input class="uk-input uk-border-rounded" id="footer-youtube" placeholder="YouTube" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="link"></span>
<input class="uk-input uk-border-rounded" id="footer-link" placeholder="Custom URL" type="url"/>
</div>
</div>
<div class="uk-width-1-2">
<div class="uk-inline uk-width-1-1">
<span class="uk-form-icon" uk-icon="link-external"></span>
<input class="uk-input uk-border-rounded" id="footer-link-external" placeholder="Website URL" type="url"/>
</div>
</div>
</div>
</div>
<button class="save uk-width-1-1 uk-border-rounded" type="submit">Save</button>
</form>
</div>
</div>
<!-- Dynamic Nav Bar Settings Modal -->
<div id="navbar-modal" uk-modal="">
<div class="uk-modal-dialog uk-modal-body uk-border-rounded">
<button class="uk-modal-close-default uk-border-rounded" type="button" uk-close=""></button>
<h3 class="uk-modal-title">Dynamic Nav Bar Settings</h3>
<form id="navbar-form">
<div class="uk-margin">
<label class="switch-label">
<span class="switch">
<input type="checkbox" id="enable-navbar">
<span class="slider"></span>
</span>
<span>Enable Dynamic Nav Bar</span>
</label>
</div>
<h4 class="uk-heading-bullet">Add Logo (optional)</h4>
<div class="uk-margin">
<label class="uk-form-label">Logo From URL</label>
<input class="uk-input uk-border-rounded" id="navbar-logo-url" placeholder="https://example.com/logo.png" type="url"/>
<div class="uk-margin-small-top" id="navbar-logo-url-preview" style="max-height:50px;"></div>
</div>
<div class="uk-margin">
<label class="uk-form-label">Or Upload Logo</label>
<input accept="image/*" id="navbar-logo" type="file"/>
<div class="uk-margin-small-top" id="navbar-logo-preview" style="max-height:50px;"></div>

<button id="navbar-logo-remove"
          class="uk-button uk-button-danger uk-button-small uk-margin-small-top uk-border-rounded"
          type="button"
          style="display:none;">
    Remove logo
</button>

</div>
<h4 class="uk-heading-bullet">Choose Colors</h4>
<div class="uk-margin">
<div class="uk-margin"><label class="uk-form-label">Background Color </label><input id="navbar-bg" type="color" value="#ffffff"/></div>
<div class="uk-margin"><label class="uk-form-label">Text Color </label><input id="navbar-text" type="color" value="#000000"/></div>
</div>

<div class="uk-margin">
  <label class="switch-label">
    <span class="switch">
      <input type="checkbox" id="navbar-auto-headings" checked>
      <span class="slider"></span>
    </span>
    <span>Auto insert section headings</span>
  </label>
  <div class="uk-text-meta">When disabled, the nav bar will show only your custom links.</div>
</div>

<div class="uk-margin">
  <div class="uk-flex uk-flex-between uk-flex-middle">
    <div>
      <div class="uk-form-label" style="margin:0;">Custom Links</div>
      <div class="uk-text-meta"><span id="navbar-custom-links-count">0</span> link(s)</div>
    </div>
    <button class="uk-button uk-button-secondary uk-border-rounded" type="button" id="navbar-custom-links-btn">
      Manage Links
    </button>
  </div>
</div>

<button class="save uk-width-1-1 uk-border-rounded" type="submit">Save</button>
</form>
</div>
</div>

<!-- Custom Links Modal (Dynamic Nav Bar) -->
<div id="navbar-links-modal" uk-modal="">
  <div class="uk-modal-dialog uk-modal-body uk-border-rounded uk-width-1-1 uk-margin-auto">
    <button class="uk-modal-close-default uk-border-rounded" type="button" uk-close=""></button>
    <h3 class="uk-modal-title">Dynamic Nav Bar — Custom Links</h3>

    <div class="uk-card uk-card-default uk-card-body uk-border-rounded uk-margin">
      <div class="uk-grid-small uk-flex-middle" uk-grid>
        <div class="uk-width-auto@s">
          <label class="uk-form-label">Use global JSON</label>
          <label class="switch-label" style="margin-top:6px;">
            <span class="switch">
              <input type="checkbox" id="navbar-links-use-global">
              <span class="slider"></span>
            </span>
          </label>
        </div>
        <div class="uk-width-expand@s">
          <label class="uk-form-label">Global JSON URL / path</label>
          <input class="uk-input uk-border-rounded" id="navbar-links-global-url" placeholder="https://example.com/navlinks.json">
          <div class="uk-text-meta uk-margin-small-top">Expected format: an array of links, or {"links":[...]}. Link fields: title/url/newTab (label/href also supported).</div>
        </div>
        <div class="uk-width-auto@s uk-flex uk-flex-middle">
          <button class="uk-button uk-button-default uk-border-rounded" type="button" id="navbar-links-refresh" uk-icon="refresh" title="Refresh"></button>
          <span id="navbar-links-status" class="uk-label uk-border-rounded uk-margin-small-left" uk-tooltip="pos: bottom">Disabled</span>
        </div>
      </div>
    </div>

    <input type="file" id="navbar-links-json-file" accept="application/json" hidden>

    <div class="uk-flex uk-flex-between uk-flex-middle uk-margin">
      <div class="uk-button-group">
        <button class="uk-button uk-button-default uk-border-rounded" type="button" id="navbar-links-sort-az">Sort A→Z</button>
        <button class="uk-button uk-button-default uk-border-rounded" type="button" id="navbar-links-sort-za">Sort Z→A</button>
      </div>
      <div class="uk-button-group">
        <button class="uk-button uk-button-default uk-border-rounded" type="button" id="navbar-links-import-json">Import JSON</button>
        <button class="uk-button uk-button-default uk-border-rounded" type="button" id="navbar-links-export-json">Export JSON</button>
        <button class="uk-button uk-button-primary uk-border-rounded" type="button" id="navbar-links-add">+ Add link</button>
      </div>
    </div>

    <ul id="navbar-links-list" class="uk-list uk-list-divider" uk-sortable="handle: .navbar-links-handle"></ul>

    <button class="save uk-width-1-1 uk-border-rounded" type="button" id="navbar-links-save">Save Links</button>
  </div>
</div>

<!-- JSZip for export -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/js/uikit.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/js/uikit-icons.min.js"></script>
<script>
function applyFontLink() {
if (siteSettings.fontName) {
const urlName = siteSettings.fontName.trim().replace(/ /g, '+');
const fontUrl = `https://fonts.googleapis.com/css2?family=${urlName}&display=swap`;
let link = document.getElementById("custom-font-link");
if (!link) {
link = document.createElement("link");
link.id = "custom-font-link";
link.rel = "stylesheet";
document.head.appendChild(link);
}
link.href = fontUrl;
}
}

function getFontNameFromUrl(url) {
if (!url) return '';
const match = url.match(/family=([^:&]+)/);
if (match && match[1]) {
return match[1].replace(/\+/g, ' ').split(':')[0];
}
return '';
}

function generateFontCSS() {
let css = "";
if (siteSettings.fontName) {
switch (siteSettings.fontTarget) {
case 'all':
css += `body, h1, h2, h3, h4, h5, h6, .live-heading { font-family: '${siteSettings.fontName}', sans-serif; }\n`;
break;
case 'body':
css += `body { font-family: '${siteSettings.fontName}', sans-serif; }\n`;
break;
case 'headings':
css += `h1, h2, h3, h4, h5, h6, .live-heading { font-family: '${siteSettings.fontName}', sans-serif; }\n`;
break;
case 'none':
default:
// no font applied
break;
}
}
return css;
}

// Sticky nav color swap (no repaint thrash on modal open)
UIkit.util.on(document, 'DOMContentLoaded', function () {
var stickyNav = document.getElementById('main-navbar');
UIkit.util.on('#main-navbar', 'active',   () => stickyNav.classList.add('sticky-colored'));
UIkit.util.on('#main-navbar', 'inactive', () => stickyNav.classList.remove('sticky-colored'));
});

// Editor logic
const editorRoot = document.getElementById('live-editor-root');
const addImageBtn = document.getElementById('addImageBtn');
const addVideoBtn = document.getElementById('addVideoBtn');
const mediaModal = UIkit.modal('#media-modal');
const mediaForm = document.getElementById('media-form');
const mediaUrl = document.getElementById('media-url');
const mediaFile = document.getElementById('media-file');
const prevFile = document.getElementById('prev-file');
const prevFileName = document.getElementById('prev-file-name');
const keepPrevFile = document.getElementById('keep-prev-file');
const mediaHeading = document.getElementById('media-heading');
const headingSize = document.getElementById('heading-size');
const mediaColor = document.getElementById('media-color');
const mediaModalTitle = document.getElementById('media-modal-title');
const mediaSize = document.getElementById('media-size');
const bgColor = document.getElementById('bg-color');
const btnLabel = document.getElementById('btn-label');
const btnUrl = document.getElementById('btn-url');
const btnColor = document.getElementById('btn-color');
const sectionIndex = document.getElementById('section-index');
const embedCodeBtn = document.getElementById('embedCodeBtn');
const embedModal = UIkit.modal('#embed-modal');
const embedForm = document.getElementById('embed-form');
const embedCode = document.getElementById('embed-code');
const embedIndex = document.getElementById('embed-index');

// Dynamically ensure gallery cards animate only once
const observer = new MutationObserver(mutations => {
  mutations.forEach(m => {
    m.addedNodes.forEach(node => {
      if (node.nodeType === 1) {
        // check if new gallery cards exist
        node.querySelectorAll && node.querySelectorAll('#gm-gallery .uk-card').forEach(card => {
          if (!card.hasAttribute('uk-scrollspy')) {
            card.setAttribute('uk-scrollspy', 'cls: uk-animation-scale-up; repeat: false');
          }
        });
      }
    });
  });
});

observer.observe(editorRoot, { childList: true, subtree: true });

// Text modal setup
const addTextBtn = document.getElementById('addTextBtn');
const textModal = UIkit.modal('#text-modal');
const textForm = document.getElementById('text-form');
const textHeading = document.getElementById('text-heading');
const textSubtitle = document.getElementById('text-subtitle');
const textParagraph = document.getElementById('text-paragraph'); // now a contenteditable div

textParagraph.addEventListener('keydown', (e) => {
  const align = (textAlignInput && textAlignInput.value) || textParagraph.style.textAlign || 'left';
  // ensure container aligned (so last inline line centers)
  textParagraph.style.textAlign = align;

  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();

    const sel = window.getSelection();
    if (!sel || !sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    range.deleteContents();

    // insert <br>
    const br = document.createElement('br');
    range.insertNode(br);

    // insert zero-width space as a caret anchor
    const after = document.createTextNode('\u200B'); // zero-width
    br.parentNode.insertBefore(after, br.nextSibling);

    // place caret AFTER the zero-width node (important!)
    const newRange = document.createRange();
    // option A: setStartAfter
    newRange.setStartAfter(after);
    newRange.collapse(true);

    sel.removeAllRanges();
    sel.addRange(newRange);

    // ensure child blocks inherit alignment
    textParagraph.querySelectorAll('div, p').forEach(el => el.style.textAlign = align);

    return;
  }

  if (e.key === 'Enter') {
    setTimeout(() => {
      textParagraph.style.textAlign = align;
      textParagraph.querySelectorAll('div, p').forEach(el => el.style.textAlign = align);
    }, 0);
  }
});

// cleanup: remove stray zero-width-only text nodes when user types/backspaces so you don't accumulate them
textParagraph.addEventListener('input', () => {
  // remove zero-width-only text nodes that are redundant
  const walker = document.createTreeWalker(textParagraph, NodeFilter.SHOW_TEXT, null, false);
  const nodesToRemove = [];
  while (walker.nextNode()) {
    const node = walker.currentNode;
    // if node is only zero-width characters, and it's not the only thing keeping the caret position, remove it
    if (/^\u200B+$/.test(node.nodeValue)) {
      nodesToRemove.push(node);
    }
  }
  nodesToRemove.forEach(n => {
    // only remove if parent has other content or the node isn't the only thing (preserve an empty line logic if you need it)
    if (n.parentNode) n.parentNode.removeChild(n);
  });
});

textParagraph.addEventListener('paste', (e) => {
  e.preventDefault();

  // Get plain text from clipboard
  const text = (e.clipboardData || window.clipboardData).getData('text/plain');
  if (!text) return;

  // Escape any HTML characters to prevent formatting
  const safeText = text.replace(/[<>&]/g, (c) => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;' }[c]));

  // Insert plain text at the caret (without converting newlines to <br>)
  document.execCommand('insertHTML', false, safeText);
});

const textAnimation = document.getElementById('text-animation');
const textIndex = document.getElementById('text-index');
const textBgColor = document.getElementById('text-bgcolor');
const textColor   = document.getElementById('text-color');
const textHeadingSize  = document.getElementById('text-heading-size');
const textSubtitleSize = document.getElementById('text-subtitle-size');
const textParagraphSize = document.getElementById('text-paragraph-size');
const textAlignInput = document.getElementById('text-align');
const textAlignGroup = document.getElementById('text-align-group');

addTextBtn.addEventListener('click', () => {
textHeading.value = '';
textSubtitle.value = '';
textParagraph.innerHTML = '';
textAnimation.value = 'uk-animation-fade';
textAlignInput.value = 'center';
// ensure the hidden input is set first (if code sets it earlier); use its value for active button
const _currentAlign = (textAlignInput && textAlignInput.value) ? textAlignInput.value : 'center';
Array.from(textAlignGroup.querySelectorAll('.align-option')).forEach(b =>
  b.classList.toggle('uk-button-primary', b.dataset.align === _currentAlign));
if (typeof textHeadingSize !== 'undefined')  textHeadingSize.value  = 'h-lg';
if (typeof textSubtitleSize !== 'undefined') textSubtitleSize.value = 'sub-md';
if (typeof textParagraphSize !== 'undefined') textParagraphSize.value = 'p-md';
if (typeof textBgColor !== 'undefined') textBgColor.value = '#ffffff';
if (typeof textColor !== 'undefined')   textColor.value   = '#000000';
textIndex.value = '';

const textTitleEl = document.getElementById('text-modal-title');
if (textTitleEl) textTitleEl.textContent = 'Add Text';

applyLastColorsToContainer('#text-modal');
textModal.show();
});

// Helper: Scroll to a section by index
function scrollToSection(idx) {
  const editorRoot = document.getElementById('live-editor-root');
  const i = parseInt(idx, 10);
  if (isNaN(i)) return;
  const sectionEl = editorRoot.children[i];
  if (sectionEl) {
    // ensure any UIkit/layout changes have settled
    sectionEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

textForm.addEventListener('submit', e => {
  e.preventDefault();

  let block = {
    id: 'sec-' + Math.random().toString(36).substr(2, 9),
    type: 'text',
    heading: textHeading.value,
    subtitle: textSubtitle.value,
    paragraph: textParagraph.innerHTML,
    align: textAlignInput.value || 'center',
    animation: textAnimation.value,
    bgColor: textBgColor.value || '#ffffff',
    textColor: textColor.value || '#000000',
    headingSize: textHeadingSize.value,
    subtitleSize: textSubtitleSize.value,
    paragraphSize: textParagraphSize.value
  };

  // --- determine numeric idx (update existing or append new) ---
  let idx = null;
  if (textIndex && textIndex.value !== '') {
    idx = parseInt(textIndex.value, 10);
  }
  if (idx !== null && !isNaN(idx)) {
    allSections[idx] = block;
  } else {
    allSections.push(block);
    idx = allSections.length - 1;
  }

  // render + apply styles
  renderAllSections();
  applyFontLink();
  applyCustomCSS();

  // hide modal first so UIkit overlay doesn't block page scrolling
  textModal.hide();

  // delay scroll a tick so DOM/CSS state settles after modal close
  setTimeout(() => {
    if (!Number.isNaN(idx) && document.getElementById('live-editor-root')?.children[idx]) {
      scrollToSection(idx);
    } else {
      const root = document.getElementById('live-editor-root');
      if (root && root.children.length) scrollToSection(root.children.length - 1);
    }
  }, 50);
});

textAlignGroup.addEventListener('click', (e) => {
const btn = e.target.closest('.align-option');
if (!btn) return;
// set value
textAlignInput.value = btn.dataset.align;
// visual active state
Array.from(textAlignGroup.querySelectorAll('.align-option'))
.forEach(b => b.classList.toggle('uk-button-primary', b === btn));
});


// Fields for subtitle/paragraph
const mediaSubtitle = document.getElementById('media-subtitle');
const subtitleSize = document.getElementById('subtitle-size');
const subtitleColor = document.getElementById('subtitle-color');
const mediaParagraph = document.getElementById('media-paragraph');
const paragraphSize = document.getElementById('paragraph-size');
const paragraphColor = document.getElementById('paragraph-color');

// JSON/HTML
const saveJSONBtn = document.getElementById('saveJSON');
const loadJSONBtn = document.getElementById('loadJSON');
const exportHTMLBtn = document.getElementById('exportHTML');
const jsonFileInput = document.getElementById('jsonFileInput');
const deleteModal = UIkit.modal('#delete-modal');
const confirmDeleteBtn = document.getElementById('confirm-delete');

confirmDeleteBtn.addEventListener('click', () => {
if (toDeleteIndex !== null) {
// remove the section from the array
allSections.splice(toDeleteIndex, 1);
toDeleteIndex = null;

// re-render + re-apply site styles
renderAllSections();
applyFontLink();
applyCustomCSS();

// close the modal
deleteModal.hide();
}
});

UIkit.util.on('#delete-modal', 'hidden', () => { toDeleteIndex = null; });

// NEW: Dynamic Nav Bar controls
const navBarBtn = document.getElementById('navBarBtn');
const navbarModal = UIkit.modal('#navbar-modal');
const navbarForm = document.getElementById('navbar-form');
const enableNavbar = document.getElementById('enable-navbar');
const navbarBg = document.getElementById('navbar-bg');
const navbarText = document.getElementById('navbar-text');
const navbarAutoHeadings = document.getElementById('navbar-auto-headings');
const navbarLogoUrl = document.getElementById('navbar-logo-url');
const navbarLogoUrlPreview = document.getElementById('navbar-logo-url-preview');
const navbarLogo = document.getElementById('navbar-logo');
const navbarLogoPreview = document.getElementById('navbar-logo-preview');
const dynamicNavbarContainer = document.getElementById('dynamic-navbar-container');

const navbarLogoRemoveBtn = document.getElementById('navbar-logo-remove');

function clearNavbarLogo() {
  // Clear all possible stored logo sources
  siteSettings.navbar.logoUrl = '';
  siteSettings.navbar.logoBlob = null;
  siteSettings.navbar.logoBase64 = '';
  siteSettings.navbar.logoExport = '';
  siteSettings.navbar.logoFileName = '';
  siteSettings.navbar.logo = ''; // legacy field you already clear on upload  [oai_citation:5‡mobile.html](sediment://file_00000000400871f49f634d2213d84f2f)

  // Clear inputs
  navbarLogo.value = '';
  navbarLogoUrl.value = '';

  // Clear previews
  navbarLogoPreview.innerHTML = '';
  navbarLogoUrlPreview.innerHTML = '';

  // Hide remove button
  if (navbarLogoRemoveBtn) navbarLogoRemoveBtn.style.display = 'none';

  // Update UI
  updateDynamicNavbar();
  updateSiteTitleH1();
}

if (navbarLogoRemoveBtn) {
  navbarLogoRemoveBtn.addEventListener('click', clearNavbarLogo);
}

let currentMediaType = "image";
let editingPrevFileName = '';
let editingPrevFileData = '';
let editingPrevFileType = '';
let allSections = [];
let toDeleteIndex = null;

        
function applyCustomCSS() {
let styleEl = document.getElementById("custom-css-style");
if (!styleEl) {
styleEl = document.createElement("style");
styleEl.id = "custom-css-style";
document.head.appendChild(styleEl);
}

let css = siteSettings.customCSS || "";
css += "\n" + generateFontCSS(); 
styleEl.innerHTML = css;
}

// Default settings
let siteSettings = {
language: 'en',
title: 'Your Website Title',
description: '',
robots: 'index, follow',
author: '',
favicon: '',
socialImage: '',
appColor: '#000000',
headScript: '',
customCSS: '',
fontName: '',
applyFontBody: false,
applyFontHeadings: false,
navbar: { enabled: false, bg: '#ffffff', text: '#000000', logoUrl: '', logo: '', logoFileName: '' , autoHeadings: true, customLinks: [] },
footer: {
"enabled": false,
"bg": "#000000",
"text": "#ffffff",
"phone": "",
"email": "",
"address": "",
"info": "",
"comments": "",
"mail": "",
"heart": "",
"calendar": "",
"question": "",
"rss": "",
"star": "",
"bell": "",
"users": "",
"social": "",
"lock": "",
"cart": "",
"hashtag": "",
"warning": "",
"tag": "",
"menu": "",
"android-robot": "",
"apple": "",
"bag": "",
"behance": "",
"discord": "",
"dribbble": "",
"etsy": "",
"facebook": "",
"flickr": "",
"foursquare": "",
"github": "",
"google": "",
"instagram": "",
"joomla": "",
"linkedin": "",
"link-external": "",
"mastodon": "",
"microsoft": "",
"pinterest": "",
"reddit": "",
"signal": "",
"soundcloud": "",
"telegram": "",
"threads": "",
"tiktok": "",
"tripadvisor": "",
"tumblr": "",
"twitch": "",
"vimeo": "",
"whatsapp": "",
"wordpress": "",
"x": "",
"xing": "",
"yelp": "",
"youtube": "",
"link": ""
}
};

function ensureNavbarExtendedSettings(){
  if (!siteSettings.navbar) siteSettings.navbar = { enabled:false, bg:'#ffffff', text:'#000000', logoUrl:'', logo:'', logoFileName:'' };
  if (typeof siteSettings.navbar.autoHeadings === 'undefined') siteSettings.navbar.autoHeadings = true;
  if (!Array.isArray(siteSettings.navbar.customLinks)) siteSettings.navbar.customLinks = [];
}
ensureNavbarExtendedSettings();



function resetPrevFileBox() {
prevFile.style.display = 'none';
prevFileName.textContent = '';
keepPrevFile.checked = true;
editingPrevFileName = '';
editingPrevFileData = '';
editingPrevFileType = '';
}

function setupModal(type, data, idx) {
currentMediaType = type;
mediaModalTitle.textContent = type === 'image'
? (idx !== undefined ? 'Edit Image' : 'Add Image')
: (idx !== undefined ? 'Edit Video' : 'Add Video');

// Toggle YouTube/Vimeo buttons
const ytVimeoBlock = document.getElementById('youtube-vimeo-options');
ytVimeoBlock.style.display = (type === 'video') ? '' : 'none';


sectionIndex.value = idx !== undefined ? idx : '';
if (data) {
mediaUrl.value = data.url || '';
mediaHeading.value = data.heading || '';
mediaColor.value = data.headingColor || '#ffffff';
bgColor.value = data.bgColor || '#000000';
mediaSize.value = data.mediaSize || 'full';
headingSize.value = data.headingSize || 'uk-heading-2xlarge';
btnLabel.value = data.btnLabel || '';
btnUrl.value = data.btnUrl || '';
btnColor.value = data.btnColor || 'default';

// new fields
mediaSubtitle.value = data.subtitle || '';
subtitleSize.value = data.subtitleSize || 'uk-heading-medium';
subtitleColor.value = data.subtitleColor || '#ffffff';
mediaParagraph.value = data.paragraph || '';
paragraphSize.value = data.paragraphSize || 'large';
paragraphColor.value = data.paragraphColor || '#ffffff';

resetPrevFileBox();
mediaFile.value = '';
mediaFile.accept = type === 'image' ? 'image/*' : 'video/*';

if (!data.url && data.fileName && data.fileData) {
editingPrevFileName = data.fileName;
editingPrevFileData = data.fileData;
editingPrevFileType = data.fileType;
prevFile.style.display = '';
prevFileName.textContent = data.fileName;
} else {
resetPrevFileBox();
}
} else {
mediaUrl.value = '';
mediaHeading.value = 'Your Headline';
mediaColor.value = '#ffffff';
bgColor.value = '#000000';
mediaSize.value = 'full';
headingSize.value = 'uk-heading-large';
btnLabel.value = '';
btnUrl.value = '';
btnColor.value = 'default';

// new fields
mediaSubtitle.value = '';
subtitleSize.value = 'uk-heading-medium';
subtitleColor.value = '#ffffff';
mediaParagraph.value = '';
paragraphSize.value = 'large';
paragraphColor.value = '#ffffff';

mediaFile.value = '';
mediaFile.accept = type === 'image' ? 'image/*' : 'video/*';
resetPrevFileBox();
}
}

addImageBtn.addEventListener('click', () => {
setupModal('image');
applyLastColorsToContainer('#media-modal');
mediaModal.show();
});
addVideoBtn.addEventListener('click', () => {
setupModal('video');
applyLastColorsToContainer('#media-modal');
mediaModal.show();
});

function fileToDataURL(file, cb) {
const reader = new FileReader();
reader.onload = e => cb(e.target.result, file.name, file.type);
reader.readAsDataURL(file);
}

function makeButtonHtml(label, url, color) {
if (!label || !url) return '';
let classes = {
default: 'uk-button-default',
primary: 'uk-button-primary',
secondary: 'uk-button-secondary',
text: 'uk-button-text'
};
return `<a href="${url}" class="uk-button ${classes[color] || 'uk-button-default'} uk-margin-top uk-border-rounded" target="_blank">${label}</a>`;
}

function getTextBlockHtml(block) {
// Subtitle, then Paragraph
let out = '';
if (block.subtitle) {
out += `<div class="live-subtitle ${block.subtitleSize || 'uk-heading-medium'}" style="color:${block.subtitleColor||'#fff'}">${block.subtitle}</div>`;
}
if (block.paragraph) {
out += `<div class="live-paragraph${block.paragraphSize === 'large' ? ' large' : ''}" style="color:${block.paragraphColor||'#fff'};margin-top:0.5em;">${block.paragraph.replace(/\n/g, '<br>')}</div>`;
}
return out;
}

// If you have move/up/down functions (like moveSection or sortable handling), ensure after re-rendering you call scrollToSection(newIdx)

// EMBED modal interactions
embedCodeBtn.addEventListener('click', () => {
setupEmbedModal();
applyLastColorsToContainer('#embed-modal');
UIkit.modal('#embed-modal').show(); // get a fresh modal instance
});

function setupEmbedModal(data, idx) {
const titleEl = document.getElementById('embed-modal-title');
titleEl.textContent = (idx !== undefined && idx !== null) ? 'Edit Embed Code' : 'Add Embed Code';
embedCode.value = data ? data.code : '';
document.getElementById("embed-bgcolor").value = data ? (data.bgColor || "#000000") : "#000000";
embedIndex.value = (idx !== undefined && idx !== null) ? idx : '';
}

embedForm.addEventListener('submit', function (e) {
e.preventDefault();
let code = embedCode.value.trim();
if (!code) {
UIkit.notification({ message: 'Please enter some <b>code</b>.', status: 'warning' });
return;
}

// Correctly parse index
let idx = parseInt(embedIndex.value, 10);
if (isNaN(idx)) idx = null;  // null means new section

let bgColorVal = document.getElementById("embed-bgcolor").value || "#000000";
let block = { type: 'embed', code, bgColor: bgColorVal };

if (idx !== null) {
allSections[idx] = block;   // update existing
} else {
allSections.push(block);    // add new
}

renderAllSections();
applyFontLink();
applyCustomCSS();
embedModal.hide();

// coerce idx to an integer and delay scroll until after the modal is removed from the page class
idx = parseInt(idx, 10);
setTimeout(() => {
  // extra guard that idx is a valid number and the element exists
  if (!Number.isNaN(idx) && document.getElementById('live-editor-root')?.children[idx]) {
    scrollToSection(idx);
  } else {
    // fallback: try to scroll to last item
    const root = document.getElementById('live-editor-root');
    if (root && root.children.length) scrollToSection(root.children.length - 1);
  }
}, 50); // 50ms gives browsers a small moment to remove modal class/overlay (adjust if you like)

});


const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = UIkit.modal('#settings-modal');
const settingsForm = document.getElementById('settings-form');

// Open modal
settingsBtn.addEventListener('click', () => {
document.getElementById('site-language').value = siteSettings.language;
document.getElementById('site-title').value = siteSettings.title;
document.getElementById('site-description').value = siteSettings.description;
document.getElementById('site-robots').value = siteSettings.robots;
document.getElementById('site-author').value = siteSettings.author;
document.getElementById('site-favicon').value = siteSettings.favicon;
document.getElementById('site-social').value = siteSettings.socialImage;
document.getElementById('site-head-script').value = siteSettings.headScript;
document.getElementById("site-custom-css").value = siteSettings.customCSS;
document.getElementById("site-font-name").value = siteSettings.fontName || "";
document.getElementById("apply-to-body").checked = siteSettings.applyFontBody || false;
document.getElementById("apply-to-headings").checked = siteSettings.applyFontHeadings || false;
settingsModal.show();
});

// Save settings
settingsForm.addEventListener('submit', e => {
e.preventDefault();
siteSettings.language = document.getElementById('site-language').value;
siteSettings.title = document.getElementById('site-title').value;
siteSettings.description = document.getElementById('site-description').value;
siteSettings.robots = document.getElementById('site-robots').value;
siteSettings.author = document.getElementById('site-author').value;
siteSettings.favicon = document.getElementById('site-favicon').value;
siteSettings.socialImage = document.getElementById('site-social').value;
siteSettings.headScript = document.getElementById('site-head-script').value;
siteSettings.customCSS = document.getElementById("site-custom-css").value;

siteSettings.fontName = document.getElementById("site-font-name").value.trim();

// ---------- ADD / REPLACE inside your Settings Save handler ----------
const selectedFontTargetInput = document.querySelector('input[name="font-target"]:checked');
siteSettings.fontTarget = selectedFontTargetInput ? selectedFontTargetInput.value : 'none';

// persist settings if you use localStorage (optional, recommended)
try {
  localStorage.setItem('siteSettings', JSON.stringify(siteSettings));
} catch (err) {
  // ignore storage errors but keep siteSettings in-memory
  console.warn('Could not persist siteSettings to localStorage', err);
}

// re-apply font link/css immediately so UI reflects change
if (typeof applyFontLink === 'function') applyFontLink();
if (typeof applyCustomCSS === 'function') applyCustomCSS();
if (typeof renderAllSections === 'function') renderAllSections();
// ---------- END ADD ----------

settingsModal.hide();
applyFontLink(); 
applyCustomCSS(); 
updateDynamicNavbar();
updateSiteTitleH1();
updateFooter();
});

function getExportSectionHtml(block, exportMap) {

if (block.type === 'gallery') {
return block.html;
}
if (block.type === 'text') {
return `
<div class="uk-section uk-section-muted uk-flex uk-flex-center uk-flex-middle"
style="background:${block.bgColor}; min-height:60vh;">
<div class="uk-container uk-text-${block.align || 'center'}" style="color:${block.textColor || '#ffffff'};" uk-scrollspy="cls: ${block.animation}; repeat: true">
${block.heading ? `<h2 class="live-heading ${block.headingSize}" style="color:${block.textColor || '#ffffff'};">${block.heading}</h2>` : ''}
${block.subtitle ? `<div class="live-subtitle ${block.subtitleSize}" style="color:${block.textColor || '#ffffff'};">${block.subtitle}</div>` : ''}
${block.paragraph ? `<p class="live-paragraph ${block.paragraphSize}" style="color:${block.textColor || '#ffffff'};">${block.paragraph}</p>` : ''}
</div>
</div>`;
}

if (block.type === 'embed') {
return `
<div style="position:relative; width:100%; height:100vh; margin:0; padding:0; background:${block.bgColor || '#000'};">
<iframe srcdoc="${block.code.replace(/"/g, '&quot;')}" 
style="position:absolute; top:0; left:0; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden;" 
sandbox="allow-scripts allow-same-origin allow-forms allow-popups">
</iframe>
</div>
`;
}

return getMediaSectionHtml(block, exportMap);
}


function getMediaSectionHtml(block, exportMap) {
if (block.type === 'text') {
return `
<div class="uk-section uk-section-muted uk-flex uk-flex-center uk-flex-middle"
style="background:${block.bgColor}; min-height:60vh;">
<div class="uk-container uk-text-${block.align || 'center'}" style="color:${block.textColor || '#ffffff'};" uk-scrollspy="cls: ${block.animation}; repeat: true">
${block.heading ? `<h2 class="live-heading ${block.headingSize}" style="color:${block.textColor || '#ffffff'};">${block.heading}</h2>` : ''}
${block.subtitle ? `<div class="live-subtitle ${block.subtitleSize}" style="color:${block.textColor || '#ffffff'};">${block.subtitle}</div>` : ''}
${block.paragraph ? `<p class="live-paragraph ${block.paragraphSize}" style="color:${block.textColor || '#ffffff'};">${block.paragraph}</p>` : ''}
</div>
</div>`;
}

let { type, src, url, heading, headingColor, headingSize, bgColor, mediaSize, btnLabel, btnUrl, btnColor, fileName } = block;
let headingClass = `live-heading ${headingSize}`;
let btnHtml = makeButtonHtml(btnLabel, btnUrl, btnColor);

function refSrc(val, fileName, exportMap) {
if (exportMap && fileName && exportMap[fileName]) {
return 'media/' + exportMap[fileName];
}
return val;
}

const textBlock = `
<div uk-scrollspy="cls: uk-animation-slide-top; repeat: true">
<h2 class="${headingClass}" style="color: ${headingColor};">${heading || ''}</h2>
${getTextBlockHtml(block)}
${btnHtml}
</div>
`;

// Decide animation for media
let mediaSpy = '';
if (mediaSize === 'left') mediaSpy = 'uk-scrollspy="cls: uk-animation-slide-right; repeat: true"';
else if (mediaSize === 'right') mediaSpy = 'uk-scrollspy="cls: uk-animation-slide-left; repeat: true"';
else if (mediaSize === 'center' || mediaSize === 'full') mediaSpy = 'uk-scrollspy="cls: uk-animation-slide-bottom; repeat: false"';

// EMBED: Full viewport
if (type === 'embed') {
return `
<div style="position:relative; width:100%; height:100vh; margin:0; padding:0; background:${block.bgColor || '#000'};">
<iframe srcdoc="${block.code.replace(/"/g, '&quot;')}" 
style="position:absolute; top:0; left:0; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden;" 
sandbox="allow-scripts allow-same-origin allow-forms allow-popups">
</iframe>
</div>
`;
}


// IMAGE


if (type === 'image') {

// FULL (image centered, responsive) — Ken Burns + text scrollspy scale-up
if (mediaSize === 'full') {
return `
<div style="position:relative; width:100vw; height:100vh; overflow:hidden; background:${bgColor};">
<img src="${refSrc(src, fileName, exportMap)}"
alt="Image"
style="width:100vw; height:100vh; object-fit:cover; display:block;"
class="uk-animation-kenburns">
<div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:100%;" 
class="uk-text-center uk-light">
${textBlock}
</div>
</div>
`;
}

// CENTER (background-fixed image)
if (mediaSize === 'center') {
return `
<div class="uk-padding-large" style="background:${bgColor};">
<div class="uk-background-fixed uk-background-center-center uk-height-medium uk-border-rounded uk-box-shadow-large"
style="background-image: url(${refSrc(src, fileName, exportMap)}); background-size: cover; background-position: center; min-height:400px;">
</div>
<div class="uk-text-center uk-margin-large-top"
uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:140; offset:150; repeat:false">
${textBlock}
</div>
</div>
`;
}

// LEFT / RIGHT — responsive grid with scrollspy on image and text
function buildSideHtml(side) {
const imgFirst = side === 'left';
const imgColClass = 'uk-width-1-2@m';
const textColClass = 'uk-width-1-2@m uk-padding-medium';

const imgHtml = `<img src="${refSrc(src, fileName, exportMap)}"
alt="Image"
class="uk-border-rounded uk-box-shadow-large"
uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:0; offset:120; repeat:false"
style="width:100%; height:auto; display:block; margin:0 auto;">`;

// Responsive text alignment: left/right on desktop, center on mobile
const textAlignment = imgFirst
? 'uk-text-left@m uk-text-center@s'
: 'uk-text-right@m uk-text-center@s';

return `
<div class="uk-padding-large" style="background:${bgColor};">
<div class="uk-grid-medium uk-child-width-1-1@s uk-flex-middle" uk-grid>
${imgFirst ? `<div class="${imgColClass}">${imgHtml}</div>` : ''}
<div class="${textColClass} ${textAlignment}">
<div uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:120; offset:120; repeat:false">
${textBlock}
</div>
</div>
${!imgFirst ? `<div class="${imgColClass}">${imgHtml}</div>` : ''}
</div>
</div>
`;
}

if (mediaSize === 'left') return buildSideHtml('left');
if (mediaSize === 'right') return buildSideHtml('right');

// fallback — stacked layout
return `
<div class="uk-padding-large" style="background:${bgColor};">
<div class="uk-grid-medium uk-child-width-1-1@s uk-flex-middle" uk-grid>
<div class="uk-width-1-1">
<img src="${refSrc(src, fileName, exportMap)}"
alt="Image"
class="uk-border-rounded uk-box-shadow-large"
uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:0; offset:120; repeat:false"
style="width:100%; height:auto; display:block; margin:0 auto;">
</div>
<div class="uk-width-1-1 uk-padding-medium uk-text-center uk-margin-large-top"
uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:120; offset:120; repeat:false">
${textBlock}
</div>
</div>
</div>
`;
}


// VIDEO
if (type === 'video') {

  const provider = block.provider || '';
  const videoId = block.videoId || '';
  const isProvider = !!(provider && videoId);

  const providerSrc = isProvider
    ? (provider === 'youtube' ? makeYouTubeBgSrc(videoId) : makeVimeoBgSrc(videoId))
    : '';

  const providerIframeCover = isProvider
    ? `<iframe src="${providerSrc}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen uk-cover ${mediaSpy}></iframe>`
    : '';

  const providerIframeResponsive = isProvider
    ? `<iframe src="${providerSrc}" width="1920" height="1080" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen uk-responsive ${mediaSpy}></iframe>`
    : '';

  // FULL (cover video background, text overlay)
  if (mediaSize === 'full') {
    if (isProvider) {
      return `
<div class="uk-cover-container" style="position:relative; width:100vw; height:100vh; overflow:hidden;">
${providerIframeCover}
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:100%;" class="uk-text-center uk-light">
${textBlock}
</div>
</div>
`;
    }

    return `
<div style="position:relative; width:100vw; height:100vh; overflow:hidden;">
<video src="${refSrc(src, fileName, exportMap)}" autoplay loop muted playsinline
style="width:100vw;height:100vh;object-fit:cover;display:block;" ${mediaSpy}></video>
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:100%;" class="uk-text-center uk-light">
${textBlock}
</div>
</div>
`;
  }

  // CENTER (small centered video with text below)
  if (mediaSize === 'center') {
    if (isProvider) {
      return `
<div class="uk-padding-large" style="background:${bgColor};">
<div class="uk-flex uk-flex-center uk-flex-middle uk-flex-wrap">
<div class="uk-text-center">
<div class="uk-border-rounded uk-box-shadow-large uk-overflow-hidden" style="max-width:900px; width:100%; margin:0 auto;">
${providerIframeResponsive}
</div>
${textBlock}
</div>
</div>
</div>
`;
    }

    return `
<div class="uk-padding-large" style="background:${bgColor};">
<div class="uk-flex uk-flex-center uk-flex-middle uk-flex-wrap">
<div class="uk-text-center">
<video src="${refSrc(src, fileName, exportMap)}" autoplay loop muted playsinline
class="uk-border-rounded uk-box-shadow-large"
style="max-width:900px; width:100%; height:auto; display:block; margin:0 auto;"
${mediaSpy}></video>
${textBlock}
</div>
</div>
</div>
`;
  }

  // LEFT (video left, text right)
  if (mediaSize === 'left') {
    if (isProvider) {
      return `
<div class="uk-padding-large" style="background:${bgColor};">
<div class="uk-grid-medium uk-child-width-1-1@s uk-flex-middle" uk-grid>
<div class="uk-width-1-2@m">
<div class="uk-border-rounded uk-box-shadow-large uk-overflow-hidden"
style="width:100%; display:block; margin:0 auto;"
uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:0; offset:120; repeat:false">
${providerIframeResponsive}
</div>
</div>
<div class="uk-width-1-2@m uk-padding-medium uk-text-left@m uk-text-center@s">
<div uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:120; offset:120; repeat:false">
${textBlock}
</div>
</div>
</div>
</div>
`;
    }

    return `
<div class="uk-padding-large" style="background:${bgColor};">
<div class="uk-grid-medium uk-child-width-1-1@s uk-flex-middle" uk-grid>
<div class="uk-width-1-2@m">
<video src="${refSrc(src, fileName, exportMap)}" autoplay loop muted playsinline
class="uk-border-rounded uk-box-shadow-large"
style="width:100%; height:auto; display:block; margin:0 auto;"
uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:0; offset:120; repeat:false"
${mediaSpy}></video>
</div>
<div class="uk-width-1-2@m uk-padding-medium uk-text-left@m uk-text-center@s">
<div uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:120; offset:120; repeat:false">
${textBlock}
</div>
</div>
</div>
</div>
`;
  }

  // RIGHT (video right, text left)
  if (mediaSize === 'right') {
    if (isProvider) {
      return `
<div class="uk-padding-large" style="background:${bgColor};">
<div class="uk-grid-medium uk-child-width-1-1@s uk-flex-middle" uk-grid>
<div class="uk-width-1-2@m uk-padding-medium uk-text-right@m uk-text-center@s">
<div uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:120; offset:120; repeat:false">
${textBlock}
</div>
</div>
<div class="uk-width-1-2@m">
<div class="uk-border-rounded uk-box-shadow-large uk-overflow-hidden"
style="width:100%; display:block; margin:0 auto;"
uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:0; offset:120; repeat:false">
${providerIframeResponsive}
</div>
</div>
</div>
</div>
`;
    }

    return `
<div class="uk-padding-large" style="background:${bgColor};">
<div class="uk-grid-medium uk-child-width-1-1@s uk-flex-middle" uk-grid>
<div class="uk-width-1-2@m uk-padding-medium uk-text-right@m uk-text-center@s">
<div uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:120; offset:120; repeat:false">
${textBlock}
</div>
</div>
<div class="uk-width-1-2@m">
<video src="${refSrc(src, fileName, exportMap)}" autoplay loop muted playsinline
class="uk-border-rounded uk-box-shadow-large"
style="width:100%; height:auto; display:block; margin:0 auto;"
uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:0; offset:120; repeat:false"
${mediaSpy}></video>
</div>
</div>
</div>
`;
  }

  // fallback (stacked layout)
  if (isProvider) {
    return `
<div class="uk-padding-large" style="background:${bgColor};">
<div class="uk-grid-medium uk-child-width-1-1@s uk-flex-middle" uk-grid>
<div class="uk-width-1-2@m">
<div class="uk-border-rounded uk-box-shadow-large uk-overflow-hidden"
style="width:100%; display:block; margin:0 auto;"
uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:0; offset:120; repeat:false">
${providerIframeResponsive}
</div>
</div>
<div class="uk-width-1-2@m uk-padding-medium uk-text-center">
<div uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:120; offset:120; repeat:false">
${textBlock}
</div>
</div>
</div>
</div>
`;
  }

  return `
<div class="uk-padding-large" style="background:${bgColor};">
<div class="uk-grid-medium uk-child-width-1-1@s uk-flex-middle" uk-grid>
<div class="uk-width-1-2@m">
<video src="${refSrc(src, fileName, exportMap)}" autoplay loop muted playsinline
class="uk-border-rounded uk-box-shadow-large"
style="width:100%; height:auto; display:block; margin:0 auto;"
uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:0; offset:120; repeat:false"
${mediaSpy}></video>
</div>
<div class="uk-width-1-2@m uk-padding-medium uk-text-center">
<div uk-scrollspy="cls: uk-animation-scale-up uk-animation-fade; delay:120; offset:120; repeat:false">
${textBlock}
</div>
</div>
</div>
</div>
`;

}

// default fallback (if unknown type)
return `<div class="uk-padding-large" style="background:${bgColor};">${textBlock}</div>`;
}

// --- RENDER ---
// helper: swap two items in array
function swapArrayItems(arr, i, j) {
const tmp = arr[i];
arr[i] = arr[j];
arr[j] = tmp;
}

// move section by id and direction ('up' or 'down'), then re-render
function moveSectionById(id, direction) {
const idx = allSections.findIndex(s => s.id === id);
if (idx === -1) return;

if (direction === 'up' && idx > 0) {
swapArrayItems(allSections, idx, idx - 1);
renderAllSections();
} else if (direction === 'down' && idx < allSections.length - 1) {
swapArrayItems(allSections, idx, idx + 1);
renderAllSections();
}
}

function renderAllSections() {
editorRoot.innerHTML = '';

allSections.forEach((block, idx) => {
const li = document.createElement('li');
li.dataset.id = block.id;
li.className = 'editor-section uk-padding-remove uk-sortable-handle';
li.style.position = 'relative';

// edit (left) uses icon-button primary; remove (right) is a red rectangular danger button
const editBtn = `
<button class="uk-icon-button uk-button-primary uk-border-rounded editor-edit-btn" type="button"
uk-icon="pencil" uk-tooltip="Edit section" aria-label="Edit section"></button>`;
const removeBtn = `
<button class="uk-button uk-button-danger uk-border-rounded editor-remove-btn" type="button"
uk-icon="trash" uk-tooltip="Remove section" aria-label="Remove section"></button>`;

// move buttons now match the edit button look (icon-buttons primary)
const moveUpBtn = `<button class="uk-icon-button uk-button-primary uk-border-rounded editor-move-up" type="button" uk-icon="chevron-up" uk-tooltip="Move up" ${idx === 0 ? 'disabled' : ''} aria-label="Move up"></button>`;
const moveDownBtn = `<button class="uk-icon-button uk-button-primary uk-border-rounded editor-move-down" type="button" uk-icon="chevron-down" uk-tooltip="Move down" ${idx === allSections.length - 1 ? 'disabled' : ''} aria-label="Move down"></button>`;

const sectionStyle = `background: ${block.bgColor}; min-height:60vh;`;

// Controls wrapper: we now rely on CSS classes for exact positioning
const controlsHtml = `
<div class="editor-controls" style="position:absolute; top:0; left:0; right:0; pointer-events:auto;">
${editBtn}
<div class="editor-move-wrapper">${moveUpBtn}${moveDownBtn}</div>
${removeBtn}
</div>
`;

// --- Handle GALLERY sections separately ---
if (block.type === 'gallery') {
li.innerHTML = `
<section id="section-${idx}" class="uk-section uk-section-primary uk-flex uk-flex-middle uk-flex-center"
uk-height-viewport="offset-top: true" style="${sectionStyle};">
${controlsHtml}
${block.html}
</section>
`;

// Edit gallery button → opens gallery modal (keep specific gallery behavior)
const galleryEditBtn = li.querySelector('.editor-edit-btn');
if (galleryEditBtn) {
galleryEditBtn.addEventListener('click', function() {
editGallery(block.id);
});
}

} else {
// Default: text, image, embed, etc.
li.innerHTML = `
<section id="section-${idx}" class="uk-section uk-section-primary" uk-height-viewport="offset-top: true"
style="${sectionStyle};">
${controlsHtml}
${getMediaSectionHtml(block)}
</section>
`;

// --- Edit handler for existing types ---
const editBtnEl = li.querySelector('.editor-edit-btn');
if (editBtnEl) {
editBtnEl.addEventListener('click', function () {
if (block.type === 'embed') {
setupEmbedModal(block, idx);
applyLastColorsToContainer('#embed-modal');
UIkit.modal('#embed-modal').show();
} else if (block.type === 'text') {
// Prefill text modal with saved values
textHeading.value   = block.heading || '';
textSubtitle.value  = block.subtitle || '';
textParagraph.innerHTML = block.paragraph || '';
textAnimation.value = block.animation || 'uk-animation-fade';
if (typeof textBgColor !== 'undefined') textBgColor.value = block.bgColor || '#ffffff';
if (typeof textColor !== 'undefined')   textColor.value   = block.textColor || '#000000';
if (typeof textHeadingSize !== 'undefined')  textHeadingSize.value  = block.headingSize || 'h-lg';
if (typeof textSubtitleSize !== 'undefined') textSubtitleSize.value = block.subtitleSize || 'sub-md';
if (typeof textParagraphSize !== 'undefined') textParagraphSize.value = block.paragraphSize || 'p-md';
textIndex.value = idx;

    // ensure hidden align input reflects saved value and update UI
    textAlignInput.value = (block && block.align) ? block.align : 'center';
    const _currentAlign = (textAlignInput && textAlignInput.value) ? textAlignInput.value : 'center';
    Array.from(textAlignGroup.querySelectorAll('.align-option')).forEach(b =>
      b.classList.toggle('uk-button-primary', b.dataset.align === _currentAlign));

const textTitleEl = document.getElementById('text-modal-title');
if (textTitleEl) textTitleEl.textContent = 'Edit Text';

applyLastColorsToContainer('#text-modal');
textModal.show();
} else if (block.type === 'faq') {
openFaqModal(block, idx);
} else if (block.type === 'slider') {
openSliderModal(block, idx);
} else {
setupModal(block.type, block, idx);
applyLastColorsToContainer('#media-modal');
mediaModal.show();
}
});
}
}

// --- Move handlers (present for both gallery and non-gallery) ---
const moveUpEl = li.querySelector('.editor-move-up');
if (moveUpEl) {
moveUpEl.addEventListener('click', function (ev) {
ev.stopPropagation();
moveSectionById(block.id, 'up');
});
}
const moveDownEl = li.querySelector('.editor-move-down');
if (moveDownEl) {
moveDownEl.addEventListener('click', function (ev) {
ev.stopPropagation();
moveSectionById(block.id, 'down');
});
}

// --- Delete handler ---
const removeBtnEl = li.querySelector('.editor-remove-btn');
if (removeBtnEl) {
removeBtnEl.addEventListener('click', function(ev) {
ev.stopPropagation();
toDeleteIndex = idx;
deleteModal.show();
});
}

editorRoot.appendChild(li);
});

UIkit.update(editorRoot);
updateDynamicNavbar();
updateSiteTitleH1();
updateFooter();
}

// Sortable event
UIkit.util.on(editorRoot, 'moved', function(e) {
let newSections = [];
Array.from(editorRoot.children).forEach(li => {
let id = li.dataset.id;                      // use stable id
let found = allSections.find(b => b.id === id);
if (found) newSections.push(found);
});
if (newSections.length === allSections.length) {
allSections = newSections;
}
renderAllSections();
applyFontLink();
applyCustomCSS(); // re-render to update section-ids and dynamic navbar
});

// Modal submission
mediaForm.addEventListener('submit', function(e) {
e.preventDefault();
let file = mediaFile.files[0];
let url = mediaUrl.value.trim();
let heading = mediaHeading.value || '';
let headingColor = mediaColor.value || '#ffffff';
let headingSizeVal = headingSize.value || 'uk-heading-2xlarge';
let mediaSizeVal = mediaSize.value;
let bgColorVal = bgColor.value || "#000000";
let btnLabelVal = btnLabel.value.trim();
let btnUrlVal = btnUrl.value.trim();
let btnColorVal = btnColor.value;
// New
let subtitleVal = mediaSubtitle.value || '';
let subtitleSizeVal = subtitleSize.value || 'uk-heading-medium';
let subtitleColorVal = subtitleColor.value || '#ffffff';
let paragraphVal = mediaParagraph.value || '';
let paragraphSizeVal = paragraphSize.value || '';
let paragraphColorVal = paragraphColor.value || '#ffffff';

let idx = sectionIndex.value ? parseInt(sectionIndex.value) : null;

function generateId() {
return 'sec-' + Math.random().toString(36).substr(2, 9);
}

function finishSection(src, fileData, fileName, fileType) {
let block = {
id: (idx !== null && allSections[idx]) ? allSections[idx].id : generateId(), // keep old id if editing
type: currentMediaType,
src,
url: url ? url : '',
heading,
headingColor,
headingSize: headingSizeVal,
bgColor: bgColorVal,
mediaSize: mediaSizeVal,
btnLabel: btnLabelVal,
btnUrl: btnUrlVal,
btnColor: btnColorVal,
subtitle: subtitleVal,
subtitleSize: subtitleSizeVal,
subtitleColor: subtitleColorVal,
paragraph: paragraphVal,
paragraphSize: paragraphSizeVal,
paragraphColor: paragraphColorVal
};

// If this is a VIDEO section and the URL is a YouTube/Vimeo link, treat it as a provider-backed background video.
// This lets you paste a YT/Vimeo link directly into the URL field (and still get muted autoplay when rendered as VIDEO).
if (currentMediaType === 'video' && url && !fileData) {
  const ytId = extractYouTubeId(url);
  const vmId = extractVimeoId(url);
  if (ytId || vmId) {
    block.provider = ytId ? 'youtube' : 'vimeo';
    block.videoId = ytId || vmId;
    block.src = '';
    // ensure we don't accidentally export file blobs
    delete block.fileData;
    delete block.fileName;
    delete block.fileType;
  }
}

// Always set fileData and fileName if uploading
if (!url && fileData && fileName) {
block.fileData = fileData;
block.fileName = fileName;
block.fileType = fileType;
}
if (idx !== null && !isNaN(idx)) {
allSections[idx] = block;
} else {
allSections.push(block);
}
renderAllSections();
applyFontLink();
applyCustomCSS();
mediaModal.hide();

// coerce idx to an integer and delay scroll until after the modal is removed from the page class
idx = parseInt(idx, 10);
setTimeout(() => {
  // extra guard that idx is a valid number and the element exists
  if (!Number.isNaN(idx) && document.getElementById('live-editor-root')?.children[idx]) {
    scrollToSection(idx);
  } else {
    // fallback: try to scroll to last item
    const root = document.getElementById('live-editor-root');
    if (root && root.children.length) scrollToSection(root.children.length - 1);
  }
}, 50); // 50ms gives browsers a small moment to remove modal class/overlay (adjust if you like)
}

if (file) {
fileToDataURL(file, (dataurl, fileName, fileType) => finishSection(dataurl, dataurl, fileName, fileType));
} else if (url) {
finishSection(url);
} else if (prevFile.style.display !== 'none' && keepPrevFile.checked && editingPrevFileData) {
finishSection(editingPrevFileData, editingPrevFileData, editingPrevFileName, editingPrevFileType);
} else {
UIkit.notification({message: 'Please provide a <b>URL</b> or upload a <b>file</b>.', status: 'warning'});
return;
}

});

// --- Save JSON Modal ---
// Modal HTML for Save JSON
// (Insert near end of body, before </body>)

// [MODAL HTML IS ADDED AT THE END OF THE FILE]

// Save JSON modal binding using UIkit, ensuring modal opens and filename is passed to saveJSON
document.addEventListener('DOMContentLoaded', () => {
  const saveJSONBtn = document.getElementById('saveJSON');
  const saveJSONModalEl = document.getElementById('save-json-modal');
  const saveJSONForm = document.getElementById('save-json-form');
  const jsonFilenameInput = document.getElementById('json-filename');

  saveJSONBtn.addEventListener('click', () => {
    jsonFilenameInput.value = '';
    UIkit.modal(saveJSONModalEl).show();
  });

  saveJSONForm.addEventListener('submit', async e => {
    e.preventDefault();

    const fileName = jsonFilenameInput.value.trim() || 'homepage.json';

    const settingsToSave = JSON.parse(JSON.stringify(siteSettings));
    delete settingsToSave.faviconBlob;
    delete settingsToSave.socialBlob;
    if (settingsToSave.navbar) delete settingsToSave.navbar.logoBlob;

    const convertBlobToBase64 = blob => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });

    const conversions = [];
    if (siteSettings.navbar && siteSettings.navbar.logoBlob) {
      conversions.push(convertBlobToBase64(siteSettings.navbar.logoBlob).then(b64 => {
        settingsToSave.navbar.logoBase64 = b64;
      }));
    }
    if (siteSettings.faviconBlob) {
      conversions.push(convertBlobToBase64(siteSettings.faviconBlob).then(b64 => {
        settingsToSave.faviconBase64 = b64;
      }));
    }
    if (siteSettings.socialBlob) {
      conversions.push(convertBlobToBase64(siteSettings.socialBlob).then(b64 => {
        settingsToSave.socialBase64 = b64;
      }));
    }

    await Promise.all(conversions);

    const out = JSON.stringify({ settings: settingsToSave, sections: allSections }, null, 2);
    const blob = new Blob([out], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = fileName.endsWith('.json') ? fileName : fileName + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    UIkit.modal(saveJSONModalEl).hide();
  });
});

/// Load JSON (unwrap settings + sections)
loadJSONBtn.addEventListener('click', function() {
jsonFileInput.click();
});

// Populate every footer modal input from siteSettings.footer
function populateFooterModal() {
  siteSettings.footer = siteSettings.footer || {};

  // Basic fields
  const enableFooterEl = document.getElementById('enable-footer'); if (enableFooterEl) enableFooterEl.checked = !!siteSettings.footer.enabled;
  const footerBgEl = document.getElementById('footer-bg'); if (footerBgEl) footerBgEl.value = siteSettings.footer.bg || '#000000';
  const footerTextEl = document.getElementById('footer-text'); if (footerTextEl) footerTextEl.value = siteSettings.footer.text || '#ffffff';
  const footerPhoneEl = document.getElementById('footer-phone'); if (footerPhoneEl) footerPhoneEl.value = siteSettings.footer.phone || '';
  const footerEmailEl = document.getElementById('footer-email'); if (footerEmailEl) footerEmailEl.value = siteSettings.footer.email || '';
  const footerAddressEl = document.getElementById('footer-address'); if (footerAddressEl) footerAddressEl.value = siteSettings.footer.address || '';

  // Single link
  const footerLinkEl = document.getElementById('footer-link'); if (footerLinkEl) footerLinkEl.value = siteSettings.footer.link || '';

  // Website/custom link-like keys (explicit mapping)
  const websiteKeys = [
    'info','comments','mail','heart','calendar','question','rss','star','bell','users',
    'social','lock','cart','hashtag','warning','tag','menu','android-robot','apple','bag'
  ];
  websiteKeys.forEach(k => {
    const el = document.getElementById(`footer-${k}`);
    if (el) el.value = siteSettings.footer[k] || '';
  });

  // Social & other icons (explicit list from your save handler)
  const socialKeys = [
    'behance','discord','dribbble','etsy','facebook','flickr','foursquare','github','google','instagram',
    'joomla','linkedin','link-external','mastodon','microsoft','pinterest','reddit','signal','soundcloud',
    'telegram','threads','tiktok','tripadvisor','tumblr','twitch','vimeo','whatsapp','wordpress','x','xing',
    'yelp','youtube'
  ];
  socialKeys.forEach(k => {
    const el = document.getElementById(`footer-${k}`);
    if (el) el.value = siteSettings.footer[k] || '';
  });

  // Remaining keys that appear in your save handler (cover any extras)
  const otherKeys = [
    'users','social','link-external','android-robot','bag','info','comments','mail','heart','calendar',
    'question','rss','star','bell','hashtag','warning','tag','menu'
  ];
  otherKeys.forEach(k => {
    const el = document.getElementById(`footer-${k}`);
    if (el) el.value = siteSettings.footer[k] || '';
  });
}

jsonFileInput.addEventListener('change', function(e) {
if (!e.target.files[0]) return;
const file = e.target.files[0];
const reader = new FileReader();
reader.onload = function(evt) {
try {
const data = JSON.parse(evt.target.result || '{}');

// If file only had sections (old format), fallback gracefully
if (Array.isArray(data)) {
allSections = data;
} else {
siteSettings = data.settings || siteSettings;
siteSettings.navbar = Object.assign(
{ enabled:false, bg:'#ffffff', text:'#000000', logoUrl:'', logoFileName:'' },
siteSettings.navbar || {}
);
allSections = data.sections || [];

// Restore font settings if present
siteSettings.fontName = data.settings?.fontName || siteSettings.fontName || '';
siteSettings.fontTarget = data.settings?.fontTarget || siteSettings.fontTarget || 'none';

// Sync the radio button in Site Settings modal
if (siteSettings.fontTarget) {
const radio = document.querySelector(`input[name="font-target"][value="${siteSettings.fontTarget}"]`);
if (radio) radio.checked = true;
}
}

renderAllSections();

// Reapply Google Fonts + custom CSS
applyFontLink();
applyCustomCSS();

// ---  Sync textarea in Site Settings modal
const cssField = document.getElementById("site-custom-css");
if (cssField) cssField.value = siteSettings.customCSS || "";

// --- Restore logo, favicon, and social from JSON (base64 backup first, fallback to export paths) ---
if (siteSettings.faviconBase64) {
siteSettings.faviconBlob = dataURLtoBlob(siteSettings.faviconBase64);
faviconPreview.innerHTML = `<img src="${siteSettings.faviconBase64}" style="max-height:40px;">`;
} else if (siteSettings.faviconExport) {
faviconPreview.innerHTML = `<img src="${siteSettings.faviconExport}" style="max-height:40px;">`;
} else {
faviconPreview.innerHTML = '';
}

if (siteSettings.socialBase64) {
siteSettings.socialBlob = dataURLtoBlob(siteSettings.socialBase64);
socialPreview.innerHTML = `<img src="${siteSettings.socialBase64}" style="max-height:80px;">`;
} else if (siteSettings.socialExport) {
socialPreview.innerHTML = `<img src="${siteSettings.socialExport}" style="max-height:80px;">`;
} else {
socialPreview.innerHTML = '';
}

if (siteSettings.navbar && siteSettings.navbar.logoBase64) {
siteSettings.navbar.logo = siteSettings.navbar.logoBase64;   
siteSettings.navbar.logoBlob = dataURLtoBlob(siteSettings.navbar.logoBase64);
navbarLogoPreview.innerHTML = `<img src="${siteSettings.navbar.logoBase64}" class="navbar-logo">`;
} else if (siteSettings.navbar.logoExport) {
navbarLogoPreview.innerHTML = `<img src="${siteSettings.navbar.logoExport}" class="navbar-logo">`;
} else {
navbarLogoPreview.innerHTML = '';
}

// Populate footer modal fields
populateFooterModal();

// Utility: Convert base64 back to Blob
function dataURLtoBlob(dataurl) {
let arr = dataurl.split(',');
let mime = arr[0].match(/:(.*?);/)[1];
let bstr = atob(arr[1]);
let n = bstr.length;
let u8arr = new Uint8Array(n);
let nLen = bstr.length;
while (nLen--) {
u8arr[nLen] = bstr.charCodeAt(nLen);
}
return new Blob([u8arr], { type: mime });
}

} catch {
UIkit.notification({message: 'Invalid <b>JSON</b> file!', status:'danger'});
}
};
reader.readAsText(file);
e.target.value = '';
});

// --- Footer Modal Controls ---
const footerBtn = document.getElementById('footerBtn');
const footerModal = UIkit.modal('#footer-modal');
const footerForm = document.getElementById('footer-form');
const enableFooter = document.getElementById('enable-footer');
const footerBg = document.getElementById('footer-bg');
const footerText = document.getElementById('footer-text');
const footerPhone = document.getElementById('footer-phone');
const footerEmail = document.getElementById('footer-email');
const footerAddress = document.getElementById('footer-address');

footerBtn.addEventListener('click', () => {
enableFooter.checked = siteSettings.footer.enabled;
footerBg.value = siteSettings.footer.bg;
footerText.value = siteSettings.footer.text;
footerPhone.value = siteSettings.footer.phone || '';
footerEmail.value = siteSettings.footer.email || '';
footerAddress.value = siteSettings.footer.address || '';
applyLastColorsToContainer('#footer-modal');
footerModal.show();
});

footerForm.addEventListener('submit', (e) => {
e.preventDefault();
siteSettings.footer.enabled = enableFooter.checked;
siteSettings.footer.bg = footerBg.value;
siteSettings.footer.text = footerText.value;
siteSettings.footer.phone = footerPhone.value.trim();
siteSettings.footer.email = footerEmail.value.trim();
siteSettings.footer.address = footerAddress.value.trim();
siteSettings.footer["info"] = document.getElementById("footer-info").value.trim();
siteSettings.footer["comments"] = document.getElementById("footer-comments").value.trim();
siteSettings.footer["mail"] = document.getElementById("footer-mail").value.trim();
siteSettings.footer["heart"] = document.getElementById("footer-heart").value.trim();
siteSettings.footer["calendar"] = document.getElementById("footer-calendar").value.trim();
siteSettings.footer["question"] = document.getElementById("footer-question").value.trim();
siteSettings.footer["rss"] = document.getElementById("footer-rss").value.trim();
siteSettings.footer["star"] = document.getElementById("footer-star").value.trim();
siteSettings.footer["bell"] = document.getElementById("footer-bell").value.trim();
siteSettings.footer["users"] = document.getElementById("footer-users").value.trim();
siteSettings.footer["social"] = document.getElementById("footer-social").value.trim();
siteSettings.footer["lock"] = document.getElementById("footer-lock").value.trim();
siteSettings.footer["cart"] = document.getElementById("footer-cart").value.trim();
siteSettings.footer["hashtag"] = document.getElementById("footer-hashtag").value.trim();
siteSettings.footer["warning"] = document.getElementById("footer-warning").value.trim();
siteSettings.footer["tag"] = document.getElementById("footer-tag").value.trim();
siteSettings.footer["menu"] = document.getElementById("footer-menu").value.trim();
siteSettings.footer["android-robot"] = document.getElementById("footer-android-robot").value.trim();
siteSettings.footer["apple"] = document.getElementById("footer-apple").value.trim();
siteSettings.footer["bag"] = document.getElementById("footer-bag").value.trim();
siteSettings.footer["behance"] = document.getElementById("footer-behance").value.trim();
siteSettings.footer["discord"] = document.getElementById("footer-discord").value.trim();
siteSettings.footer["dribbble"] = document.getElementById("footer-dribbble").value.trim();
siteSettings.footer["etsy"] = document.getElementById("footer-etsy").value.trim();
siteSettings.footer["facebook"] = document.getElementById("footer-facebook").value.trim();
siteSettings.footer["flickr"] = document.getElementById("footer-flickr").value.trim();
siteSettings.footer["foursquare"] = document.getElementById("footer-foursquare").value.trim();
siteSettings.footer["github"] = document.getElementById("footer-github").value.trim();
siteSettings.footer["google"] = document.getElementById("footer-google").value.trim();
siteSettings.footer["instagram"] = document.getElementById("footer-instagram").value.trim();
siteSettings.footer["joomla"] = document.getElementById("footer-joomla").value.trim();
siteSettings.footer["linkedin"] = document.getElementById("footer-linkedin").value.trim();
siteSettings.footer["link-external"] = document.getElementById("footer-link-external").value.trim();
siteSettings.footer["mastodon"] = document.getElementById("footer-mastodon").value.trim();
siteSettings.footer["microsoft"] = document.getElementById("footer-microsoft").value.trim();
siteSettings.footer["pinterest"] = document.getElementById("footer-pinterest").value.trim();
siteSettings.footer["reddit"] = document.getElementById("footer-reddit").value.trim();
siteSettings.footer["signal"] = document.getElementById("footer-signal").value.trim();
siteSettings.footer["soundcloud"] = document.getElementById("footer-soundcloud").value.trim();
siteSettings.footer["telegram"] = document.getElementById("footer-telegram").value.trim();
siteSettings.footer["threads"] = document.getElementById("footer-threads").value.trim();
siteSettings.footer["tiktok"] = document.getElementById("footer-tiktok").value.trim();
siteSettings.footer["tripadvisor"] = document.getElementById("footer-tripadvisor").value.trim();
siteSettings.footer["tumblr"] = document.getElementById("footer-tumblr").value.trim();
siteSettings.footer["twitch"] = document.getElementById("footer-twitch").value.trim();
siteSettings.footer["vimeo"] = document.getElementById("footer-vimeo").value.trim();
siteSettings.footer["whatsapp"] = document.getElementById("footer-whatsapp").value.trim();
siteSettings.footer["wordpress"] = document.getElementById("footer-wordpress").value.trim();
siteSettings.footer["x"] = document.getElementById("footer-x").value.trim();
siteSettings.footer["xing"] = document.getElementById("footer-xing").value.trim();
siteSettings.footer["yelp"] = document.getElementById("footer-yelp").value.trim();
siteSettings.footer["youtube"] = document.getElementById("footer-youtube").value.trim();
siteSettings.footer["link"] = document.getElementById("footer-link").value.trim();

footerModal.hide();
updateFooter();
});


function buildSocialIcons() {
const socials = [
{ key: 'info', icon: 'info' },
{ key: 'comments', icon: 'comments' },
{ key: 'mail', icon: 'mail' },
{ key: 'heart', icon: 'heart' },      
{ key: 'calendar', icon: 'calendar' },
{ key: 'question', icon: 'question' },
{ key: 'rss', icon: 'rss' },
{ key: 'star', icon: 'star' },
{ key: 'bell', icon: 'bell' },
{ key: 'users', icon: 'users' },
{ key: 'social', icon: 'social' },
{ key: 'lock', icon: 'lock' },
{ key: 'cart', icon: 'cart' },
{ key: 'hashtag', icon: 'hashtag' },
{ key: 'warning', icon: 'warning' },
{ key: 'tag', icon: 'tag' },
{ key: 'menu', icon: 'menu' },
{ key: 'android-robot', icon: 'android-robot' },
{ key: 'apple', icon: 'apple' },
{ key: 'bag', icon: 'bag' },
{ key: 'behance', icon: 'behance' },
{ key: 'discord', icon: 'discord' },
{ key: 'dribbble', icon: 'dribbble' },
{ key: 'etsy', icon: 'etsy' },
{ key: 'facebook', icon: 'facebook' },
{ key: 'flickr', icon: 'flickr' },
{ key: 'foursquare', icon: 'foursquare' },
{ key: 'github', icon: 'github' },
{ key: 'google', icon: 'google' },
{ key: 'instagram', icon: 'instagram' },
{ key: 'joomla', icon: 'joomla' },
{ key: 'linkedin', icon: 'linkedin' },
{ key: 'link-external', icon: 'link-external' },
{ key: 'mastodon', icon: 'mastodon' },
{ key: 'microsoft', icon: 'microsoft' },
{ key: 'pinterest', icon: 'pinterest' },
{ key: 'reddit', icon: 'reddit' },
{ key: 'signal', icon: 'signal' },
{ key: 'soundcloud', icon: 'soundcloud' },
{ key: 'telegram', icon: 'telegram' },
{ key: 'threads', icon: 'threads' },
{ key: 'tiktok', icon: 'tiktok' },
{ key: 'tripadvisor', icon: 'tripadvisor' },
{ key: 'tumblr', icon: 'tumblr' },
{ key: 'twitch', icon: 'twitch' },
{ key: 'vimeo', icon: 'vimeo' },
{ key: 'whatsapp', icon: 'whatsapp' },
{ key: 'wordpress', icon: 'wordpress' },
{ key: 'x', icon: 'x' },           // Twitter/X
{ key: 'xing', icon: 'xing' },
{ key: 'yelp', icon: 'yelp' },
{ key: 'youtube', icon: 'youtube' },
{ key: 'link', icon: 'link' }
];
let html = socials
.filter(s => siteSettings.footer[s.key])
.map(s =>
`<a href="${siteSettings.footer[s.key]}" uk-icon="icon: ${s.icon}; ratio: 1.5" target="_blank" style="margin:0 8px; color:${siteSettings.footer.text}"></a>`
).join('');
return html ? `<div class="footer-social" style="margin-bottom:10px;">${html}</div>` : '';
}

function buildFooterHtml() {
if (!siteSettings.footer.enabled) return '';
let content = siteSettings.footer.content && siteSettings.footer.content.trim()
? siteSettings.footer.content
: `&copy; ${new Date().getFullYear()} ${siteSettings.title || 'My Website'}`;
let contactHtml = '';
if (siteSettings.footer.phone) {
contactHtml += `<div><span uk-icon="receiver"></span> <a href="tel:${siteSettings.footer.phone}" style="color:${siteSettings.footer.text}">${siteSettings.footer.phone}</a></div>`;
}
if (siteSettings.footer.email) {
contactHtml += `<div><span uk-icon="mail"></span> <a href="mailto:${siteSettings.footer.email}" style="color:${siteSettings.footer.text}">${siteSettings.footer.email}</a></div>`;
}
if (siteSettings.footer.address) {
contactHtml += `<div><span uk-icon="location"></span> ${siteSettings.footer.address}</div>`;
}

return `
<footer class="uk-section uk-section-small" 
style="background:${siteSettings.footer.bg}; color:${siteSettings.footer.text}; text-align:center;">
${buildSocialIcons()}
<p><strong>${siteSettings.title || ''}</strong></p>
${contactHtml}
<p>&copy; ${new Date().getFullYear()} ${siteSettings.author || ''}</p>
</footer>`;
}

function updateFooter() {
const existing = document.getElementById('editor-footer');
if (existing) existing.remove();
if (siteSettings.footer.enabled) {
const footer = document.createElement('div');
footer.id = 'editor-footer';
footer.innerHTML = buildFooterHtml();
document.body.appendChild(footer);
}
}


// --- Favicon & Social Upload ---
const faviconFile = document.getElementById('site-favicon-file');
const faviconPreview = document.getElementById('site-favicon-preview');
const socialFile = document.getElementById('site-social-file');
const socialPreview = document.getElementById('site-social-preview');

faviconFile.addEventListener('change', (e) => {
if (e.target.files[0]) {
const file = e.target.files[0];
siteSettings.faviconBlob = file;   // ✅ store blob
siteSettings.faviconFileName = file.name;
siteSettings.faviconFileType = file.type;
siteSettings.favicon = '';         // clear legacy base64
faviconPreview.innerHTML = `<img src="${URL.createObjectURL(file)}" style="max-height:40px;">`;
}
});

socialFile.addEventListener('change', (e) => {
if (e.target.files[0]) {
const file = e.target.files[0];
siteSettings.socialBlob = file;   // ✅ store blob
siteSettings.socialFileName = file.name;
siteSettings.socialFileType = file.type;
siteSettings.socialImage = '';    // clear legacy base64
socialPreview.innerHTML = `<img src="${URL.createObjectURL(file)}" style="max-height:80px;">`;
}
});

// NEW: Navbar modal open/save

navBarBtn.addEventListener('click', () => {
enableNavbar.checked = siteSettings.navbar.enabled;
if (navbarAutoHeadings) navbarAutoHeadings.checked = (siteSettings.navbar.autoHeadings !== false);
if (typeof updateNavbarCustomLinksCountUI === 'function') updateNavbarCustomLinksCountUI();

navbarBg.value = siteSettings.navbar.bg;
navbarText.value = siteSettings.navbar.text;
navbarLogoUrl.value = siteSettings.navbar.logoUrl || '';
if (siteSettings.navbar.logoUrl) {
navbarLogoUrlPreview.innerHTML = `<img src="${siteSettings.navbar.logoUrl}" class="navbar-logo">`;
} else {
navbarLogoUrlPreview.innerHTML = '';
}
if (siteSettings.navbar.logoBlob) {
navbarLogoPreview.innerHTML = `<img src="${URL.createObjectURL(siteSettings.navbar.logoBlob)}" class="navbar-logo">`;
} else if (siteSettings.navbar.logoUrl) {
navbarLogoPreview.innerHTML = `<img src="${siteSettings.navbar.logoUrl}" class="navbar-logo">`;
} else {
navbarLogoPreview.innerHTML = '';
}
applyLastColorsToContainer('#navbar-modal');
navbarModal.show();

const hasLogo = !!(siteSettings.navbar.logoUrl || siteSettings.navbar.logoBase64 || siteSettings.navbar.logoBlob || siteSettings.navbar.logoExport);
  if (navbarLogoRemoveBtn) navbarLogoRemoveBtn.style.display = hasLogo ? 'inline-block' : 'none';

});

navbarLogoUrl.addEventListener('input', () => {
  const url = navbarLogoUrl.value.trim();

  // If using URL, clear blob/base64/export so only one source wins
  siteSettings.navbar.logoBlob = null;
  siteSettings.navbar.logoBase64 = '';
  siteSettings.navbar.logoExport = '';
  siteSettings.navbar.logoUrl = url;

  navbarLogoUrlPreview.innerHTML = url ? `<img src="${url}" class="navbar-logo">` : '';
  navbarLogoPreview.innerHTML = ''; // optional: keep only one preview visible

  if (navbarLogoRemoveBtn) navbarLogoRemoveBtn.style.display = url ? 'inline-block' : 'none';
});

navbarLogo.addEventListener('change', (e) => {
if (e.target.files[0]) {
const file = e.target.files[0];

siteSettings.navbar.logoUrl = '';
siteSettings.navbar.logoBase64 = '';
siteSettings.navbar.logoExport = '';
navbarLogoUrl.value = '';
navbarLogoUrlPreview.innerHTML = '';

siteSettings.navbar.logoFileName = file.name;
siteSettings.navbar.logoBlob = file;   // blob, not base64
siteSettings.navbar.logo = '';         // clear legacy base64
navbarLogoPreview.innerHTML = `<img src="${URL.createObjectURL(file)}" class="navbar-logo">`;

if (navbarLogoRemoveBtn) navbarLogoRemoveBtn.style.display = 'inline-block';

}
});

navbarForm.addEventListener('submit', (e) => {
e.preventDefault();
siteSettings.navbar.enabled = enableNavbar.checked;
siteSettings.navbar.bg = navbarBg.value;
siteSettings.navbar.text = navbarText.value;
siteSettings.navbar.autoHeadings = navbarAutoHeadings ? !!navbarAutoHeadings.checked : true;

navbarModal.hide();
updateDynamicNavbar();
updateSiteTitleH1();
updateFooter();
});

// Build dynamic navbar HTML for the EDITOR page (second navbar under toolbar)

/* -----------------------------
   Dynamic Nav Bar: Custom Links
------------------------------*/
(function(){
  const navbarCustomLinksBtn = document.getElementById('navbar-custom-links-btn');
  const navbarCustomLinksCount = document.getElementById('navbar-custom-links-count');

  const navbarLinksModal = (window.UIkit && UIkit.modal) ? UIkit.modal('#navbar-links-modal') : null;
  const navbarLinksList = document.getElementById('navbar-links-list');
  const navbarLinksAdd = document.getElementById('navbar-links-add');
  const navbarLinksSave = document.getElementById('navbar-links-save');
  const navbarLinksSortAZ = document.getElementById('navbar-links-sort-az');
  const navbarLinksSortZA = document.getElementById('navbar-links-sort-za');
  const navbarLinksUseGlobal = document.getElementById('navbar-links-use-global');
  const navbarLinksGlobalUrl = document.getElementById('navbar-links-global-url');
  const navbarLinksRefresh = document.getElementById('navbar-links-refresh');
  const navbarLinksStatus = document.getElementById('navbar-links-status');
  const navbarLinksImportJson = document.getElementById('navbar-links-import-json');
  const navbarLinksExportJson = document.getElementById('navbar-links-export-json');
  const navbarLinksJsonFile = document.getElementById('navbar-links-json-file');

  let navbarLinksDraft = [];

  function ensureNavbarCustomLinks(){
    if (!siteSettings.navbar) siteSettings.navbar = {};
    if (!Array.isArray(siteSettings.navbar.customLinks)) siteSettings.navbar.customLinks = [];
    if (typeof siteSettings.navbar.autoHeadings === 'undefined') siteSettings.navbar.autoHeadings = true;
    if (typeof siteSettings.navbar.useGlobalLinks === 'undefined') siteSettings.navbar.useGlobalLinks = false;
    if (typeof siteSettings.navbar.globalLinksUrl === 'undefined') siteSettings.navbar.globalLinksUrl = '';
  }

  function getNavbarCustomLinks(){
    ensureNavbarCustomLinks();
    return siteSettings.navbar.customLinks;
  }

  function updateNavbarCustomLinksCountUI(){
    if (!navbarCustomLinksCount) return;
    navbarCustomLinksCount.textContent = String(getNavbarCustomLinks().length);
  }

  function escapeHtml(s){
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function normalizeLinksPayload(data){
    let arr = [];
    if (Array.isArray(data)) arr = data;
    else if (data && Array.isArray(data.links)) arr = data.links;
    else arr = [];
    return arr.map(x=>{
      const title = (x.title || x.label || x.text || '').toString().trim();
      const url = (x.url || x.href || x.link || '').toString().trim();
      const newTab = !!(x.newTab || x.blank || x.target === '_blank');
      return { title, url, newTab };
    }).filter(x=>x.title && x.url);
  }

  function downloadJson(filename, obj){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function setGlobalUiState(){
    ensureNavbarCustomLinks();
    const useGlobal = !!siteSettings.navbar.useGlobalLinks;

    if (navbarLinksList) navbarLinksList.classList.toggle('uk-disabled', useGlobal);

    [navbarLinksAdd, navbarLinksSortAZ, navbarLinksSortZA, navbarLinksImportJson].forEach(btn=>{
      if (!btn) return;
      btn.disabled = useGlobal;
    });

    // Export JSON is safe in both modes
    if (navbarLinksExportJson) navbarLinksExportJson.disabled = false;

    // Disable inputs inside list (re-render safe)
    if (navbarLinksList) {
      navbarLinksList.querySelectorAll('input, button.navbar-link-remove').forEach(el=>{
        el.disabled = useGlobal;
      });
    }

    if (navbarLinksUseGlobal) navbarLinksUseGlobal.checked = useGlobal;
    if (navbarLinksGlobalUrl) navbarLinksGlobalUrl.value = siteSettings.navbar.globalLinksUrl || '';

    // Status badge (editor only)
    if (!useGlobal) {
      setGlobalLinksStatusUI('disabled');
    } else {
      // Keep most recent status; fall back to idle/synced based on last fetch timestamp.
      if (__globalLinksSyncing) setGlobalLinksStatusUI('syncing');
      else if (__globalLinksLastStatus === 'failed') setGlobalLinksStatusUI('failed');
      else if (__globalLinksLastAt) setGlobalLinksStatusUI('synced');
      else setGlobalLinksStatusUI('idle');
    }

  }

  let __globalLinksSyncing = false;
  let __globalLinksLastUrl = '';
  let __globalLinksLastAt = 0;
  let __globalLinksLastError = '';
  let __globalLinksLastStatus = 'idle'; // idle|syncing|synced|failed|disabled

  function setGlobalLinksStatusUI(status, detail){
    __globalLinksLastStatus = status || __globalLinksLastStatus || 'idle';
    const el = navbarLinksStatus;
    if (!el) return;

    // Base label classes
    el.classList.remove('uk-label-success','uk-label-warning','uk-label-danger');
    let label = 'Not synced';

    if (__globalLinksLastStatus === 'disabled'){
      label = 'Disabled';
    } else if (__globalLinksLastStatus === 'syncing'){
      label = 'Syncing…';
      el.classList.add('uk-label-warning');
    } else if (__globalLinksLastStatus === 'synced'){
      label = 'Synced ✓';
      el.classList.add('uk-label-success');
    } else if (__globalLinksLastStatus === 'failed'){
      label = 'Failed ✕';
      el.classList.add('uk-label-danger');
    }

    el.textContent = label;

    const url = (siteSettings?.navbar?.globalLinksUrl || '').trim();
    const when = __globalLinksLastAt ? new Date(__globalLinksLastAt).toLocaleString() : '—';
    const extra = detail || (__globalLinksLastError ? (__globalLinksLastError + '') : '');
    const tip = [
      'Global links status: ' + label,
      'URL: ' + (url || '—'),
      'Last fetch: ' + when,
      extra ? ('Details: ' + extra) : ''
    ].filter(Boolean).join('\n');

    // UIkit tooltip reads title attribute
    el.setAttribute('title', tip);
  }


  async function fetchGlobalLinks(url){
    const u = (url || '').trim();
    if (!u) return [];
    const bust = (u.includes('?') ? '&' : '?') + 't=' + Date.now();
    const res = await fetch(u + bust, { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    return normalizeLinksPayload(data);
  }

  async function syncGlobalLinks(showToast){
    ensureNavbarCustomLinks();
    if (!siteSettings.navbar.useGlobalLinks) return;
    const url = (siteSettings.navbar.globalLinksUrl || '').trim();
    if (!url) {
      if (showToast && window.UIkit) UIkit.notification({message:'Please set a Global JSON URL/path first.', status:'warning'});
      return;
    }
    const now = Date.now();
    if (__globalLinksSyncing) return;
    if (url === __globalLinksLastUrl && (now - __globalLinksLastAt) < 1500) return;

    __globalLinksSyncing = true;
    __globalLinksLastError = '';
    setGlobalLinksStatusUI('syncing');
    try {
      const links = await fetchGlobalLinks(url);
      siteSettings.navbar.customLinks = links;
      __globalLinksLastUrl = url;
      __globalLinksLastAt = Date.now();
      setGlobalLinksStatusUI('synced');
      updateNavbarCustomLinksCountUI();
      if (typeof updateDynamicNavbar === 'function') updateDynamicNavbar();
      if (showToast && window.UIkit) UIkit.notification({message:'Global links updated.', status:'success'});
    } catch (e) {
      __globalLinksLastError = (e && e.message) ? e.message : String(e || 'Error');
      setGlobalLinksStatusUI('failed', __globalLinksLastError);
      if (showToast && window.UIkit) UIkit.notification({message:'Failed to load global links JSON. Check URL/CORS/JSON format.', status:'danger'});
    } finally {
      __globalLinksSyncing = false;
    }
  }

  function exportCustomLinksJson(){
    const links = getNavbarCustomLinks().map(x=>({title:x.title||'', url:x.url||'', newTab:!!x.newTab}));
    downloadJson('navbar-links.json', { version: 1, links });
  }

  function importCustomLinksJsonFile(file){
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(String(reader.result || ''));
        const links = normalizeLinksPayload(data);
        ensureNavbarCustomLinks();
        siteSettings.navbar.useGlobalLinks = false;
        siteSettings.navbar.customLinks = links;
        navbarLinksDraft = links.map(x=>({title:x.title, url:x.url, newTab:!!x.newTab}));
        updateNavbarCustomLinksCountUI();
        if (typeof updateDynamicNavbar === 'function') updateDynamicNavbar();
        renderNavbarLinksList();
        setGlobalUiState();
        if (window.UIkit) UIkit.notification({message:'Imported custom links JSON.', status:'success'});
      } catch(e){
        if (window.UIkit) UIkit.notification({message:'Invalid JSON file.', status:'danger'});
      }
    };
    reader.readAsText(file);
  }


  function renderNavbarLinksList(){
    if (!navbarLinksList) return;
    navbarLinksList.innerHTML = '';
    navbarLinksDraft.forEach((lnk,i)=>{
      const li=document.createElement('li');
      li.className='uk-card uk-card-default uk-card-body uk-border-rounded navbar-links-card';
      li.dataset.index=String(i);

      li.innerHTML = `
        <div class="uk-grid-small uk-flex-middle" uk-grid>
          <div class="uk-width-auto">
            <span class="navbar-links-handle" uk-icon="icon: move"></span>
          </div>
          <div class="uk-width-expand">
            <div class="uk-grid-small" uk-grid>
              <div class="uk-width-1-3@s">
                <label class="uk-form-label">Title</label>
                <input class="uk-input uk-border-rounded navbar-link-title" value="${escapeHtml(lnk.title||'')}" placeholder="e.g. Pricing">
              </div>
              <div class="uk-width-1-2@s">
                <label class="uk-form-label">URL</label>
                <input class="uk-input uk-border-rounded navbar-link-url" value="${escapeHtml(lnk.url||'')}" placeholder="https://... or #anchor">
              </div>
              <div class="uk-width-1-6@s">
                <label class="uk-form-label">New tab</label>
                <label class="switch-label" style="margin-top:6px;">
                  <span class="switch">
                    <input type="checkbox" class="navbar-link-newtab" ${lnk.newTab ? 'checked' : ''}>
                    <span class="slider"></span>
                  </span>
                </label>
              </div>
            </div>

            <div class="uk-flex uk-flex-right uk-margin-small-top">
              <button class="uk-button uk-button-danger uk-button-small uk-border-rounded navbar-link-remove" type="button">Remove</button>
            </div>
          </div>
        </div>
      `;

      li.querySelector('.navbar-link-remove')?.addEventListener('click', ()=>{
        navbarLinksDraft.splice(i,1);
        renderNavbarLinksList();
      });

      navbarLinksList.appendChild(li);
    });
    setGlobalUiState();
    if (window.UIkit) UIkit.update(navbarLinksList);
  }

  function readDraftFromUI(){
    if (!navbarLinksList) return navbarLinksDraft.slice();
    const items=[...navbarLinksList.querySelectorAll('li.navbar-links-card')];
    return items.map(li=>{
      const title=li.querySelector('.navbar-link-title')?.value || '';
      const url=li.querySelector('.navbar-link-url')?.value || '';
      const newTab=!!li.querySelector('.navbar-link-newtab')?.checked;
      return { title, url, newTab };
    });
  }

  function openNavbarLinksModal(){
    ensureNavbarCustomLinks();
    navbarLinksDraft = getNavbarCustomLinks().map(x=>({title:x.title||'', url:x.url||'', newTab:!!x.newTab}));
    renderNavbarLinksList();
    setGlobalUiState();
    // Reflect current global-links status immediately
    try { /* status already set in setGlobalUiState */ } catch(e){}
    if (siteSettings.navbar.useGlobalLinks) syncGlobalLinks(false);
    if (navbarLinksModal) navbarLinksModal.show();
  }

  function applyDraft(){
    ensureNavbarCustomLinks();
    // Persist global settings from modal controls
    if (navbarLinksUseGlobal) siteSettings.navbar.useGlobalLinks = !!navbarLinksUseGlobal.checked;
    if (navbarLinksGlobalUrl) siteSettings.navbar.globalLinksUrl = (navbarLinksGlobalUrl.value || '').trim();

    // In local mode: save list edits. In global mode: keep last synced list (or existing).
    if (!siteSettings.navbar.useGlobalLinks) {
      const next = readDraftFromUI();
      siteSettings.navbar.customLinks = next;
    }

    updateNavbarCustomLinksCountUI();
    if (typeof updateDynamicNavbar === 'function') updateDynamicNavbar();
    if (siteSettings.navbar.useGlobalLinks) syncGlobalLinks(false);
  }

  function sortDraft(dir){
    navbarLinksDraft = readDraftFromUI();
    navbarLinksDraft.sort((a,b)=>{
      const A=(a.title||'').toLowerCase();
      const B=(b.title||'').toLowerCase();
      return dir==='az' ? A.localeCompare(B) : B.localeCompare(A);
    });
    renderNavbarLinksList();
  }

  navbarCustomLinksBtn?.addEventListener('click', openNavbarLinksModal);
  navbarLinksAdd?.addEventListener('click', ()=>{
    navbarLinksDraft = readDraftFromUI();
    navbarLinksDraft.push({title:'', url:'', newTab:false});
    renderNavbarLinksList();
  });
  navbarLinksSave?.addEventListener('click', ()=>{
    applyDraft();
    if (navbarLinksModal) navbarLinksModal.hide();
  });

  navbarLinksUseGlobal?.addEventListener('change', ()=>{
    ensureNavbarCustomLinks();
    siteSettings.navbar.useGlobalLinks = !!navbarLinksUseGlobal.checked;
    setGlobalUiState();
    if (siteSettings.navbar.useGlobalLinks) syncGlobalLinks(true);
  });

  navbarLinksGlobalUrl?.addEventListener('change', ()=>{
    ensureNavbarCustomLinks();
    siteSettings.navbar.globalLinksUrl = (navbarLinksGlobalUrl.value || '').trim();
  });

  navbarLinksRefresh?.addEventListener('click', ()=>{
    syncGlobalLinks(true);
  });

  navbarLinksExportJson?.addEventListener('click', ()=>{
    exportCustomLinksJson();
  });

  navbarLinksImportJson?.addEventListener('click', ()=>{
    if (navbarLinksJsonFile) {
      navbarLinksJsonFile.value = '';
      navbarLinksJsonFile.click();
    }
  });

  navbarLinksJsonFile?.addEventListener('change', ()=>{
    const f = navbarLinksJsonFile.files && navbarLinksJsonFile.files[0];
    importCustomLinksJsonFile(f);
  });
  navbarLinksSortAZ?.addEventListener('click', ()=>sortDraft('az'));
  navbarLinksSortZA?.addEventListener('click', ()=>sortDraft('za'));

  if (window.UIkit && UIkit.util && navbarLinksList) {
    UIkit.util.on(navbarLinksList, 'moved', ()=>{
      navbarLinksDraft = readDraftFromUI();
      renderNavbarLinksList();
    });
  }

  // Init count
  updateNavbarCustomLinksCountUI();

  window.addEventListener('load', ()=>{ try{ if (siteSettings?.navbar?.useGlobalLinks) syncGlobalLinks(false); } catch(e){} });

  // Expose count updater for navbar modal open handler
  window.updateNavbarCustomLinksCountUI = updateNavbarCustomLinksCountUI;
})();

function buildEditorDynamicNavBarHtml() {
if (!siteSettings.navbar.enabled) return '';
const links = [];
  
if (siteSettings.navbar.logoUrl) {
links.push(`<li><a href="#top"><img src="${siteSettings.navbar.logoUrl}" alt="${siteSettings.title}" class="navbar-logo"></a></li>`);
} else if (siteSettings.navbar.logoBase64) {
links.push(`<li><a href="#top"><img src="${siteSettings.navbar.logoBase64}" alt="${siteSettings.title}" class="navbar-logo"></a></li>`);
} else if (siteSettings.navbar.logoBlob) {
links.push(`<li><a href="#top"><img src="${URL.createObjectURL(siteSettings.navbar.logoBlob)}" alt="${siteSettings.title}" class="navbar-logo"></a></li>`);
} else {
links.push(`<li><a href="#top">${siteSettings.title || 'Home'}</a></li>`);
}

// Auto section heading links
if (siteSettings.navbar.autoHeadings !== false) {
  allSections.forEach((block, idx) => {
const label = navLabelFor(block);
if (label) {
const safe = String(label).replace(/</g, '&lt;').replace(/>/g, '&gt;');
links.push(`<li><a href="#section-${idx}">${safe}</a></li>`);
}
});
}

// place below toolbar; sticky will naturally sit under it since toolbar also sticky

// Custom links (append after headings)
const _customLinks = Array.isArray(siteSettings.navbar.customLinks) ? siteSettings.navbar.customLinks : [];
_customLinks.forEach((lnk) => {
  if (!lnk) return;
  const title = (lnk.title || '').trim();
  const href = (lnk.url || '').trim();
  if (!title || !href) return;
  const safeTitle = String(title).replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const safeHref = String(href).replace(/"/g,'&quot;');
  const attrs = lnk.newTab ? ' target="_blank" rel="noopener"' : '';
  links.push(`<li><a href="${safeHref}"${attrs}>${safeTitle}</a></li>`);
});

return `<nav class="uk-navbar-container" style="background:${siteSettings.navbar.bg};position:sticky;top:60px;z-index:999;">
<ul class="navbar-scroll" uk-scrollspy-nav="closest: a; scroll: true; offset: 100" style="color:${siteSettings.navbar.text};">
${links.join('')}
</ul>
</nav>`;
}

// Toggle H1 visibility depending on logo presence
const siteTitleH1 = document.getElementById('site-title-h1');
function updateSiteTitleH1() {
siteTitleH1.textContent = siteSettings.title || '';
if (siteSettings.navbar.logoUrl || siteSettings.navbar.logoBase64 || siteSettings.navbar.logoBlob) {
siteTitleH1.classList.add('visually-hidden');
} else {
siteTitleH1.classList.remove('visually-hidden');
}
}

// One place to decide what shows in the Dynamic Nav for each block
function navLabelFor(block) {
if (block.type === 'gallery') {
// prefer structured title, then stored heading, then parse HTML (legacy)
let label = (block.data && block.data.title) || block.heading || '';
if (!label && block.html) {
try {
const doc = new DOMParser().parseFromString(block.html, 'text/html');
label = doc.querySelector('h1 span')?.textContent
|| doc.querySelector('h3')?.textContent
|| '';
} catch (e) {}
}
return label;
}
return block.heading || '';
}

// Update/inject the dynamic navbar in the editor

function updateDynamicNavbar() {
  // Reflect navbar enabled state for CSS (mobile toggle visibility, etc.)
  document.body.setAttribute('data-navbar-enabled', siteSettings?.navbar?.enabled ? '1' : '0');

  // Hard-hide mobile menu elements when navbar disabled (covers preview/export CSS variants)
  const _mmT = document.getElementById('mobile-menu-toggle');
  const _mm = document.getElementById('mobile-menu');
  if (_mmT) _mmT.style.display = siteSettings?.navbar?.enabled ? '' : 'none';
  if (_mm) _mm.style.display = siteSettings?.navbar?.enabled ? '' : 'none';


  if (!dynamicNavbarContainer) return;
  dynamicNavbarContainer.innerHTML = buildEditorDynamicNavBarHtml();

  // Clear mobile menu contents if navbar disabled
  const mobileMenu = document.getElementById('mobile-menu');
  if (mobileMenu && !(siteSettings?.navbar?.enabled)) mobileMenu.innerHTML = '';
}

// Recompute offset on resize (simple re-render)
window.addEventListener('resize', updateDynamicNavbar);


const previewBtn = document.getElementById('previewBtn');

// Helper: build dynamic navbar for PREVIEW/EXPORT (top:0 since no toolbar)
function buildPreviewDynamicNavBarHtml() {
if (!siteSettings.navbar.enabled) return '';
const links = [];

if (siteSettings.navbar.logoExport) {
// 1. Exported file path (set during Export)
links.push(`<li><a href="#top"><img src="${siteSettings.navbar.logoExport}" alt="${siteSettings.title}" class="navbar-logo"></a></li>`);
} else if (siteSettings.navbar.logoUrl) {
// 2. Explicit URL
links.push(`<li><a href="#top"><img src="${siteSettings.navbar.logoUrl}" alt="${siteSettings.title}" class="navbar-logo"></a></li>`);
} else if (siteSettings.navbar.logoBase64) {
// 3. Base64 restored from JSON
links.push(`<li><a href="#top"><img src="${siteSettings.navbar.logoBase64}" alt="${siteSettings.title}" class="navbar-logo"></a></li>`);
} else if (siteSettings.navbar.logoBlob) {
// 4. Uploaded file not yet exported
const blobUrl = URL.createObjectURL(siteSettings.navbar.logoBlob);
links.push(`<li><a href="#top"><img src="${blobUrl}" alt="${siteSettings.title}" class="navbar-logo"></a></li>`);
} else {
// 5. Fallback: just show the site title
links.push(`<li><a href="#top">${siteSettings.title || 'Home'}</a></li>`);
}

// Auto section heading links
if (siteSettings.navbar.autoHeadings !== false) {
  allSections.forEach((block, idx) => {
const label = navLabelFor(block);
if (label) {
const safe = String(label).replace(/</g, '&lt;').replace(/>/g, '&gt;');
links.push(`<li><a href="#section-${idx}">${safe}</a></li>`);
}
});
}



// Custom links (append after headings)
const _customLinks = Array.isArray(siteSettings.navbar.customLinks) ? siteSettings.navbar.customLinks : [];
_customLinks.forEach((lnk) => {
  if (!lnk) return;
  const title = (lnk.title || '').trim();
  const href = (lnk.url || '').trim();
  if (!title || !href) return;
  const safeTitle = String(title).replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const safeHref = String(href).replace(/"/g,'&quot;');
  const attrs = lnk.newTab ? ' target="_blank" rel="noopener"' : '';
  links.push(`<li><a href="${safeHref}"${attrs}>${safeTitle}</a></li>`);
});

return `<nav class="uk-navbar-container" style="background:${siteSettings.navbar.bg};position:sticky;top:0;z-index:999;">
<ul class="navbar-scroll" uk-scrollspy-nav="closest: a; scroll: true; offset: 100" style="color:${siteSettings.navbar.text};">
${links.join('')}
</ul>
</nav>`;
}

// Preview in new window
previewBtn.addEventListener('click', function () {
const exportMap = {}; // not needed for preview, but avoids errors

let exportBlocks = allSections.map((block, idx) =>
`<section id="section-${idx}" class="uk-section uk-section-primary uk-flex uk-flex-middle uk-flex-center" uk-height-viewport="offset-top: true" style="background:${block.bgColor};min-height:60vh;padding:0;margin:0;">
${getExportSectionHtml(block, exportMap)}
</section>`
).join('\n');

let navBarHtml = buildPreviewDynamicNavBarHtml();
const __glUrl = (siteSettings?.navbar?.globalLinksUrl || '').trim();
const globalNavLinksScript = (siteSettings?.navbar?.useGlobalLinks && __glUrl) ? `<script>
/* Global Custom Links loader (Dynamic Nav Bar) */
(function(){
  var URL_ = ${JSON.stringify(__glUrl)};
  if (!URL_) return;
  function normalize(data){
    var arr = Array.isArray(data) ? data : (data && Array.isArray(data.links) ? data.links : []);
    return arr.map(function(x){
      var title = String((x.title||x.label||x.text||'')||'').trim();
      var href = String((x.url||x.href||x.link||'')||'').trim();
      var newTab = !!(x.newTab || x.blank || x.target === '_blank');
      return {title:title, url:href, newTab:newTab};
    }).filter(function(x){ return x.title && x.url; });
  }
  function render(links){
    var nav = document.querySelector('nav.uk-navbar-container ul.navbar-scroll');
    if (!nav) return;
    nav.querySelectorAll('li[data-custom-link="1"]').forEach(function(el){ el.remove(); });
    links.forEach(function(lnk){
      var li=document.createElement('li');
      li.setAttribute('data-custom-link','1');
      var a=document.createElement('a');
      a.textContent=lnk.title;
      a.href=lnk.url;
      if (lnk.newTab) { a.target='_blank'; a.rel='noopener'; }
      li.appendChild(a);
      nav.appendChild(li);
    });
    try{ if (typeof window.__rebuildMobileMenu === 'function') window.__rebuildMobileMenu(); }catch(e){}
  }
  function fetchLinks(){
    var bust = (URL_.indexOf('?')>-1 ? '&' : '?') + 't=' + Date.now();
    return fetch(URL_ + bust, {cache:'no-store'})
      .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(normalize);
  }
  function refresh(){ fetchLinks().then(render).catch(function(){}); }
  window.addEventListener('load', function(){
    refresh();
    setInterval(refresh, 5*60*1000);
  });
})();
<\/script>` : '';

const mobileMenuHtml = (siteSettings?.navbar?.enabled)
  ? `
<!-- Mobile Menu (Preview/Export) -->
<div id="mobile-menu-toggle" aria-label="Toggle mobile menu">
  <div class="bar bar1"></div>
  <div class="bar bar2"></div>
</div>
<div id="mobile-menu" aria-hidden="true"></div>
<script>
(function(){
  var toggle = document.getElementById('mobile-menu-toggle');
  var menu = document.getElementById('mobile-menu');
  if (!toggle || !menu) return;

  function build(){
    var nav = document.querySelector('nav.uk-navbar-container ul.navbar-scroll');
    if (!nav) return;
    // Build a simple vertical menu from the navbar links
    var ul = document.createElement('ul');
    ul.className = 'uk-nav uk-nav-default';
    nav.querySelectorAll('li a').forEach(function(a){
      var li = document.createElement('li');
      var link = a.cloneNode(true);
      li.appendChild(link);
      ul.appendChild(li);
    });
    menu.innerHTML = '';
    menu.appendChild(ul);
  }

  function open(){
    build();
    menu.classList.add('show');
    menu.setAttribute('aria-hidden','false');
    toggle.classList.add('open');
  }
  function close(){
    menu.classList.remove('show');
    menu.setAttribute('aria-hidden','true');
    toggle.classList.remove('open');
  }
  function isOpen(){ return menu.classList.contains('show'); }

  toggle.addEventListener('click', function(){
    if (isOpen()) close(); else open();
  });

  // Close on link click
  menu.addEventListener('click', function(e){
    var a = e.target && e.target.closest && e.target.closest('a');
    if (a) close();
  });

  // Rebuild on load (and after global links refresh)
  window.addEventListener('load', function(){ build(); });

  // Close if resizing up
  window.addEventListener('resize', function(){
    if (window.innerWidth > 1024) close();
  });

  // Expose a tiny hook used by global-links loader (safe no-op elsewhere)
  window.__rebuildMobileMenu = build;
})();
<\/script>
`
  : '';

let html = `
<!DOCTYPE html>
<html lang="${siteSettings.language}">
<head>
<meta charset="UTF-8">
<title>${siteSettings.title}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="${siteSettings.description}">
<meta name="robots" content="${siteSettings.robots}">
<meta name="author" content="${siteSettings.author}">
`;

// Inject Google Font link & CSS if set
if (siteSettings.fontName) {
const fontUrl = `https://fonts.googleapis.com/css2?family=${siteSettings.fontName.replace(/ /g,'+')}&display=swap`;
html += `<link href="${fontUrl}" rel="stylesheet">\n`;
html += `<style>\n${generateFontCSS()}\n</style>\n`;
}

// Continue head content
html += `
${siteSettings.faviconExport ? `<link rel="icon" href="${siteSettings.faviconExport}">\n  <link rel="shortcut icon" href="${siteSettings.faviconExport}">` : ''}
${siteSettings.socialExport ? `<meta property="og:image" content="${siteSettings.socialExport}">` : ''}
${siteSettings.headScript || ''}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/css/uikit.min.css" />
<style>
.live-paragraph { font-size: 1.13rem; max-width: 40em; margin-left:auto; margin-right:auto;}

/* Simple 3-size system for text blocks */
.live-heading.h-sm { font-size: 2.2rem; line-height: 1.15; }
.live-heading.h-md { font-size: 3.2rem; line-height: 1.12; }
.live-heading.h-lg { font-size: 4.2rem; line-height: 1.08; }

.live-subtitle.sub-sm { font-size: 1.1rem; font-weight: 500; }
.live-subtitle.sub-md { font-size: 1.35rem; font-weight: 500; }
.live-subtitle.sub-lg { font-size: 1.7rem; font-weight: 500; }

.live-paragraph.p-sm { font-size: 1.0rem; }
.live-paragraph.p-md { font-size: 1.13rem; }
.live-paragraph.p-lg { font-size: 1.30rem; }

@media (max-width: 640px) {
.live-heading.h-lg { font-size: 2.6rem; }
.live-heading.h-md { font-size: 2.0rem; }
.live-heading.h-sm { font-size: 1.6rem; }

.live-subtitle.sub-lg { font-size: 1.2rem; }
.live-subtitle.sub-md { font-size: 1.05rem; }
.live-subtitle.sub-sm { font-size: 0.95rem; }

.live-paragraph.p-lg { font-size: 1.05rem; }
.live-paragraph.p-md { font-size: 0.98rem; }
.live-paragraph.p-sm { font-size: 0.92rem; }
}

.live-paragraph.uk-text-large { font-size: 1.45rem; }
@media (max-width: 640px) {
.live-paragraph { font-size: 1rem;}
.live-paragraph.uk-text-large { font-size: 1.1rem;}
}
img, video { max-width: 100%; height: auto; display: block; }
@media (max-width: 640px) {
.live-heading, .live-subtitle, .live-paragraph {
text-align: center !important;
word-break: break-word;
white-space: normal;
}
}
.navbar-scroll {
display:flex; flex-wrap:nowrap; gap:1rem; overflow-x:auto; white-space:nowrap; -webkit-overflow-scrolling:touch; padding:0.5rem 1rem; align-items:center; list-style:none; margin:0;
}
.navbar-scroll a { flex:0 0 auto; text-decoration:none; color:inherit; }
.navbar-scroll a.uk-active { font-weight:bold; border-bottom:2px solid currentColor; }
  
.navbar-logo {
height: 40px !important;
width: auto !important;
max-height: 40px !important;
object-fit: contain;
flex-shrink: 0 !important;
flex-grow: 0 !important;
}

.navbar-scroll {
display: flex;
flex-wrap: nowrap;
overflow-x: auto;
-webkit-overflow-scrolling: touch;
white-space: nowrap;
gap: 1rem;
padding: 0.5rem 1rem;
}
.navbar-scroll li {
flex: 0 0 auto;
list-style: none;
}

.visually-hidden {
position: absolute !important;
width: 1px; height: 1px;
margin: -1px; padding: 0; border: 0;
overflow: hidden; clip: rect(0 0 0 0); clip-path: inset(50%);
white-space: nowrap;
}

:root {
--navbar-link-color: #000000;
}

.navbar-scroll::-webkit-scrollbar {
height: 6px;
}
.navbar-scroll::-webkit-scrollbar-thumb {
background: var(--navbar-link-color);
border-radius: 3px;
}
.navbar-scroll::-webkit-scrollbar-track {
background: var(--gray, #eee);
}


.navbar-scroll {
-ms-overflow-style: none;  /* IE & Edge */
scrollbar-width: none;     /* Firefox */
}
.navbar-scroll::-webkit-scrollbar {
display: none;             /* Chrome, Safari, Opera */
}

/* ========================================================================
Button 
========================================================================== */

/* Primary Button */
.uk-button-primary {
background-color: #000;
color: #fff;
}

/* Primary Button Hover */
.uk-button-primary:hover {
background-color: #000;
color: #fff;
}

/* Primary Button Active */
.uk-button-primary:active,
.uk-button-primary.uk-active {
background-color: #000;
color: #fff;
}

/* Secondary Button */
.uk-button-secondary {
background-color: #000;
color: #fff;
border: 1px solid transparent;
}

/* Secondary Button Hover */
.uk-button-secondary:hover {
background-color: #fff;
color: #000;
}

/* Secondary Button Active */
.uk-button-secondary:active,
.uk-button-secondary.uk-active {
background-color: #000;
color: #fff;
}

/* Contextual Secondary Button Overrides for UIkit Sections/Cards/Overlay */
.uk-light .uk-button-secondary,
.uk-section-primary:not(.uk-preserve-color) .uk-button-secondary,
.uk-section-secondary:not(.uk-preserve-color) .uk-button-secondary,
.uk-tile-primary:not(.uk-preserve-color) .uk-button-secondary,
.uk-tile-secondary:not(.uk-preserve-color) .uk-button-secondary,
.uk-card-primary.uk-card-body .uk-button-secondary,
.uk-card-primary > :not([class*='uk-card-media']) .uk-button-secondary,
.uk-card-secondary.uk-card-body .uk-button-secondary,
.uk-card-secondary > :not([class*='uk-card-media']) .uk-button-secondary,
.uk-overlay-primary .uk-button-secondary,
.uk-offcanvas-bar .uk-button-secondary {
background-color: #000;
color: #fff;
}

/* ========================================================================
Links
========================================================================== */

.uk-link {
text-decoration: underline;
cursor: pointer;
}

.uk-link:hover,
.uk-link-toggle:hover .uk-link {
text-decoration: none;
}

/* ========================================================================
Lightbox
========================================================================== */

.uk-lightbox-button {
box-sizing: border-box;
width: 50px;
height: 50px;
background: rgba(0, 0, 0, 0.3);
color: rgba(255, 255, 255, 0.7);
border-radius: 100%;
/* 1 */
display: inline-flex;
justify-content: center;
align-items: center;
}

.uk-lightbox-iframe {
width: 90%;
height: 90%;
border: 0px solid black;
border-radius: 0; /* Default: no rounding for Chrome, Brave, etc. */
}

/* Safari-only override */
@supports (-webkit-hyphens: none) and (not (-moz-appearance: none)) {
.uk-lightbox-iframe {
border-radius: 25px;
}
}

.uk-lightbox-toolbar {
padding: 5px 5px;
background: transparent;
color: rgba(255, 255, 255, 0.7);
}
.uk-lightbox-toolbar > * {
color: rgba(255, 255, 255, 0.7);
}

.uk-lightbox-toolbar-icon {
box-sizing: border-box;
width: 50px;
height: 50px;
background: #000;
color: #fff;
border-radius: 100%;
/* 1 */
display: inline-flex;
justify-content: center;
align-items: center;
}

/* ===== keep only the close button always visible (preserve exact look) ===== */

/* wide selector to match common UIkit close button variants */
.uk-lightbox .uk-lightbox-button.uk-close,
.uk-lightbox .uk-lightbox-button.uk-close svg,
.uk-lightbox .uk-close,
.uk-lightbox [data-uk-close],
.uk-lightbox [data-uk-close] > * {
/* DO NOT change visual properties (width/height/background/color/border-radius/flex)
— we only override visibility/stacking/interaction and remove hide transforms. */
position: fixed !important;        /* remove from hidden parent so it stays visible */
top: 5px !important;               /* align with toolbar padding — preserves placement */
right: 5px !important;             /* align with toolbar padding */
z-index: 999999 !important;        /* above overlays */
display: inline-flex !important;   /* keep your inline-flex layout */
opacity: 0.7 !important;             /* force fully visible */
visibility: visible !important;    /* force visible */
pointer-events: auto !important;   /* clickable even if parent is disabled */
transform: none !important;        /* cancel hide transforms */
transition: none !important;       /* prevent fade-out transitions */
animation: none !important;        /* stop any hiding animations */
}

/* If UIkit sets helper classes, undo them for close only */
.uk-lightbox .uk-lightbox-button.uk-close.uk-hidden,
.uk-lightbox .uk-lightbox-button.uk-close.uk-invisible,
.uk-lightbox .uk-close.uk-hidden,
.uk-lightbox .uk-close.uk-invisible,
.uk-lightbox [data-uk-close].uk-hidden,
.uk-lightbox [data-uk-close].uk-invisible {
display: inline-flex !important;
opacity: 0.7 !important;
visibility: visible !important;
pointer-events: auto !important;
}

/* keep SVG/icon inside intact (do not change color/size) */
.uk-lightbox .uk-lightbox-button.uk-close svg,
.uk-lightbox .uk-close svg {
position: static !important;
width: auto !important;
height: auto !important;
}

/* mobile tweak to avoid overlap while preserving look (keeps same size) */
@media (max-width: 480px) {
.uk-lightbox .uk-lightbox-button.uk-close,
.uk-lightbox .uk-close,
.uk-lightbox [data-uk-close] {
top: 8px !important;
right: 8px !important;
}
}


/* ========================================================================
Slider
========================================================================== */

.uk-slidenav {
padding: 5px 10px;
color: rgba(102, 102, 102, 0.5);
transition: color 0.1s ease-in-out;
width: 50px;
height: 50px;
background: rgba(0, 0, 0, 0.3);
color: rgba(255, 255, 255, 0.7);
border-radius: 100%;
display: inline-flex;
justify-content: center;
align-items: center;

}

/* ========================================================================
Additional CSS:
========================================================================== */

html {
-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
}

button:focus,
button:active {
-moz-outline: 0 !important;
-ms-outline:0 !important;
-o-outline: 0 !important;
-webkit-outline: 0 !important;
}

.uk-border-rounded {
border-radius: 25px;
}

/* ============================
Dynamic Navbar & Mobile Menu
=========================== */

/* ---------- Mobile + Tablet: up to 1024px ---------- */
@media (max-width: 1024px) {

  /* --- Navbar container --- */
  #dynamic-navbar-container,
  nav.uk-navbar-container {
    display: flex;
    align-items: center;
    justify-content: flex-start; /* keep logo on left */
    width: 100%;
    min-height: 60px;
    background-color: var(--navbar-bg-color, #fff);
    position: relative;
    z-index: 1;
  }

  /* --- Navbar UL --- */
  #dynamic-navbar-container ul.navbar-scroll,
  nav.uk-navbar-container ul.navbar-scroll {
    display: flex;
    align-items: center;
    margin: 0;
    padding: 0;
  }

  /* --- Hide all text links, keep layout --- */
  #dynamic-navbar-container ul.navbar-scroll a:not(:has(img)),
  nav.uk-navbar-container ul.navbar-scroll a:not(:has(img)) {
    visibility: hidden;       /* hides but keeps space */
    pointer-events: none;     /* prevents clicks */
    height: 0;                /* optional: collapse vertical space */
    margin: 0;
    padding: 0;
  }

  /* --- Logo link visible --- */
  #dynamic-navbar-container ul.navbar-scroll a:has(img),
  nav.uk-navbar-container ul.navbar-scroll a:has(img) {
    visibility: visible;
    pointer-events: auto;
  }

  /* --- Logo image styling --- */
  #dynamic-navbar-container ul.navbar-scroll a:has(img) img,
  nav.uk-navbar-container ul.navbar-scroll a:has(img) img {
    display: block;
    max-height: 40px;
    width: auto;
  }

/* --- Logo image spacing --- */
#dynamic-navbar-container ul.navbar-scroll a:has(img) img,
nav.uk-navbar-container ul.navbar-scroll a:has(img) img {
    display: block;
    max-height: 40px;
    width: auto;
    margin-left: 10px; /* move logo 10px from left without breaking flex alignment */
}

  /* --- Mobile Menu Toggle (Hamburger) --- */
  #mobile-menu-toggle {
    display: flex;
    position: fixed;
    top: 12.5px;
    right: 10px;
    width: 40px;
    height: 40px;
    cursor: pointer;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    isolation: isolate;
    background: transparent;
  }

  #mobile-menu-toggle .bar {
    width: 30px;
    height: 2px;
    background-color: var(--navbar-link-color, #000);
    position: absolute;
    border-radius: 1px;
    transition: all 0.4s ease;
    z-index: 2;
  }

  #mobile-menu-toggle .bar1 { top: 12px; }
  #mobile-menu-toggle .bar2 { top: 22px; }

  #mobile-menu-toggle.open .bar1 {
    top: 50%;
    transform: translateY(-50%) rotate(45deg);
  }

  #mobile-menu-toggle.open .bar2 {
    top: 50%;
    transform: translateY(-50%) rotate(-45deg);
  }

  /* --- Mobile Menu Panel --- */
  #mobile-menu {
    display: none;
    position: fixed;
    top: 60px;
    left: 0;
    width: 100%;
    background-color: var(--navbar-bg-color, #fff);
    color: var(--navbar-text-color, #000);
    padding: 1rem 0;
    flex-direction: column;
    align-items: center;
    text-align: center;
    z-index: 9998;
  }

  #mobile-menu.show {
    display: flex;
  }

  #mobile-menu a {
    display: block;
    width: 100%;
    margin: 0.5rem 0;
    padding: 0.5rem 1.25rem;
    text-align: center;
    white-space: normal;
    word-break: break-word;
    overflow-wrap: break-word;
    color: var(--navbar-text-color, #000);
    text-decoration: none;
    background: transparent;
  }

  /* Hide logo in mobile menu (optional) */
  #mobile-menu .navbar-logo { display: none; }
}

/* ---------- Large screens: 1025px and above ---------- */
@media (min-width: 1025px) {
  #mobile-menu-toggle { display: none !important; }
  #mobile-menu { display: none !important; }

  /* Navbar container */
  #dynamic-navbar-container,
  nav.uk-navbar-container {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    width: 100%;
    min-height: 60px;
    background-color: var(--navbar-bg-color, #fff);
    position: relative;
    z-index: 1;
  }

  /* Navbar links visible */
  #dynamic-navbar-container ul.navbar-scroll a,
  nav.uk-navbar-container ul.navbar-scroll a {
    display: inline-block !important;
    visibility: visible !important;
    height: auto !important;
    margin: initial;
    padding: initial;
    text-decoration: none;
  }
}

#dynamic-navbar-container .navbar-scroll a:has(img) {
  text-decoration: none !important;
  border-bottom: none !important;
}

</style>
</head>
<body class="uk-background-muted" id="top">
<h1 id="site-title-h1" class="visually-hidden"></h1>
${mobileMenuHtml}
${navBarHtml}
${exportBlocks}
${buildFooterHtml()}
<script src="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/js/uikit.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/js/uikit-icons.min.js"><\/script>
<script>
// In preview: replace big data: URLs with cheap blob: URLs so Lightbox won't choke.
(function () {
function dataToBlobUrl(dataUrl) {
// Turn a data:image/... URL into a Blob URL
return fetch(dataUrl)
.then(r => r.blob())
.then(b => URL.createObjectURL(b));
}

document.addEventListener('DOMContentLoaded', async () => {
const anchors = Array.from(document.querySelectorAll('[uk-lightbox] a[href^="data:image/"]'));
for (const a of anchors) {
try {
// Tell UIkit these are images
a.setAttribute('data-type', 'image');
// Swap heavy data: → fast blob:
a.href = await dataToBlobUrl(a.href);
} catch (e) {
// Safety: block navigation if conversion fails
a.addEventListener('click', ev => ev.preventDefault(), { once: true, capture: true });
}
}
if (window.UIkit && UIkit.update) UIkit.update();
});

})();
<\/script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');

  // Detect navbar container dynamically
  let dynamicNavContainer = document.getElementById('dynamic-navbar-container');
  if (!dynamicNavContainer) {
    // fallback for Preview / Export
    dynamicNavContainer = document.querySelector('nav.uk-navbar-container');
  }
  if (!dynamicNavContainer) return; // no navbar found

  let menuBuilt = false;

  // Helpers
  const isSmallScreen = () => window.innerWidth <= 1024;
  const isMenuOpen = () => mobileMenu.classList.contains('show');

  const isNavbarEnabled = () => {
    // Editor: checkbox enabled
    const enableNavbarCheckbox = document.getElementById('enable-navbar');
    return enableNavbarCheckbox ? enableNavbarCheckbox.checked : true; // Preview: always enabled
  };

  // Populate mobile menu
  function populateMobileMenu(force = false) {
    if (!force && (menuBuilt || isMenuOpen())) return;

    const nav = dynamicNavContainer.querySelector('ul.navbar-scroll');
    if (!nav || !mobileMenu) return;

    // Update colors
    const navbarBg = getComputedStyle(nav.parentElement || nav).backgroundColor;
    const navbarText = getComputedStyle(nav).color;
    document.documentElement.style.setProperty('--navbar-bg-color', navbarBg);
    document.documentElement.style.setProperty('--navbar-text-color', navbarText);
    document.documentElement.style.setProperty('--navbar-link-color', navbarText);

    const fragment = document.createDocumentFragment();
    mobileMenu.innerHTML = '';

    nav.querySelectorAll('a').forEach(link => {
      const clone = link.cloneNode(true);
      clone.removeAttribute('id');

      clone.addEventListener('click', e => {
        e.stopPropagation();
        closeMobileMenu();
      });

      fragment.appendChild(clone);
    });

    mobileMenu.appendChild(fragment);
    menuBuilt = true;
  }

  // Open / Close Menu
  function openMobileMenu() {
    populateMobileMenu(true);
    mobileMenu.classList.add('show');
    mobileMenuToggle.classList.add('open');
    mobileMenu.setAttribute('aria-hidden', 'false');
  }

  function closeMobileMenu() {
    mobileMenu.classList.remove('show');
    mobileMenuToggle.classList.remove('open');
    mobileMenu.setAttribute('aria-hidden', 'true');
    setTimeout(() => {
      menuBuilt = false; // rebuild next time
    }, 350); // match CSS transition
  }

  // Update visibility
  function updateMobileMenuVisibility() {
    if (isNavbarEnabled() && isSmallScreen()) {
      mobileMenuToggle.style.display = 'flex';
    } else {
      mobileMenuToggle.style.display = 'none';
      closeMobileMenu();
    }
  }

  // MutationObserver to detect dynamic changes in navbar
  if (dynamicNavContainer) {
    const observer = new MutationObserver(() => {
      if (isMenuOpen()) return;
      menuBuilt = false;
      populateMobileMenu(true);
    });
    observer.observe(dynamicNavContainer, { childList: true, subtree: false });
  }

  // Events
  mobileMenuToggle.addEventListener('click', () => {
    isMenuOpen() ? closeMobileMenu() : openMobileMenu();
  });
  window.addEventListener('resize', updateMobileMenuVisibility);

  const enableNavbarCheckbox = document.getElementById('enable-navbar');
  enableNavbarCheckbox?.addEventListener('change', () => {
    menuBuilt = false;
    populateMobileMenu(true);
    updateMobileMenuVisibility();
  });

  // Initial setup
  populateMobileMenu(true);
  updateMobileMenuVisibility();
});



/* Preview helper: nudge Vimeo background iframes to start (some browsers are stricter in preview contexts). */
(function(){
  function kickVimeo(){
    document.querySelectorAll('iframe[src*="player.vimeo.com/video/"][src*="background=1"]').forEach(function(ifr){
      try{
        ifr.contentWindow && ifr.contentWindow.postMessage(JSON.stringify({method:'setVolume', value:0}), '*');
        ifr.contentWindow && ifr.contentWindow.postMessage(JSON.stringify({method:'play'}), '*');
      } catch(e){}
    });
  }
  window.addEventListener('load', function(){
    setTimeout(kickVimeo, 600);
    setTimeout(kickVimeo, 2000);
  });
})();

${globalNavLinksScript}
</body>
</html>
`;

// --- Inline custom CSS into preview HTML (so preview behaves like export) ---
if (siteSettings.customCSS && siteSettings.customCSS.trim()) {
  try {
    html = html.replace('</head>', `<style id="preview-custom-css">\n${siteSettings.customCSS}\n</style>\n</head>`);
  } catch (e) {
    console.warn('Failed to inline preview custom CSS', e);
  }
}

// Open preview via Blob URL instead of document.write.
// This gives the preview a real URL context (blob:), which improves third‑party iframe behavior (e.g., Vimeo background autoplay).
try {
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const w = window.open('about:blank', '_blank');
  if (w) {
    w.location.href = url;
    // Best effort cleanup (keep longer to avoid race with third‑party embeds)
    setTimeout(() => URL.revokeObjectURL(url), 10 * 60 * 1000);
  } else {
    // Popup blocked: fall back to opening directly
    window.open(url, "_blank");
    setTimeout(() => URL.revokeObjectURL(url), 10 * 60 * 1000);
  }
} catch (e) {
  // Fallback to previous behavior if Blob URLs are blocked
  let previewWindow = window.open("", "_blank");
  previewWindow.document.open();
  previewWindow.document.write(html);
  previewWindow.document.close();
}
});


// Export as HTML+media ZIP
async function doExportHTML(fileName) {
    const JSZip = window.JSZip;
    const zip = new JSZip();
    const exportMap = {};
    let promises = [];
    let fileIdx = 0;
    
    allSections.forEach((block, idx) => {
        if (block.fileData && block.fileName) {
            let ext = block.fileName.split('.').pop().toLowerCase();
            let newName = `mediafile${fileIdx + 1}.${ext}`;
            exportMap[block.fileName] = newName;
            promises.push(fetch(block.fileData).then(res => res.blob()).then(blob => {
                zip.file('media/' + newName, blob);
            }));
            fileIdx++;
        }

        // Slider items (images / mp4 uploads) -> /media
        if (block.type === 'slider' && Array.isArray(block.items)) {
            block.items.forEach((it) => {
                if (it && it.fileData && it.fileName) {
                    let ext = it.fileName.split('.').pop().toLowerCase();
                    let newName = `mediafile${fileIdx + 1}.${ext}`;
                    exportMap[it.fileName] = newName;
                    promises.push(fetch(it.fileData).then(res => res.blob()).then(blob => {
                        zip.file('media/' + newName, blob);
                    }));
                    fileIdx++;
                }
            });
        }
    });

// --- GALLERY: pull data:image files into /media and rewrite HTML ---
const galleryTasks = {}; // { [sectionIndex]: { raw, replacements[] } }

allSections.forEach((block, idx) => {
if (block.type !== 'gallery' || !block.html) return;

const raw = block.html;
const seen = new Set();
let counter = 0;
const replacements = [];
const rx = /(href|src)="(data:image\/[^"]+)"/g;
let m;

while ((m = rx.exec(raw)) !== null) {
const dataUrl = m[2];
if (seen.has(dataUrl)) continue;
seen.add(dataUrl);

// derive extension from MIME
const mimeMatch = dataUrl.match(/^data:([^;]+)/);
let ext = 'png';
if (mimeMatch && mimeMatch[1]) {
const mt = mimeMatch[1].toLowerCase();
ext = mt.endsWith('svg+xml') ? 'svg' : (mt.split('/')[1] || 'png');
if (ext === 'jpeg') ext = 'jpg';
}

const newName = `gallery${idx + 1}_img${++counter}.${ext}`;
replacements.push({ from: dataUrl, to: `media/${newName}` });

// queue file into the zip
promises.push(
fetch(dataUrl)
.then(r => r.blob())
.then(blob => zip.file(`media/${newName}`, blob))
);
}

galleryTasks[idx] = { raw, replacements };
});

// Include navbar logo in export (blob -> /media/logo.<ext>)
if (siteSettings.navbar.logoBlob && siteSettings.navbar.logoFileName) {
const ext = siteSettings.navbar.logoFileName.split('.').pop().toLowerCase() || 'png';
const newName = `logo.${ext}`;
zip.file('media/' + newName, siteSettings.navbar.logoBlob);
siteSettings.navbar.logoExport = 'media/' + newName;
}    

// Include favicon in export if uploaded
if (siteSettings.faviconBlob && siteSettings.faviconFileName) {
let ext = siteSettings.faviconFileName.split('.').pop().toLowerCase() || 'ico';
let newName = `favicon.${ext}`;
zip.file('media/' + newName, siteSettings.faviconBlob);
siteSettings.faviconExport = 'media/' + newName;
}

// Include social image in export if uploaded
if (siteSettings.socialBlob && siteSettings.socialFileName) {
let ext = siteSettings.socialFileName.split('.').pop().toLowerCase() || 'png';
let newName = `social.${ext}`;
zip.file('media/' + newName, siteSettings.socialBlob);
siteSettings.socialExport = 'media/' + newName;
}

await Promise.all(promises);

// --- Build per-gallery export HTML from recorded replacements ---
const galleryExportHtml = {};
Object.keys(galleryTasks).forEach(k => {
let out = galleryTasks[k].raw;
for (const rep of galleryTasks[k].replacements) {
// replace every occurrence of the data: URL with its media/ path
out = out.split(rep.from).join(rep.to);
}
galleryExportHtml[k] = out;
});

let exportBlocks = allSections.map((block, idx) => {
const inner = (block.type === 'gallery' && galleryExportHtml[idx])
? galleryExportHtml[idx]
: getExportSectionHtml(block, exportMap);
return `<section id="section-${idx}" class="uk-section uk-section-primary uk-flex uk-flex-middle uk-flex-center" uk-height-viewport="offset-top: true" style="background:${block.bgColor};min-height:60vh;padding:0;margin:0;">
${inner}
</section>`;
}).join('\n');

let navBarHtml = buildPreviewDynamicNavBarHtml();
const __glUrl = (siteSettings?.navbar?.globalLinksUrl || '').trim();
const globalNavLinksScript = (siteSettings?.navbar?.useGlobalLinks && __glUrl) ? `<script>
/* Global Custom Links loader (Dynamic Nav Bar) */
(function(){
  var URL_ = ${JSON.stringify(__glUrl)};
  if (!URL_) return;
  function normalize(data){
    var arr = Array.isArray(data) ? data : (data && Array.isArray(data.links) ? data.links : []);
    return arr.map(function(x){
      var title = String((x.title||x.label||x.text||'')||'').trim();
      var href = String((x.url||x.href||x.link||'')||'').trim();
      var newTab = !!(x.newTab || x.blank || x.target === '_blank');
      return {title:title, url:href, newTab:newTab};
    }).filter(function(x){ return x.title && x.url; });
  }
  function render(links){
    var nav = document.querySelector('nav.uk-navbar-container ul.navbar-scroll');
    if (!nav) return;
    nav.querySelectorAll('li[data-custom-link="1"]').forEach(function(el){ el.remove(); });
    links.forEach(function(lnk){
      var li=document.createElement('li');
      li.setAttribute('data-custom-link','1');
      var a=document.createElement('a');
      a.textContent=lnk.title;
      a.href=lnk.url;
      if (lnk.newTab) { a.target='_blank'; a.rel='noopener'; }
      li.appendChild(a);
      nav.appendChild(li);
    });
    try{ if (typeof window.__rebuildMobileMenu === 'function') window.__rebuildMobileMenu(); }catch(e){}
  }
  function fetchLinks(){
    var bust = (URL_.indexOf('?')>-1 ? '&' : '?') + 't=' + Date.now();
    return fetch(URL_ + bust, {cache:'no-store'})
      .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(normalize);
  }
  function refresh(){ fetchLinks().then(render).catch(function(){}); }
  window.addEventListener('load', function(){
    refresh();
    setInterval(refresh, 5*60*1000);
  });
})();
<\/script>` : '';

const mobileMenuHtml = (siteSettings?.navbar?.enabled)
  ? `
<!-- Mobile Menu (Preview/Export) -->
<div id="mobile-menu-toggle" aria-label="Toggle mobile menu">
  <div class="bar bar1"></div>
  <div class="bar bar2"></div>
</div>
<div id="mobile-menu" aria-hidden="true"></div>
<script>
(function(){
  var toggle = document.getElementById('mobile-menu-toggle');
  var menu = document.getElementById('mobile-menu');
  if (!toggle || !menu) return;

  function build(){
    var nav = document.querySelector('nav.uk-navbar-container ul.navbar-scroll');
    if (!nav) return;
    // Build a simple vertical menu from the navbar links
    var ul = document.createElement('ul');
    ul.className = 'uk-nav uk-nav-default';
    nav.querySelectorAll('li a').forEach(function(a){
      var li = document.createElement('li');
      var link = a.cloneNode(true);
      li.appendChild(link);
      ul.appendChild(li);
    });
    menu.innerHTML = '';
    menu.appendChild(ul);
  }

  function open(){
    build();
    menu.classList.add('show');
    menu.setAttribute('aria-hidden','false');
    toggle.classList.add('open');
  }
  function close(){
    menu.classList.remove('show');
    menu.setAttribute('aria-hidden','true');
    toggle.classList.remove('open');
  }
  function isOpen(){ return menu.classList.contains('show'); }

  toggle.addEventListener('click', function(){
    if (isOpen()) close(); else open();
  });

  // Close on link click
  menu.addEventListener('click', function(e){
    var a = e.target && e.target.closest && e.target.closest('a');
    if (a) close();
  });

  // Rebuild on load (and after global links refresh)
  window.addEventListener('load', function(){ build(); });

  // Close if resizing up
  window.addEventListener('resize', function(){
    if (window.innerWidth > 1024) close();
  });

  // Expose a tiny hook used by global-links loader (safe no-op elsewhere)
  window.__rebuildMobileMenu = build;
})();
<\/script>
`
  : '';

let html = `
<!DOCTYPE html>
<html lang="${siteSettings.language}">
<head>
<meta charset="UTF-8">
<title>${siteSettings.title}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="${siteSettings.description}">
<meta name="robots" content="${siteSettings.robots}">
<meta name="author" content="${siteSettings.author}">
`;

// Add font injection OUTSIDE the string
if (siteSettings.fontName) {
const fontUrl = `https://fonts.googleapis.com/css2?family=${siteSettings.fontName.replace(/ /g,'+')}&display=swap`;
html += `<link href="${fontUrl}" rel="stylesheet">\n`;
html += `<style>\n${generateFontCSS()}\n</style>\n`;
}

// Continue building string here
html += `
${siteSettings.faviconExport ? `<link rel="icon" href="${siteSettings.faviconExport}">\n  <link rel="shortcut icon" href="${siteSettings.faviconExport}">` : ''}
${siteSettings.socialExport ? `<meta property="og:image" content="${siteSettings.socialExport}">` : ''}
${siteSettings.headScript || ''}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/css/uikit.min.css" />
<style>
.live-paragraph { font-size: 1.13rem; max-width: 40em; margin-left:auto; margin-right:auto;}

/* Simple 3-size system for text blocks */
.live-heading.h-sm { font-size: 2.2rem; line-height: 1.15; }
.live-heading.h-md { font-size: 3.2rem; line-height: 1.12; }
.live-heading.h-lg { font-size: 4.2rem; line-height: 1.08; }

.live-subtitle.sub-sm { font-size: 1.1rem; font-weight: 500; }
.live-subtitle.sub-md { font-size: 1.35rem; font-weight: 500; }
.live-subtitle.sub-lg { font-size: 1.7rem; font-weight: 500; }

.live-paragraph.p-sm { font-size: 1.0rem; }
.live-paragraph.p-md { font-size: 1.13rem; }
.live-paragraph.p-lg { font-size: 1.30rem; }

@media (max-width: 640px) {
.live-heading.h-lg { font-size: 2.6rem; }
.live-heading.h-md { font-size: 2.0rem; }
.live-heading.h-sm { font-size: 1.6rem; }

.live-subtitle.sub-lg { font-size: 1.2rem; }
.live-subtitle.sub-md { font-size: 1.05rem; }
.live-subtitle.sub-sm { font-size: 0.95rem; }

.live-paragraph.p-lg { font-size: 1.05rem; }
.live-paragraph.p-md { font-size: 0.98rem; }
.live-paragraph.p-sm { font-size: 0.92rem; }
}

.live-paragraph.uk-text-large { font-size: 1.45rem; }
@media (max-width: 640px) {
.live-paragraph { font-size: 1rem;}
.live-paragraph.uk-text-large { font-size: 1.1rem;}
}
/* Make exported images/videos responsive */
img, video {
max-width: 100%;
height: auto;
display: block;
}

@media (max-width: 640px) {
.live-heading, .live-subtitle, .live-paragraph {
text-align: center !important;
word-break: break-word;
white-space: normal;
}
}
.navbar-scroll { display:flex; flex-wrap:nowrap; gap:1rem; overflow-x:auto; white-space:nowrap; -webkit-overflow-scrolling:touch; padding:0.5rem 1rem; align-items:center; list-style:none; margin:0; }
.navbar-scroll a { flex:0 0 auto; text-decoration:none; color:inherit; }
.navbar-scroll a.uk-active { font-weight:bold; border-bottom:2px solid currentColor; }
  
.navbar-logo {
height: 40px !important;
width: auto !important;
max-height: 40px !important;
object-fit: contain;
flex-shrink: 0 !important;
flex-grow: 0 !important;
}

.navbar-scroll {
display: flex;
flex-wrap: nowrap;
overflow-x: auto;
-webkit-overflow-scrolling: touch;
white-space: nowrap;
gap: 1rem;
padding: 0.5rem 1rem;
}
.navbar-scroll li {
flex: 0 0 auto;
list-style: none;
}

.visually-hidden {
position: absolute !important;
width: 1px; height: 1px;
margin: -1px; padding: 0; border: 0;
overflow: hidden; clip: rect(0 0 0 0); clip-path: inset(50%);
white-space: nowrap;
}

:root {
--navbar-link-color: #000000;
}

.navbar-scroll::-webkit-scrollbar {
height: 6px;
}
.navbar-scroll::-webkit-scrollbar-thumb {
background: var(--navbar-link-color);
border-radius: 3px;
}
.navbar-scroll::-webkit-scrollbar-track {
background: var(--gray, #eee);
}


.navbar-scroll {
-ms-overflow-style: none;  /* IE & Edge */
scrollbar-width: none;     /* Firefox */
}
.navbar-scroll::-webkit-scrollbar {
display: none;             /* Chrome, Safari, Opera */
}

/* ========================================================================
Button 
========================================================================== */

/* Primary Button */
.uk-button-primary {
background-color: #000;
color: #fff;
}

/* Primary Button Hover */
.uk-button-primary:hover {
background-color: #000;
color: #fff;
}

/* Primary Button Active */
.uk-button-primary:active,
.uk-button-primary.uk-active {
background-color: #000;
color: #fff;
}

/* Secondary Button */
.uk-button-secondary {
background-color: #000;
color: #fff;
border: 1px solid transparent;
}

/* Secondary Button Hover */
.uk-button-secondary:hover {
background-color: #fff;
color: #000;
}

/* Secondary Button Active */
.uk-button-secondary:active,
.uk-button-secondary.uk-active {
background-color: #000;
color: #fff;
}

/* Contextual Secondary Button Overrides for UIkit Sections/Cards/Overlay */
.uk-light .uk-button-secondary,
.uk-section-primary:not(.uk-preserve-color) .uk-button-secondary,
.uk-section-secondary:not(.uk-preserve-color) .uk-button-secondary,
.uk-tile-primary:not(.uk-preserve-color) .uk-button-secondary,
.uk-tile-secondary:not(.uk-preserve-color) .uk-button-secondary,
.uk-card-primary.uk-card-body .uk-button-secondary,
.uk-card-primary > :not([class*='uk-card-media']) .uk-button-secondary,
.uk-card-secondary.uk-card-body .uk-button-secondary,
.uk-card-secondary > :not([class*='uk-card-media']) .uk-button-secondary,
.uk-overlay-primary .uk-button-secondary,
.uk-offcanvas-bar .uk-button-secondary {
background-color: #000;
color: #fff;
}

/* ========================================================================
Links
========================================================================== */

.uk-link {
text-decoration: underline;
cursor: pointer;
}

.uk-link:hover,
.uk-link-toggle:hover .uk-link {
text-decoration: none;
}

/* ========================================================================
Lightbox
========================================================================== */

.uk-lightbox-button {
box-sizing: border-box;
width: 50px;
height: 50px;
background: rgba(0, 0, 0, 0.3);
color: rgba(255, 255, 255, 0.7);
border-radius: 100%;
/* 1 */
display: inline-flex;
justify-content: center;
align-items: center;
}

.uk-lightbox-iframe {
width: 90%;
height: 90%;
border: 0px solid black;
border-radius: 0; /* Default: no rounding for Chrome, Brave, etc. */
}

/* Safari-only override */
@supports (-webkit-hyphens: none) and (not (-moz-appearance: none)) {
.uk-lightbox-iframe {
border-radius: 25px;
}
}

.uk-lightbox-toolbar {
padding: 5px 5px;
background: transparent;
color: rgba(255, 255, 255, 0.7);
}
.uk-lightbox-toolbar > * {
color: rgba(255, 255, 255, 0.7);
}

.uk-lightbox-toolbar-icon {
box-sizing: border-box;
width: 50px;
height: 50px;
background: #000;
color: #fff;
border-radius: 100%;
/* 1 */
display: inline-flex;
justify-content: center;
align-items: center;
}

/* ===== keep only the close button always visible (preserve exact look) ===== */

/* wide selector to match common UIkit close button variants */
.uk-lightbox .uk-lightbox-button.uk-close,
.uk-lightbox .uk-lightbox-button.uk-close svg,
.uk-lightbox .uk-close,
.uk-lightbox [data-uk-close],
.uk-lightbox [data-uk-close] > * {
/* DO NOT change visual properties (width/height/background/color/border-radius/flex)
— we only override visibility/stacking/interaction and remove hide transforms. */
position: fixed !important;        /* remove from hidden parent so it stays visible */
top: 5px !important;               /* align with toolbar padding — preserves placement */
right: 5px !important;             /* align with toolbar padding */
z-index: 999999 !important;        /* above overlays */
display: inline-flex !important;   /* keep your inline-flex layout */
opacity: 0.7 !important;             /* force fully visible */
visibility: visible !important;    /* force visible */
pointer-events: auto !important;   /* clickable even if parent is disabled */
transform: none !important;        /* cancel hide transforms */
transition: none !important;       /* prevent fade-out transitions */
animation: none !important;        /* stop any hiding animations */
}

/* If UIkit sets helper classes, undo them for close only */
.uk-lightbox .uk-lightbox-button.uk-close.uk-hidden,
.uk-lightbox .uk-lightbox-button.uk-close.uk-invisible,
.uk-lightbox .uk-close.uk-hidden,
.uk-lightbox .uk-close.uk-invisible,
.uk-lightbox [data-uk-close].uk-hidden,
.uk-lightbox [data-uk-close].uk-invisible {
display: inline-flex !important;
opacity: 0.7 !important;
visibility: visible !important;
pointer-events: auto !important;
}

/* keep SVG/icon inside intact (do not change color/size) */
.uk-lightbox .uk-lightbox-button.uk-close svg,
.uk-lightbox .uk-close svg {
position: static !important;
width: auto !important;
height: auto !important;
}

/* mobile tweak to avoid overlap while preserving look (keeps same size) */
@media (max-width: 480px) {
.uk-lightbox .uk-lightbox-button.uk-close,
.uk-lightbox .uk-close,
.uk-lightbox [data-uk-close] {
top: 8px !important;
right: 8px !important;
}
}

/* ========================================================================
Slider
========================================================================== */

.uk-slidenav {
padding: 5px 10px;
color: rgba(102, 102, 102, 0.5);
transition: color 0.1s ease-in-out;
width: 50px;
height: 50px;
background: rgba(0, 0, 0, 0.3);
color: rgba(255, 255, 255, 0.7);
border-radius: 100%;
display: inline-flex;
justify-content: center;
align-items: center;

}

/* ========================================================================
Additional CSS:
========================================================================== */

html {
-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
}

button:focus,
button:active {
-moz-outline: 0 !important;
-ms-outline:0 !important;
-o-outline: 0 !important;
-webkit-outline: 0 !important;
}

.uk-border-rounded {
border-radius: 25px;
}

/* ============================
Dynamic Navbar & Mobile Menu
=========================== */

/* ---------- Mobile + Tablet: up to 1024px ---------- */
@media (max-width: 1024px) {

  /* --- Navbar container --- */
  #dynamic-navbar-container,
  nav.uk-navbar-container {
    display: flex;
    align-items: center;
    justify-content: flex-start; /* keep logo on left */
    width: 100%;
    min-height: 60px;
    background-color: var(--navbar-bg-color, #fff);
    position: relative;
    z-index: 1;
  }

  /* --- Navbar UL --- */
  #dynamic-navbar-container ul.navbar-scroll,
  nav.uk-navbar-container ul.navbar-scroll {
    display: flex;
    align-items: center;
    margin: 0;
    padding: 0;
  }

  /* --- Hide all text links, keep layout --- */
  #dynamic-navbar-container ul.navbar-scroll a:not(:has(img)),
  nav.uk-navbar-container ul.navbar-scroll a:not(:has(img)) {
    visibility: hidden;       /* hides but keeps space */
    pointer-events: none;     /* prevents clicks */
    height: 0;                /* optional: collapse vertical space */
    margin: 0;
    padding: 0;
  }

  /* --- Logo link visible --- */
  #dynamic-navbar-container ul.navbar-scroll a:has(img),
  nav.uk-navbar-container ul.navbar-scroll a:has(img) {
    visibility: visible;
    pointer-events: auto;
  }

  /* --- Logo image styling --- */
  #dynamic-navbar-container ul.navbar-scroll a:has(img) img,
  nav.uk-navbar-container ul.navbar-scroll a:has(img) img {
    display: block;
    max-height: 40px;
    width: auto;
  }

/* --- Logo image spacing --- */
#dynamic-navbar-container ul.navbar-scroll a:has(img) img,
nav.uk-navbar-container ul.navbar-scroll a:has(img) img {
    display: block;
    max-height: 40px;
    width: auto;
    margin-left: 10px; /* move logo 10px from left without breaking flex alignment */
}

  /* --- Mobile Menu Toggle (Hamburger) --- */
  #mobile-menu-toggle {
    display: flex;
    position: fixed;
    top: 12.5px;
    right: 10px;
    width: 40px;
    height: 40px;
    cursor: pointer;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    isolation: isolate;
    background: transparent;
  }

  #mobile-menu-toggle .bar {
    width: 30px;
    height: 2px;
    background-color: var(--navbar-link-color, #000);
    position: absolute;
    border-radius: 1px;
    transition: all 0.4s ease;
    z-index: 2;
  }

  #mobile-menu-toggle .bar1 { top: 12px; }
  #mobile-menu-toggle .bar2 { top: 22px; }

  #mobile-menu-toggle.open .bar1 {
    top: 50%;
    transform: translateY(-50%) rotate(45deg);
  }

  #mobile-menu-toggle.open .bar2 {
    top: 50%;
    transform: translateY(-50%) rotate(-45deg);
  }

  /* --- Mobile Menu Panel --- */
  #mobile-menu {
    display: none;
    position: fixed;
    top: 60px;
    left: 0;
    width: 100%;
    background-color: var(--navbar-bg-color, #fff);
    color: var(--navbar-text-color, #000);
    padding: 1rem 0;
    flex-direction: column;
    align-items: center;
    text-align: center;
    z-index: 9998;
  }

  #mobile-menu.show {
    display: flex;
  }

  #mobile-menu a {
    display: block;
    width: 100%;
    margin: 0.5rem 0;
    padding: 0.5rem 1.25rem;
    text-align: center;
    white-space: normal;
    word-break: break-word;
    overflow-wrap: break-word;
    color: var(--navbar-text-color, #000);
    text-decoration: none;
    background: transparent;
  }

  /* Hide logo in mobile menu (optional) */
  #mobile-menu .navbar-logo { display: none; }
}

/* ---------- Large screens: 1025px and above ---------- */
@media (min-width: 1025px) {
  #mobile-menu-toggle { display: none !important; }
  #mobile-menu { display: none !important; }

  /* Navbar container */
  #dynamic-navbar-container,
  nav.uk-navbar-container {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    width: 100%;
    min-height: 60px;
    background-color: var(--navbar-bg-color, #fff);
    position: relative;
    z-index: 1;
  }

  /* Navbar links visible */
  #dynamic-navbar-container ul.navbar-scroll a,
  nav.uk-navbar-container ul.navbar-scroll a {
    display: inline-block !important;
    visibility: visible !important;
    height: auto !important;
    margin: initial;
    padding: initial;
    text-decoration: none;
  }
}

#dynamic-navbar-container .navbar-scroll a:has(img) {
  text-decoration: none !important;
  border-bottom: none !important;
}

</style>


`;

// ---------- ADD: ensure exported head includes the font link and generated font CSS ----------
const fontLinkEl = document.getElementById('custom-font-link');
const fontLinkHtml = fontLinkEl ? fontLinkEl.outerHTML : '';
const fontCSS = `<style id="export-font-css">${generateFontCSS() || ''}</style>`;

// insert fontLinkHtml and fontCSS into exported head (before custom CSS injection block)
if (fontLinkHtml) {
  html += fontLinkHtml + '\n';
}
html += fontCSS + '\n';
// ---------- END ADD ----------

// ← Insert here: user custom CSS
if (siteSettings.customCSS && siteSettings.customCSS.trim()) {
html += `<style id="export-custom-css">\n${siteSettings.customCSS}\n</style>\n`;
}

html += `

</head>
<body class="uk-background-muted" id="top">
<h1 id="site-title-h1" class="visually-hidden">${siteSettings.title}</h1>
${mobileMenuHtml}
${navBarHtml}
${exportBlocks}
${buildFooterHtml()}
<script src="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/js/uikit.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/js/uikit-icons.min.js"><\/script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');

  // Detect navbar container dynamically
  let dynamicNavContainer = document.getElementById('dynamic-navbar-container');
  if (!dynamicNavContainer) {
    // fallback for Preview / Export
    dynamicNavContainer = document.querySelector('nav.uk-navbar-container');
  }
  if (!dynamicNavContainer) return; // no navbar found

  let menuBuilt = false;

  // Helpers
  const isSmallScreen = () => window.innerWidth <= 1024;
  const isMenuOpen = () => mobileMenu.classList.contains('show');

  const isNavbarEnabled = () => {
    // Editor: checkbox enabled
    const enableNavbarCheckbox = document.getElementById('enable-navbar');
    return enableNavbarCheckbox ? enableNavbarCheckbox.checked : true; // Preview: always enabled
  };

  // Populate mobile menu
  function populateMobileMenu(force = false) {
    if (!force && (menuBuilt || isMenuOpen())) return;

    const nav = dynamicNavContainer.querySelector('ul.navbar-scroll');
    if (!nav || !mobileMenu) return;

    // Update colors
    const navbarBg = getComputedStyle(nav.parentElement || nav).backgroundColor;
    const navbarText = getComputedStyle(nav).color;
    document.documentElement.style.setProperty('--navbar-bg-color', navbarBg);
    document.documentElement.style.setProperty('--navbar-text-color', navbarText);
    document.documentElement.style.setProperty('--navbar-link-color', navbarText);

    const fragment = document.createDocumentFragment();
    mobileMenu.innerHTML = '';

    nav.querySelectorAll('a').forEach(link => {
      const clone = link.cloneNode(true);
      clone.removeAttribute('id');

      clone.addEventListener('click', e => {
        e.stopPropagation();
        closeMobileMenu();
      });

      fragment.appendChild(clone);
    });

    mobileMenu.appendChild(fragment);
    menuBuilt = true;
  }

  // Open / Close Menu
  function openMobileMenu() {
    populateMobileMenu(true);
    mobileMenu.classList.add('show');
    mobileMenuToggle.classList.add('open');
    mobileMenu.setAttribute('aria-hidden', 'false');
  }

  function closeMobileMenu() {
    mobileMenu.classList.remove('show');
    mobileMenuToggle.classList.remove('open');
    mobileMenu.setAttribute('aria-hidden', 'true');
    setTimeout(() => {
      menuBuilt = false; // rebuild next time
    }, 350); // match CSS transition
  }

  // Update visibility
  function updateMobileMenuVisibility() {
    if (isNavbarEnabled() && isSmallScreen()) {
      mobileMenuToggle.style.display = 'flex';
    } else {
      mobileMenuToggle.style.display = 'none';
      closeMobileMenu();
    }
  }

  // MutationObserver to detect dynamic changes in navbar
  if (dynamicNavContainer) {
    const observer = new MutationObserver(() => {
      if (isMenuOpen()) return;
      menuBuilt = false;
      populateMobileMenu(true);
    });
    observer.observe(dynamicNavContainer, { childList: true, subtree: false });
  }

  // Events
  mobileMenuToggle.addEventListener('click', () => {
    isMenuOpen() ? closeMobileMenu() : openMobileMenu();
  });
  window.addEventListener('resize', updateMobileMenuVisibility);

  const enableNavbarCheckbox = document.getElementById('enable-navbar');
  enableNavbarCheckbox?.addEventListener('change', () => {
    menuBuilt = false;
    populateMobileMenu(true);
    updateMobileMenuVisibility();
  });

  // Initial setup
  populateMobileMenu(true);
  updateMobileMenuVisibility();
});
<\/script>
${globalNavLinksScript}
</body>
</html>
`;

zip.file('index.html', html);

const blob = await zip.generateAsync({ type: "blob" });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = fileName.endsWith(".zip") ? fileName : fileName + ".zip";
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
} 

// UIKit tooltips
UIkit.util.on(document, 'DOMContentLoaded', function() {
UIkit.tooltip('[uk-tooltip]');
});

    
function formatText(command) {
document.execCommand(command, false, null);
}

function addLink() {
const sel = window.getSelection();
if (!sel.rangeCount || sel.toString().length === 0) {
alert("Please select some text first.");
return;
}

const url = prompt("Enter the link URL:", "https://");
if (!url) return;

const range = sel.getRangeAt(0);

// Extract the selected fragment so we preserve inline styles
const fragment = range.extractContents();

// Create anchor and set attributes
const a = document.createElement('a');
a.href = url;
a.target = "_blank";
a.classList.add('uk-link'); // keep your class for styling/behavior if needed

// Instead of a fixed color, use 'currentColor' to inherit text color dynamically
a.style.color = 'currentColor';

// Append the preserved fragment (keeps nested tags/formatting)
a.appendChild(fragment);

// Insert the anchor back into the document at the original range position
range.insertNode(a);

// Move caret to just after the inserted link
const newRange = document.createRange();
newRange.setStartAfter(a);
newRange.collapse(true);
sel.removeAllRanges();
sel.addRange(newRange);
}

function createYouTubeEmbed(url) {
const match = url.match(/(?:youtu\.be\/|youtube\.com\/watch\?v=)([^&]+)/);
if (match) {
const videoId = match[1];
return `
<div style="display:flex; align-items:center; justify-content:center; width:100%; height:100dvh; background:#000;">
<div style="position:relative; width:100%; max-width:100%; aspect-ratio:16/9; min-height:100dvh;">
<iframe src="https://www.youtube.com/embed/${videoId}?rel=0&playsinline=1" 
style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;" 
allow="autoplay; fullscreen; picture-in-picture" 
allowfullscreen 
loading="lazy"></iframe>
</div>
</div>`;
}
return "<p>Invalid YouTube URL</p>";
}

function createVimeoEmbed(url) {
const match = url.match(/vimeo\.com\/(\d+)/);
if (match) {
const videoId = match[1];
return `
<div style="display:flex; align-items:center; justify-content:center; width:100%; height:100dvh; background:#000;">
<div style="position:relative; width:100%; max-width:100%; aspect-ratio:16/9; min-height:100dvh;">
<iframe src="https://player.vimeo.com/video/${videoId}?playsinline=1" 
style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;" 
allow="autoplay; fullscreen; picture-in-picture" 
allowfullscreen 
loading="lazy"></iframe>
</div>
</div>`;
}
return "<p>Invalid Vimeo URL</p>";
}


/* =========================================================
   YouTube/Vimeo background autoplay (muted) support
   - Used by the Add Video modal for background-style sections
   ========================================================= */
let __pendingProviderVideo = null; // { provider:'youtube'|'vimeo', mode:'bg', base:{...} }

function extractYouTubeId(url) {
  if (!url) return null;
  const u = url.trim();
  const patterns = [
    /(?:youtu\.be\/)([\w-]{11})/i,
    /(?:youtube\.com\/watch\?v=)([\w-]{11})/i,
    /(?:youtube\.com\/embed\/)([\w-]{11})/i,
    /(?:youtube\.com\/shorts\/)([\w-]{11})/i
  ];
  for (const p of patterns) {
    const m = u.match(p);
    if (m && m[1]) return m[1];
  }
  // fall back: v= param
  const vm = u.match(/[?&]v=([\w-]{11})/i);
  return vm ? vm[1] : null;
}

function extractVimeoId(url) {
  if (!url) return null;
  const u = url.trim();
  // Matches vimeo.com/123, vimeo.com/video/123, player.vimeo.com/video/123
  const m = u.match(/vimeo\.com\/(?:video\/)?(\d+)/i) || u.match(/player\.vimeo\.com\/video\/(\d+)/i);
  return m ? m[1] : null;
}

function makeYouTubeBgSrc(id) {
  // loop hack requires playlist=id
  const params = new URLSearchParams({
    autoplay: '1',
    mute: '1',
    controls: '0',
    loop: '1',
    playlist: id,
    playsinline: '1',
    rel: '0',
    modestbranding: '1'
  });
  return `https://www.youtube.com/embed/${id}?${params.toString()}`;
}

function makeVimeoBgSrc(id) {
  const params = new URLSearchParams({
    background: '1',
    autoplay: '1',
    muted: '1',
    playsinline: '1',
    loop: '1',
    byline: '0',
    title: '0',
    portrait: '0'
  });
  return `https://player.vimeo.com/video/${id}?${params.toString()}`;
}

function __captureMediaFormBase() {
  // Capture current values from the Media modal (so BG provider videos keep the same section styling/options)
  const idx = sectionIndex.value ? parseInt(sectionIndex.value) : null;
  return {
    idx,
    mediaSize: mediaSize.value,
    bgColor: bgColor.value || '#000000',
    heading: mediaHeading.value || '',
    headingColor: mediaColor.value || '#ffffff',
    headingSize: headingSize.value || 'uk-heading-2xlarge',
    btnLabel: btnLabel.value.trim(),
    btnUrl: btnUrl.value.trim(),
    btnColor: btnColor.value,
    subtitle: mediaSubtitle.value || '',
    subtitleSize: subtitleSize.value || 'uk-heading-medium',
    subtitleColor: subtitleColor.value || '#ffffff',
    paragraph: mediaParagraph.value || '',
    paragraphSize: paragraphSize.value || '',
    paragraphColor: paragraphColor.value || '#ffffff'
  };
}

function __genSectionId() {
  return 'sec-' + Math.random().toString(36).substr(2, 9);
}

function __upsertProviderVideoBlock(provider, url, base) {
  const idx = (base && base.idx !== null && !Number.isNaN(base.idx)) ? base.idx : null;
  const existingId = (idx !== null && allSections[idx]) ? allSections[idx].id : __genSectionId();

  const ytId = provider === 'youtube' ? extractYouTubeId(url) : null;
  const vmId = provider === 'vimeo' ? extractVimeoId(url) : null;
  const videoId = ytId || vmId;

  if (!videoId) {
    UIkit.notification({message: 'Invalid ' + provider + ' link. Please paste a valid URL.', status: 'warning'});
    return;
  }

  const block = {
    id: existingId,
    type: 'video',
    provider,
    videoId,
    src: '',
    url: url || '',
    heading: base.heading,
    headingColor: base.headingColor,
    headingSize: base.headingSize,
    bgColor: base.bgColor,
    mediaSize: base.mediaSize,
    btnLabel: base.btnLabel,
    btnUrl: base.btnUrl,
    btnColor: base.btnColor,
    subtitle: base.subtitle,
    subtitleSize: base.subtitleSize,
    subtitleColor: base.subtitleColor,
    paragraph: base.paragraph,
    paragraphSize: base.paragraphSize,
    paragraphColor: base.paragraphColor
  };

  if (idx !== null && allSections[idx]) allSections[idx] = block;
  else allSections.push(block);

  renderAllSections();
  applyFontLink();
  applyCustomCSS();

  // close modals cleanly
  try { UIkit.modal('#youtube-modal').hide(); } catch {}
  try { UIkit.modal('#vimeo-modal').hide(); } catch {}
  try { mediaModal.hide(); } catch {}

  // scroll to updated/new section
  const targetIdx = (idx !== null && allSections[idx]) ? idx : (allSections.length - 1);
  setTimeout(() => {
    const root = document.getElementById('live-editor-root');
    if (root && root.children[targetIdx]) scrollToSection(targetIdx);
  }, 50);
}

function promptYouTubeBg() {
  __pendingProviderVideo = { provider: 'youtube', mode: 'bg', base: __captureMediaFormBase() };
  promptYouTube();
}

function promptVimeoBg() {
  __pendingProviderVideo = { provider: 'vimeo', mode: 'bg', base: __captureMediaFormBase() };
  promptVimeo();
}

function promptYouTube() {
  try {
    const input = document.getElementById('youtube-input');
    if (input) input.value = '';

    const modal = UIkit.modal('#youtube-modal');
    if (modal) modal.show();
  } catch (err) {
    const url = window.prompt("Enter YouTube link:");
    if (url) addYouTubeEmbed(url);
  }
}

function promptVimeo() {
  try {
    const input = document.getElementById('vimeo-input');
    if (input) input.value = '';

    const modal = UIkit.modal('#vimeo-modal');
    if (modal) modal.show();
  } catch (err) {
    const url = window.prompt("Enter Vimeo link:");
    if (url) addVimeoEmbed(url);
  }
}

// --- helper functions ---
function addYouTubeEmbed(url) {
  let block = {
    type: 'embed',
    code: createYouTubeEmbed(url),
    bgColor: '#000'
  };
  allSections.push(block);
  renderAllSections();
  applyFontLink();
  applyCustomCSS();
  mediaModal.hide();
}

function addVimeoEmbed(url) {
  let block = {
    type: 'embed',
    code: createVimeoEmbed(url),
    bgColor: '#000'
  };
  allSections.push(block);
  renderAllSections();
  applyFontLink();
  applyCustomCSS();
  mediaModal.hide();
}

// --- handle form submissions ---
document.getElementById('youtube-form').addEventListener('submit', function (e) {
  e.preventDefault();
  const url = document.getElementById('youtube-input').value.trim();
  if (!url) return;

  // If user chose "BG autoplay" from the Add Video modal, create a provider-backed VIDEO section
  if (__pendingProviderVideo && __pendingProviderVideo.provider === 'youtube' && __pendingProviderVideo.mode === 'bg') {
    __upsertProviderVideoBlock('youtube', url, __pendingProviderVideo.base);
    __pendingProviderVideo = null;
    return;
  }

  // Default: normal embed section (no autoplay)
  addYouTubeEmbed(url);
  UIkit.modal('#youtube-modal').hide();
});

document.getElementById('vimeo-form').addEventListener('submit', function (e) {
  e.preventDefault();
  const url = document.getElementById('vimeo-input').value.trim();
  if (!url) return;

  if (__pendingProviderVideo && __pendingProviderVideo.provider === 'vimeo' && __pendingProviderVideo.mode === 'bg') {
    __upsertProviderVideoBlock('vimeo', url, __pendingProviderVideo.base);
    __pendingProviderVideo = null;
    return;
  }

  addVimeoEmbed(url);
  UIkit.modal('#vimeo-modal').hide();
});


/* =========================================================
   FAQ Builder (sortable + drag/drop)
   ========================================================= */
const addFaqBtn = document.getElementById('addFaqBtn');
const faqModal = UIkit.modal('#faq-modal');
const faqForm = document.getElementById('faq-form');
const faqIndex = document.getElementById('faq-index');
const faqModalTitle = document.getElementById('faq-modal-title');
const faqTitleInput = document.getElementById('faq-title');
const faqBgColor = document.getElementById('faq-bgcolor');
const faqTextColor = document.getElementById('faq-textcolor');
const faqMultiple = document.getElementById('faq-multiple');
const faqOpenFirst = document.getElementById('faq-open-first');
const faqItemsList = document.getElementById('faq-items');
const faqAddItemBtn = document.getElementById('faq-add-item');
const faqSortAzBtn = document.getElementById('faq-sort-az');
const faqSortZaBtn = document.getElementById('faq-sort-za');

function escapeHtml(str) {
  return String(str || '').replace(/[&<>"']/g, s => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[s]));
}

function faqDefaultItem() {
  return { q: '', a: '' };
}

function faqRenderItems(items) {
  if (!faqItemsList) return;
  faqItemsList.innerHTML = '';

  (items || []).forEach((item) => {
    const li = document.createElement('li');
    li.className = 'faq-item';

    li.innerHTML = `
      <div class="uk-card uk-card-default uk-border-rounded faq-item-card">
        <div class="uk-grid-small uk-flex-middle" uk-grid>
          <div class="uk-width-auto">
            <span class="uk-icon-button uk-border-rounded faq-handle" uk-icon="menu" uk-tooltip="Drag to reorder"></span>
          </div>
          <div class="uk-width-expand">
            <div class="uk-margin-small">
              <label class="uk-form-label">Question</label>
              <input class="uk-input uk-border-rounded faq-q" type="text" placeholder="Question" value="${escapeHtml(item?.q || '')}">
            </div>
            <div class="uk-margin-small">
              <label class="uk-form-label">Answer</label>
              <textarea class="uk-textarea uk-border-rounded faq-a" rows="3" placeholder="Answer">${escapeHtml(item?.a || '')}</textarea>
            </div>
          </div>
          <div class="uk-width-auto">
            <button class="uk-button uk-button-danger uk-border-rounded faq-remove" type="button" uk-tooltip="Remove item" aria-label="Remove item">
              <span uk-icon="trash"></span>
            </button>
          </div>
        </div>
      </div>
    `;

    li.querySelector('.faq-remove')?.addEventListener('click', (e) => {
      e.preventDefault();
      li.remove();
      UIkit.update(faqItemsList);
    });

    faqItemsList.appendChild(li);
  });

  UIkit.update(faqItemsList);
}

function faqCollectItemsFromDom(includeEmpty = false) {
  if (!faqItemsList) return [];
  const items = [];
  Array.from(faqItemsList.children).forEach(li => {
    const q = li.querySelector('.faq-q')?.value?.trim() || '';
    const a = li.querySelector('.faq-a')?.value?.trim() || '';
    if (includeEmpty || q || a) items.push({ q, a });
  });
  return items;
}

function faqSortDom(direction) {
  const items = faqCollectItemsFromDom();
  items.sort((x, y) => (x.q || '').localeCompare(y.q || '', undefined, { sensitivity: 'base' }));
  if (direction === 'desc') items.reverse();
  faqRenderItems(items);
}

function openFaqModal(block, idx) {
  // Defaults
  faqIndex.value = (idx !== undefined && idx !== null) ? idx : '';
  faqTitleInput.value = block?.title || 'Frequently Asked Questions';
  faqBgColor.value = block?.bgColor || '#ffffff';
  faqTextColor.value = block?.textColor || '#000000';
  faqMultiple.checked = !!block?.multiple;
  faqOpenFirst.checked = (block?.openFirst !== undefined) ? !!block.openFirst : true;

  faqModalTitle.textContent = (idx !== undefined && idx !== null) ? 'Edit FAQ' : 'Add FAQ';

  faqRenderItems((block && Array.isArray(block.items)) ? block.items : [faqDefaultItem(), faqDefaultItem()]);

  applyLastColorsToContainer('#faq-modal');
  faqModal.show();
}

if (addFaqBtn) {
  addFaqBtn.addEventListener('click', () => openFaqModal(null, null));
}

if (faqAddItemBtn) {
  faqAddItemBtn.addEventListener('click', () => {
    const items = faqCollectItemsFromDom(true);
    items.push(faqDefaultItem());
    faqRenderItems(items);
  });
}

faqSortAzBtn?.addEventListener('click', () => faqSortDom('asc'));
faqSortZaBtn?.addEventListener('click', () => faqSortDom('desc'));

faqForm?.addEventListener('submit', (e) => {
  e.preventDefault();

  const items = faqCollectItemsFromDom();
  if (!items.length) {
    UIkit.notification({ message: 'Add at least one <b>Q&amp;A</b>.', status: 'warning' });
    return;
  }

  let idx = parseInt(faqIndex.value, 10);
  if (isNaN(idx)) idx = null;

  const genId = () => 'sec-' + Math.random().toString(36).substr(2, 9);

  const block = {
    id: (idx !== null && allSections[idx]) ? allSections[idx].id : genId(),
    type: 'faq',
    title: faqTitleInput.value.trim() || 'Frequently Asked Questions',
    bgColor: faqBgColor.value || '#ffffff',
    textColor: faqTextColor.value || '#000000',
    multiple: !!faqMultiple.checked,
    openFirst: !!faqOpenFirst.checked,
    items
  };

  if (idx !== null) allSections[idx] = block;
  else { allSections.push(block); idx = allSections.length - 1; }

  renderAllSections();
  applyFontLink();
  applyCustomCSS();

  faqModal.hide();

  setTimeout(() => {
    if (!Number.isNaN(idx) && document.getElementById('live-editor-root')?.children[idx]) {
      scrollToSection(idx);
    } else {
      const root = document.getElementById('live-editor-root');
      if (root && root.children.length) scrollToSection(root.children.length - 1);
    }
  }, 50);
});

/* ---------- Rendering helpers (editor/preview/export) ---------- */
function getFaqInnerHtml(block) {
  const title = escapeHtml(block?.title || '');
  const items = Array.isArray(block?.items) ? block.items : [];
  const textColor = block?.textColor || '#000000';
  const multiple = !!block?.multiple;
  const openFirst = (block?.openFirst !== undefined) ? !!block.openFirst : true;

  const lis = items.map((it, i) => {
    const q = escapeHtml(it?.q || '');
    const a = escapeHtml(it?.a || '').replace(/\n/g, '<br>');
    const openCls = (openFirst && i === 0) ? ' class="uk-open"' : '';
    return `
      <li${openCls}>
        <a class="uk-accordion-title" href="#" style="color:${textColor};"><span uk-icon="plus" class="uk-margin-small-right"></span>${q || 'Question'}</a>
        <div class="uk-accordion-content" style="color:${textColor};">
          <p class="live-paragraph p-md" style="color:${textColor};">${a || ''}</p>
        </div>
      </li>
    `;
  }).join('');

  return `
    <div class="uk-container uk-container-small uk-padding-large">
      ${title ? `<h2 class="live-heading h-md" style="color:${textColor};">${title}</h2>` : ''}
      <ul class="uk-accordion uk-margin-medium-top" uk-accordion="multiple: ${multiple}">
        ${lis}
      </ul>
    </div>
  `;
}

/* =========================================================
   Slider Builder (UIkit slider + sortable + drag/drop)
   ========================================================= */
const addSliderBtn = document.getElementById('addSliderBtn');
const sliderModal = UIkit.modal('#slider-modal');
const sliderForm = document.getElementById('slider-form');
const sliderIndex = document.getElementById('slider-index');
const sliderModalTitle = document.getElementById('slider-modal-title');
const sliderTitleInput = document.getElementById('slider-title');
const sliderBgColor = document.getElementById('slider-bgcolor');
const sliderTextColor = document.getElementById('slider-textcolor');
const sliderAutoplay = document.getElementById('slider-autoplay');
const sliderInterval = document.getElementById('slider-interval');
const sliderDots = document.getElementById('slider-dots');
const sliderArrows = document.getElementById('slider-arrows');
const sliderFinite = document.getElementById('slider-finite');
const sliderItemsList = document.getElementById('slider-items');
const sliderAddItemBtn = document.getElementById('slider-add-item');
const sliderSortAzBtn = document.getElementById('slider-sort-az');
const sliderSortZaBtn = document.getElementById('slider-sort-za');

function sliderDefaultItem() {
  return { kind: 'image', caption: '', src: '', url: '', fileData: '', fileName: '' };
}

function sliderGuessKindFromUrl(u) {
  const url = String(u || '').trim();
  if (!url) return 'image';
  if (/youtu\.be\/|youtube\.com\/watch|youtube\.com\/embed/.test(url)) return 'youtube';
  if (/vimeo\.com\/|player\.vimeo\.com\/video/.test(url)) return 'vimeo';
  if (/\.(mp4|webm|ogg)(\?|#|$)/i.test(url)) return 'video';
  if (/\.(png|jpe?g|gif|webp|svg)(\?|#|$)/i.test(url)) return 'image';
  return 'image';
}

function sliderRenderItems(items) {
  if (!sliderItemsList) return;
  sliderItemsList.innerHTML = '';

  (items || []).forEach((item) => {
    const li = document.createElement('li');
    li.className = 'slider-item';

    const kind = item?.kind || 'image';
    const caption = item?.caption || '';
    const urlVal = item?.url || '';
    const srcVal = item?.src || '';
    const hasUpload = !!(item?.fileData && item?.fileName);
    const previewSrc = hasUpload ? item.fileData : (kind === 'image' ? (srcVal || urlVal) : '');

    const thumbHtml = (() => {
      if (kind === 'image' && previewSrc) return `<img class="slider-thumb" src="${escapeHtml(previewSrc)}" alt="thumb">`;
      if ((kind === 'video' || kind === 'youtube' || kind === 'vimeo') && (urlVal || srcVal || hasUpload)) return `<div class="uk-flex uk-flex-middle uk-flex-center" style="width:84px;height:54px;"><span uk-icon="play-circle"></span></div>`;
      return `<div class="uk-flex uk-flex-middle uk-flex-center" style="width:84px;height:54px;"><span uk-icon="image"></span></div>`;
    })();

    li.innerHTML = `
      <div class="uk-card uk-card-default uk-border-rounded slider-item-card">
        <div class="uk-grid-small uk-flex-middle" uk-grid>
          <div class="uk-width-auto">
            <span class="uk-icon-button uk-border-rounded slider-handle" uk-icon="menu" uk-tooltip="Drag to reorder"></span>
          </div>

          <div class="uk-width-auto">
            <div class="slider-thumb-wrap">${thumbHtml}</div>
          </div>

          <div class="uk-width-expand">
            <div class="uk-grid-small" uk-grid>
              <div class="uk-width-1-3@s">
                <label class="uk-form-label">Type</label>
                <select class="uk-select uk-border-rounded slider-kind">
                  <option value="image" ${kind === 'image' ? 'selected' : ''}>Image</option>
                  <option value="video" ${kind === 'video' ? 'selected' : ''}>Video (MP4/WebM)</option>
                  <option value="youtube" ${kind === 'youtube' ? 'selected' : ''}>YouTube</option>
                  <option value="vimeo" ${kind === 'vimeo' ? 'selected' : ''}>Vimeo</option>
                </select>
              </div>
              <div class="uk-width-2-3@s">
                <label class="uk-form-label">Caption (optional)</label>
                <input class="uk-input uk-border-rounded slider-caption" type="text" placeholder="Short caption" value="${escapeHtml(caption)}">
              </div>
            </div>

            <div class="uk-grid-small uk-margin-small" uk-grid>
              <div class="uk-width-1-2@s">
                <label class="uk-form-label">URL (for Image/Video/YouTube/Vimeo)</label>
                <input class="uk-input uk-border-rounded slider-url" type="url" placeholder="https://..." value="${escapeHtml(urlVal)}">
                <div class="uk-text-meta uk-margin-small-top">Tip: paste a YouTube/Vimeo link and we’ll auto-detect.</div>
              </div>
              <div class="uk-width-1-2@s">
                <label class="uk-form-label">Upload (Image or MP4/WebM)</label>
                <input class="uk-input uk-border-rounded slider-file" type="file" accept="image/*,video/mp4,video/webm,video/ogg">
                <div class="uk-text-meta uk-margin-small-top slider-filemeta">
                  ${hasUpload ? `Uploaded: <b>${escapeHtml(item.fileName)}</b>` : 'No file uploaded'}
                </div>
                <input type="hidden" class="slider-filedata" value="${escapeHtml(item?.fileData || '')}">
                <input type="hidden" class="slider-filename" value="${escapeHtml(item?.fileName || '')}">
              </div>
            </div>
          </div>

          <div class="uk-width-auto">
            <button class="uk-button uk-button-danger uk-border-rounded slider-remove" type="button" uk-tooltip="Remove slide" aria-label="Remove slide">
              <span uk-icon="trash"></span>
            </button>
          </div>
        </div>
      </div>
    `;

    const kindEl = li.querySelector('.slider-kind');
    const urlEl = li.querySelector('.slider-url');
    const fileEl = li.querySelector('.slider-file');
    const fileDataEl = li.querySelector('.slider-filedata');
    const fileNameEl = li.querySelector('.slider-filename');
    const fileMetaEl = li.querySelector('.slider-filemeta');

    kindEl?.addEventListener('change', () => {
      // update thumbnail icon (lightweight refresh)
      UIkit.update(sliderItemsList);
    });

    urlEl?.addEventListener('input', () => {
      const guess = sliderGuessKindFromUrl(urlEl.value);
      // Only auto-switch if current kind is image/video and guess is youtube/vimeo or video
      if (guess && ['youtube','vimeo','video','image'].includes(guess)) {
        // don't force if user picked explicitly; but if they still have default-ish selection, help them
        if (['image','video'].includes(kindEl.value) && (guess === 'youtube' || guess === 'vimeo')) kindEl.value = guess;
        if (kindEl.value === 'image' && guess === 'video') kindEl.value = 'video';
      }
    });

    fileEl?.addEventListener('change', async () => {
      const f = fileEl.files && fileEl.files[0];
      if (!f) return;

      const toDataURL = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      const dataUrl = await toDataURL(f);
      fileDataEl.value = dataUrl;
      fileNameEl.value = f.name || 'upload';
      fileMetaEl.innerHTML = `Uploaded: <b>${escapeHtml(fileNameEl.value)}</b>`;

      // If user uploaded video, switch kind to video; if image, switch to image.
      if (f.type.startsWith('video/')) kindEl.value = 'video';
      if (f.type.startsWith('image/')) kindEl.value = 'image';

      UIkit.notification({ message: 'Upload added to slide.', status: 'success' });
      UIkit.update(sliderItemsList);
    });

    li.querySelector('.slider-remove')?.addEventListener('click', (e) => {
      e.preventDefault();
      li.remove();
      UIkit.update(sliderItemsList);
    });

    sliderItemsList.appendChild(li);
  });

  UIkit.update(sliderItemsList);
}

function sliderCollectItemsFromDom(includeEmpty = false) {
  if (!sliderItemsList) return [];
  const items = [];
  Array.from(sliderItemsList.children).forEach(li => {
    const kind = li.querySelector('.slider-kind')?.value || 'image';
    const caption = li.querySelector('.slider-caption')?.value?.trim() || '';
    const url = li.querySelector('.slider-url')?.value?.trim() || '';
    const fileData = li.querySelector('.slider-filedata')?.value || '';
    const fileName = li.querySelector('.slider-filename')?.value || '';

    // For images/videos, allow either upload or URL.
    // For youtube/vimeo, prefer url.
    const out = { kind, caption, url, fileData, fileName, src: '' };

    if (fileData && fileName) {
      out.src = fileData;
    } else if (url) {
      out.src = url;
      // auto-detect kind if user left it as image/video
      if (kind === 'image' || kind === 'video') out.kind = sliderGuessKindFromUrl(url) || kind;
    }

    // keep only meaningful slides
    const meaningful = (out.kind === 'youtube' || out.kind === 'vimeo')
      ? !!out.url
      : !!(out.src || out.url || out.fileData);

    if (includeEmpty || meaningful) items.push(out);
  });
  return items;
}

function openSliderModal(block, idx) {
  // idx may be null for Add
  sliderIndex.value = (idx !== null && idx !== undefined) ? String(idx) : '';
  const isEdit = (idx !== null && idx !== undefined);

  if (sliderModalTitle) sliderModalTitle.textContent = isEdit ? 'Edit Slider' : 'Add Slider';

  sliderTitleInput.value = (block && block.title) ? block.title : '';
  sliderBgColor.value = (block && block.bgColor) ? block.bgColor : '#000000';
  sliderTextColor.value = (block && block.textColor) ? block.textColor : '#ffffff';
  sliderAutoplay.checked = (block && block.autoplay !== undefined) ? !!block.autoplay : true;
  sliderInterval.value = (block && block.interval) ? String(block.interval) : '4000';
  sliderDots.checked = (block && block.dots !== undefined) ? !!block.dots : true;
  sliderArrows.checked = (block && block.arrows !== undefined) ? !!block.arrows : true;
  sliderFinite.checked = !!(block && block.finite);

  sliderRenderItems((block && Array.isArray(block.items)) ? block.items : [sliderDefaultItem(), sliderDefaultItem()]);

  applyLastColorsToContainer('#slider-modal');
  sliderModal.show();
}

if (addSliderBtn) {
  addSliderBtn.addEventListener('click', () => {
    openSliderModal(null, null);
  });
}

if (sliderAddItemBtn) {
  sliderAddItemBtn.addEventListener('click', () => {
    const items = sliderCollectItemsFromDom(true);
    items.push(sliderDefaultItem());
    sliderRenderItems(items);
  });
}

if (sliderSortAzBtn) {
  sliderSortAzBtn.addEventListener('click', () => {
    const items = sliderCollectItemsFromDom();
    items.sort((a, b) => (a.caption || a.url || a.fileName || '').localeCompare((b.caption || b.url || b.fileName || ''), undefined, { sensitivity: 'base' }));
    sliderRenderItems(items);
  });
}
if (sliderSortZaBtn) {
  sliderSortZaBtn.addEventListener('click', () => {
    const items = sliderCollectItemsFromDom();
    items.sort((a, b) => (b.caption || b.url || b.fileName || '').localeCompare((a.caption || a.url || a.fileName || ''), undefined, { sensitivity: 'base' }));
    sliderRenderItems(items);
  });
}

if (sliderForm) {
  sliderForm.addEventListener('submit', (e) => {
    e.preventDefault();

    const items = sliderCollectItemsFromDom();
    if (!items.length) {
      UIkit.notification({ message: 'Add at least one <b>slide</b>.', status: 'warning' });
      return;
    }

    let idx = parseInt(sliderIndex.value, 10);
    if (isNaN(idx)) idx = null;

    const genId = () => 'sec-' + Math.random().toString(36).substr(2, 9);

    const block = {
      id: (idx !== null && allSections[idx]) ? allSections[idx].id : genId(),
      type: 'slider',
      title: sliderTitleInput.value.trim() || '',
      bgColor: sliderBgColor.value || '#000000',
      textColor: sliderTextColor.value || '#ffffff',
      autoplay: !!sliderAutoplay.checked,
      interval: Math.max(1200, parseInt(sliderInterval.value, 10) || 4000),
      dots: !!sliderDots.checked,
      arrows: !!sliderArrows.checked,
      finite: !!sliderFinite.checked,
      items
    };

    if (idx !== null) allSections[idx] = block;
    else { allSections.push(block); idx = allSections.length - 1; }

    renderAllSections();
    applyFontLink();
    applyCustomCSS();

    sliderModal.hide();

    setTimeout(() => {
      if (!Number.isNaN(idx) && document.getElementById('live-editor-root')?.children[idx]) {
        scrollToSection(idx);
      } else {
        const root = document.getElementById('live-editor-root');
        if (root && root.children.length) scrollToSection(root.children.length - 1);
      }
    }, 50);
  });
}

/* ---------- Rendering helpers (editor/preview/export) ---------- */
function parseYouTubeId(url) {
  const u = String(url || '');
  const m1 = u.match(/[?&]v=([^&]+)/);
  if (m1 && m1[1]) return m1[1];
  const m2 = u.match(/youtu\.be\/([^?&#]+)/);
  if (m2 && m2[1]) return m2[1];
  const m3 = u.match(/youtube\.com\/embed\/([^?&#]+)/);
  if (m3 && m3[1]) return m3[1];
  return '';
}
function parseVimeoId(url) {
  const u = String(url || '');
  const m1 = u.match(/vimeo\.com\/(\d+)/);
  if (m1 && m1[1]) return m1[1];
  const m2 = u.match(/player\.vimeo\.com\/video\/(\d+)/);
  if (m2 && m2[1]) return m2[1];
  return '';
}

function sliderRefSrc(item, exportMap) {
  if (!item) return '';
  // Prefer exported file mapping when present
  if (exportMap && item.fileName && exportMap[item.fileName]) {
    return 'media/' + exportMap[item.fileName];
  }
  // Prefer upload data URL if present, else src/url
  if (item.fileData) return item.fileData;
  return item.src || item.url || '';
}

function getSliderInnerHtml(block, exportMap) {
  const title = escapeHtml(block?.title || '');
  const textColor = block?.textColor || '#ffffff';
  const bg = block?.bgColor || '#000000';
  const autoplay = !!block?.autoplay;
  const interval = Math.max(1200, parseInt(block?.interval, 10) || 4000);
  const dots = (block?.dots !== undefined) ? !!block.dots : true;
  const arrows = (block?.arrows !== undefined) ? !!block.arrows : true;
  const finite = !!block?.finite;

  const items = Array.isArray(block?.items) ? block.items : [];

  const liHtml = items.map((it) => {
    const kind = it?.kind || sliderGuessKindFromUrl(it?.url || it?.src) || 'image';
    const cap = escapeHtml(it?.caption || '');
    const src = sliderRefSrc(it, exportMap);
    const url = String(it?.url || it?.src || '');
    const effectiveSrc = src || url;

    let media = '';
    if (kind === 'youtube') {
      const id = parseYouTubeId(url);
      media = id ? `<iframe src="https://www.youtube.com/embed/${id}" allowfullscreen uk-cover style="border:0;"></iframe>` : '';
    } else if (kind === 'vimeo') {
      const id = parseVimeoId(url);
      media = id ? `<iframe src="https://player.vimeo.com/video/${id}" allowfullscreen uk-cover style="border:0;"></iframe>` : '';
    } else if (kind === 'video') {
      media = effectiveSrc ? `<video src="${escapeHtml(effectiveSrc)}" controls playsinline uk-cover style="background:#000;"></video>` : '';
    } else {
      media = effectiveSrc ? `<img src="${escapeHtml(effectiveSrc)}" alt="slide" uk-cover>` : '';
    }

    const captionHtml = cap
      ? `<div class="uk-position-bottom-center uk-position-small uk-text-center" style="color:${textColor}; text-shadow: 0 2px 10px rgba(0,0,0,.45);">${cap}</div>`
      : '';

    return `
      <li>
        <div class="uk-cover-container" style="width:100vw; height:100vh;">
          ${media}
          ${captionHtml}
        </div>
      </li>
    `;
  }).join('');

  const sliderOpts = `autoplay: ${autoplay}; autoplay-interval: ${interval}; finite: ${finite};`;
  const titleHtml = title
    ? `<div class="uk-position-top-center uk-position-small uk-text-center" style="z-index:2;">
         <h2 class="live-heading h-md" style="color:${textColor}; margin:0; text-shadow: 0 2px 12px rgba(0,0,0,.45);">${title}</h2>
       </div>`
    : '';

  return `
    <div class="uk-position-relative uk-visible-toggle uk-light" tabindex="-1"
         uk-slider="${sliderOpts}"
         style="background:${bg}; width:100vw; height:100vh; overflow:hidden; margin-left:calc(50% - 50vw);">
      ${titleHtml}

      <ul class="uk-slider-items uk-child-width-1-1" style="height:100vh; margin:0; padding:0;">
        ${liHtml}
      </ul>

      ${arrows ? `
        <a class="uk-position-center-left uk-position-small uk-hidden-hover" href="#" uk-slidenav-previous uk-slider-item="previous" aria-label="Previous"></a>
        <a class="uk-position-center-right uk-position-small uk-hidden-hover" href="#" uk-slidenav-next uk-slider-item="next" aria-label="Next"></a>
      ` : ''}

      ${dots ? `<ul class="uk-slider-nav uk-dotnav uk-flex-center uk-position-bottom-center uk-position-small" style="margin:0;"></ul>` : ''}
    </div>
  `;
}

/* Patch existing renderers without touching other section types */
(function patchFaqRendering() {
  const _origGetMediaSectionHtml = window.getMediaSectionHtml;
  window.getMediaSectionHtml = function(block, exportMap) {
    if (block && block.type === 'faq') return getFaqInnerHtml(block);
    return _origGetMediaSectionHtml(block, exportMap);
  };

  const _origGetExportSectionHtml = window.getExportSectionHtml;
  window.getExportSectionHtml = function(block, exportMap) {
    if (block && block.type === 'faq') {
      return `
        <div class="uk-section uk-section-muted uk-flex uk-flex-center uk-flex-middle"
             style="background:${block.bgColor || '#ffffff'}; min-height:60vh;">
          ${getFaqInnerHtml(block)}
        </div>
      `;
    }
    return _origGetExportSectionHtml(block, exportMap);
  };

/* Patch existing renderers for slider without touching other section types */
(function patchSliderRendering() {
  const _origGetMediaSectionHtml2 = window.getMediaSectionHtml;
  window.getMediaSectionHtml = function(block, exportMap) {
    if (block && block.type === 'slider') return getSliderInnerHtml(block, exportMap);
    return _origGetMediaSectionHtml2(block, exportMap);
  };

  const _origGetExportSectionHtml2 = window.getExportSectionHtml;
  window.getExportSectionHtml = function(block, exportMap) {
    if (block && block.type === 'slider') {
      return `
        <div style="background:${block.bgColor || '#000000'}; width:100vw; height:100vh; margin:0; padding:0; overflow:hidden;">
          ${getSliderInnerHtml(block, exportMap)}
        </div>
      `;
    }
    return _origGetExportSectionHtml2(block, exportMap);
  };
})();
})();

</script>

<script>
async function fixLightboxAnchors(root) {
const links = Array.from(root.querySelectorAll('[uk-lightbox] a[href^="data:image/"], [uk-lightbox] a[href^="blob:"]'));
await Promise.all(links.map(async (a) => {
a.setAttribute('data-type', 'image');
if (a.href.startsWith('data:image/')) {
const blob = await fetch(a.href).then(r => r.blob());
a.href = URL.createObjectURL(blob);
}
}));
if (window.UIkit && UIkit.update) UIkit.update(root);
}
</script>

<script>
// Enhance media elements (images, iframes, videos)
function enhanceMedia(root) {

// Lazy-load images
root.querySelectorAll('img').forEach(img => {
if (!img.closest('[uk-lightbox]') && !img.hasAttribute('loading')) {
img.setAttribute('loading', 'lazy');
}
});

// Lazy-load iframes
root.querySelectorAll('iframe').forEach(frame => {
if (!frame.hasAttribute('loading')) {
frame.setAttribute('loading', 'lazy');
}
});

// Optimize videos
root.querySelectorAll('video').forEach(video => {
if (!video.hasAttribute('preload')) {
video.setAttribute('preload', 'none');
}
if (!video.hasAttribute('uk-video')) {
video.setAttribute('uk-video', 'autoplay: inview');
}
video.setAttribute('muted', '');       // ensures autoplay works
video.setAttribute('playsinline', ''); // important for mobile
});

root.querySelectorAll('[uk-lightbox]').forEach(lb => { fixLightboxAnchors(lb); });

}

document.addEventListener("DOMContentLoaded", () => {
// 1) Enhance all existing media when page loads
enhanceMedia(document);

// 2) Watch #page container for new sections added dynamically
const target = document.querySelector("#page");
if (target) {
const observer = new MutationObserver(mutations => {
mutations.forEach(mutation => {
mutation.addedNodes.forEach(node => {
if (node.nodeType === 1) {
enhanceMedia(node); // auto-enhance new section
}
});
});
});
observer.observe(target, { childList: true, subtree: true });
}
});
</script>

<!-- Gallery Maker Modal-->
<div id="gallery-modal" uk-modal>
<div class="uk-modal-dialog uk-modal-body uk-border-rounded uk-width-1-1 uk-margin-auto">
<button class="uk-modal-close-default" type="button" uk-close></button>
<h3 class="uk-modal-title">Add Image Gallery</h3>

<div class="uk-margin">
<label class="uk-form-label">Title</label>
<input class="uk-input uk-border-rounded" type="text" id="gm-title" placeholder="Your Gallery name">
</div>

<div class="uk-margin">
<label class="uk-form-label">Subtitle</label>
<input class="uk-input uk-border-rounded" type="text" id="gm-subtitle" placeholder="Your Album name">
</div>

<h4 class="uk-heading-bullet">Choose Colors</h4>

<div class="uk-margin">
<label class="uk-form-label">Background Color </label>
<input type="color" id="gm-bgcolor" value="#000000">
</div>

<div class="uk-margin">
<label class="uk-form-label">Title / Text Color</label>
<input type="color" id="gm-textcolor" value="#ffffff">
</div>

<h4 class="uk-heading-bullet">Add Images</h4>

<div class="uk-margin">
<label class="uk-form-label">Select Images</label>
<input type="file" id="gm-images" multiple accept="image/*">
</div>

<!-- Sortable grid inside modal -->
<div id="gm-gallery" class="uk-grid-small uk-child-width-1-3@s" uk-grid uk-sortable="handle: img"></div>

<div class="uk-margin">
<button class="save" onclick="saveGallery()">Save</button>
</div>
</div>
</div>

<script>
let editingGalleryId = null; // track if we’re editing or creating new

// Add Gallery button -> open clean modal
document.getElementById('addGalleryBtn')
.addEventListener('click', () => {
editingGalleryId = null;
document.getElementById('gm-title').value = '';
document.getElementById('gm-subtitle').value = '';
document.getElementById('gm-gallery').innerHTML = '';

const gmTitleEl = document.querySelector('#gallery-modal .uk-modal-title');
if (gmTitleEl) gmTitleEl.textContent = 'Add Image Gallery';

applyLastColorsToContainer('#gallery-modal');
UIkit.modal('#gallery-modal').show();
});

document.getElementById('gm-images').addEventListener('change', function(){
const grid = document.getElementById('gm-gallery');
Array.from(this.files).forEach(file => {
const reader = new FileReader();
reader.onload = e => {
const src = e.target.result;
const col = document.createElement('div');
col.innerHTML = `
<div class="uk-card uk-card-default uk-card-body uk-padding-small uk-text-center uk-position-relative">
<img class="uk-border-rounded" src="${src}" style="max-height:120px">
<input class="uk-input uk-form-small uk-margin-small-top" placeholder="Caption (optional)">
<button class="uk-icon-button uk-position-top-right" uk-icon="trash" type="button"></button>
</div>
`;
const card = col.firstElementChild;
card.querySelector('[uk-icon="trash"]').addEventListener('click', () => col.remove());
grid.appendChild(col);
};
reader.readAsDataURL(file);
});
this.value = '';
});

function gmEscapeHtml(s=''){
return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// Unified save (new + edit)
window.saveGallery = function(){
const title = (document.getElementById('gm-title')?.value || '').trim();
const subtitle = (document.getElementById('gm-subtitle')?.value || '').trim();
const bgColor = document.getElementById('gm-bgcolor')?.value || '#000000';
const textColor = document.getElementById('gm-textcolor')?.value || '#ffffff';
const altBase = [title, subtitle].filter(Boolean).join(' — ');

const items = Array.from(document.querySelectorAll('#gm-gallery .uk-card'));

let imagesHtml = '';
const dataItems = [];
items.forEach((card) => {
const img = card.querySelector('img');
const cap = card.querySelector('input')?.value || '';

imagesHtml += `<div>
<a class="uk-inline" data-type="image" href="${img.src}" data-caption="${gmEscapeHtml(cap)}" aria-label="${gmEscapeHtml(altBase)}">
<img class="uk-border-rounded" style="width:100%;height:auto;display:block" src="${img.src}" alt="${gmEscapeHtml(altBase)}">
</a>
</div>\n`;

dataItems.push({ src: img.src, caption: cap, alt: altBase });
});
const galleryData = { title, subtitle, bgColor, textColor, items: dataItems };

const titleHtml    = title    ? `<h1 class="uk-heading uk-text-center" style="color:${textColor}" uk-scrollspy="cls: uk-animation-slide-top; delay: 0; offset: 100; repeat: true"><span>${gmEscapeHtml(title)}</span></h1>` : '';
const subtitleHtml = subtitle ? `<h3 class="uk-heading uk-text-center uk-padding-large uk-padding-remove-top" style="color:${textColor}" uk-scrollspy="cls: uk-animation-slide-bottom; delay: 0; offset: 120; repeat: true">${gmEscapeHtml(subtitle)}</h3>` : '';

const newHtml = `
<div class="uk-container uk-padding" style="background:${bgColor}; color:${textColor}">
${titleHtml}
${subtitleHtml}
<div class="uk-grid-small uk-child-width-1-2@s uk-child-width-1-3@m"
uk-grid="masonry: true" uk-lightbox="animation: slide; toggle: a" uk-scrollspy="target: > div; cls: uk-animation-fade; delay: 150; repeat: false">
${imagesHtml.trim()}
</div>
</div>
`.trim();

if (editingGalleryId) {
// Update existing
const block = allSections.find(b => b.id === editingGalleryId);

if (block) {
block.html = newHtml;
block.bgColor = bgColor;
block.data = galleryData;  
block.heading = title;
}
editingGalleryId = null;
} else {
// Create new
const block = {
id: 'sec-' + Math.random().toString(36).substr(2, 9),
type: 'gallery',
html: newHtml,
bgColor,
data: galleryData,
heading: title
};
allSections.push(block);
}

renderAllSections();
UIkit.modal('#gallery-modal').hide();
};

// Edit gallery
window.editGallery = function(id) {
const block = allSections.find(b => b.id === id);
if (!block) return;

editingGalleryId = id;

document.getElementById('gm-title').value = '';
document.getElementById('gm-subtitle').value = '';
document.getElementById('gm-gallery').innerHTML = '';
document.getElementById('gm-bgcolor').value = block.bgColor || '#000000';
document.getElementById('gm-textcolor').value = (block.data && block.data.textColor) ? block.data.textColor : '#ffffff';

if (block.data) {
// Use structured JSON
document.getElementById('gm-title').value = block.data.title || '';
document.getElementById('gm-subtitle').value = block.data.subtitle || '';
(block.data.items || []).forEach(({src, caption}) => {
const col = document.createElement('div');
col.innerHTML = `
<div class="uk-card uk-card-default uk-card-body uk-padding-small uk-text-center uk-position-relative">
<img class="uk-border-rounded" src="${src}" style="max-height:120px">
<input class="uk-input uk-form-small uk-margin-small-top" value="${caption || ''}" placeholder="Caption (optional)">
<button class="uk-icon-button uk-position-top-right" uk-icon="trash" type="button"></button>
</div>`;
const card = col.firstElementChild;
card.querySelector('[uk-icon="trash"]').addEventListener('click', () => col.remove());
document.getElementById('gm-gallery').appendChild(col);
});
} else {
// Fallback: parse existing HTML (legacy galleries)
const parser = new DOMParser();
const doc = parser.parseFromString(block.html, "text/html");
document.getElementById('gm-title').value = doc.querySelector('h1 span')?.textContent || '';
document.getElementById('gm-subtitle').value = doc.querySelector('h3')?.textContent || '';
const imgs = doc.querySelectorAll('a[href] > img');
imgs.forEach(img => {
const src = img.getAttribute('src');
const caption = img.closest('a').getAttribute('data-caption') || '';
const col = document.createElement('div');
col.innerHTML = `
<div class="uk-card uk-card-default uk-card-body uk-padding-small uk-text-center uk-position-relative">
<img class="uk-border-rounded" src="${src}" style="max-height:120px">
<input class="uk-input uk-form-small uk-margin-small-top" value="${caption}" placeholder="Caption (optional)">
<button class="uk-icon-button uk-position-top-right" uk-icon="trash" type="button"></button>
</div>`;
const card = col.firstElementChild;
card.querySelector('[uk-icon="trash"]').addEventListener('click', () => col.remove());
document.getElementById('gm-gallery').appendChild(col);
});
}


// set modal title to Edit when opening to edit an existing gallery
const gmTitleEl = document.querySelector('#gallery-modal .uk-modal-title');
if (gmTitleEl) gmTitleEl.textContent = 'Edit Image Gallery';

applyLastColorsToContainer('#gallery-modal');
UIkit.modal('#gallery-modal').show();

};
</script>

<script>
// --- Color Picker dynamic background ---
function updateColorPickers() {
const pickers = document.querySelectorAll('input[type="color"]');
pickers.forEach(picker => {
picker.style.backgroundColor = picker.value;
picker.style.setProperty('--fallback-color', picker.value);
picker.addEventListener('input', e => {
e.target.style.backgroundColor = e.target.value;
e.target.style.setProperty('--fallback-color', e.target.value);
});
});
}
updateColorPickers();

// --- Rainbow border update for color pickers ---
function updateRainbowPickers() {
const border = 'conic-gradient(red, orange, yellow, green, cyan, blue, violet, red)';
document.querySelectorAll('input[type="color"]').forEach(picker => {
picker.style.background = `linear-gradient(${picker.value}, ${picker.value}) padding-box, ${border} border-box`;
picker.addEventListener('input', e => {
e.target.style.background = `linear-gradient(${e.target.value}, ${e.target.value}) padding-box, ${border} border-box`;
});
});
}
updateRainbowPickers();

// ------------------- apply original input colors for new modals -------------------
var initializedModals = initializedModals || new WeakSet();

function applyLastColorsToContainer(modalEl) {
var root = (typeof modalEl === 'string') ? document.querySelector(modalEl) : modalEl;
if (!root) return;

// Apply each color input's own value as background
root.querySelectorAll('input[type="color"]').forEach(input => {
if (input.value) {
input.style.backgroundColor = input.value;
input.style.setProperty('--fallback-color', input.value);
input.style.background = `linear-gradient(${input.value}, ${input.value}) padding-box, conic-gradient(red, orange, yellow, green, cyan, blue, violet, red) border-box`;
}
});
}

// Automatic for UIkit modals
if (window.UIkit && UIkit.util) {
UIkit.util.on(document, 'beforeshow', '.uk-modal', function(e) {
var modal = e.target;
if (!initializedModals.has(modal)) {
applyLastColorsToContainer(modal); // uses your function
initializedModals.add(modal);       // mark modal as initialized
}
});
}

</script>

<script>
// Prevent drag-and-drop if any section contains an iframe
UIkit.util.on(editorRoot, 'start', function (e) {
// `start` fires when user begins dragging
const sections = Array.from(editorRoot.querySelectorAll('.editor-section'));
const hasIframe = sections.some(sec => sec.querySelector('iframe'));

if (hasIframe) {
// Stop the drag operation
e.preventDefault();

// Show UIkit notification
UIkit.notification({
message: '<b>Drag</b> and <b>Drop</b> of content including<br> <b>Vimeo</b> / <b>YouTube</b> or <b>iframe</b> is <b>not</b> supported.<br>Use the <b>Move Up / Down</b> buttons instead.',
status: 'warning',
pos: 'top-center',
timeout: 10000
});
}
});
</script>

<script>
function normalizeImportedSections(sections) {
  sections.forEach(block => {
    if (block.type === 'gallery') {
      // Ensure block.html exists
      if (!block.html) {
        block.html = ''; // fallback empty HTML if missing
      }

      // Add scrollspy to each card inside the gallery HTML if missing
      // Note: we can’t manipulate the HTML string fully, but after renderAllSections()
      // the MutationObserver will automatically add uk-scrollspy to all .uk-card elements
    }

    // For text/media blocks, ensure new fields exist
    if (block.type === 'text') {
      block.animation = block.animation || 'uk-animation-fade';
      block.headingSize = block.headingSize || 'h-lg';
      block.subtitleSize = block.subtitleSize || 'sub-md';
      block.paragraphSize = block.paragraphSize || 'p-md';
      block.bgColor = block.bgColor || '#ffffff';
      block.textColor = block.textColor || '#000000';
      block.align = block.align || 'center';
    }

    if (block.type === 'image' || block.type === 'video') {
      block.mediaSize = block.mediaSize || 'full';
      block.bgColor = block.bgColor || '#000000';
      block.headingSize = block.headingSize || 'uk-heading-2xlarge';
      block.headingColor = block.headingColor || '#ffffff';
      block.btnColor = block.btnColor || 'default';
      // ...any other new fields you added in the latest version
    }
  });

  return sections;
}
</script>

<script>
// -----------------------------
// FONT HANDLING (Bulletproof)
// -----------------------------

// 1) Update fontTarget whenever user selects radio buttons
document.querySelectorAll('input[name="font-target"]').forEach(radio => {
    radio.addEventListener('change', e => {
        siteSettings.fontTarget = e.target.value;
        applyFontLink();
        applyCustomCSS();
    });
});

// 2) Load Google Font link dynamically
function applyFontLink() {
    if (siteSettings.fontName) {
        const urlName = siteSettings.fontName.trim().replace(/ /g, '+');
        const fontUrl = `https://fonts.googleapis.com/css2?family=${urlName}&display=swap`;
        let link = document.getElementById("custom-font-link");
        if (!link) {
            link = document.createElement("link");
            link.id = "custom-font-link";
            link.rel = "stylesheet";
            document.head.appendChild(link);
        }
        link.href = fontUrl;
    }
}

// 3) Generate CSS rules for all cases
function generateFontCSS() {
    if (!siteSettings.fontName) return '';
    const fontFamily = `'${siteSettings.fontName}', sans-serif`;
    let css = '';

    switch (siteSettings.fontTarget) {
        case 'all':
            css += `
                body,
                h1, h2, h3, h4, h5, h6,
                .live-heading,
                .live-subtitle,
                .live-paragraph,
                a.uk-button {
                    font-family: ${fontFamily} !important;
                }
            `;
            break;

        case 'body':
            css += `
                body,
                .live-paragraph,
                a.uk-button {
                    font-family: ${fontFamily} !important;
                }
            `;
            break;

        case 'headings':
            css += `
                h1, h2, h3, h4, h5, h6,
                .live-heading,
                .live-subtitle {
                    font-family: ${fontFamily} !important;
                }
            `;
            break;

        case 'none':
        default:
            css += '';
            break;
    }

    return css;
}

// 4) Apply CSS dynamically (for editor, preview, export)
function applyCustomCSS() {
    let styleEl = document.getElementById("custom-css-style");
    if (!styleEl) {
        styleEl = document.createElement("style");
        styleEl.id = "custom-css-style";
        document.head.appendChild(styleEl);
    }

    let css = siteSettings.customCSS || "";
    css += "\n" + generateFontCSS();
    styleEl.innerHTML = css;
}

// 5) Apply font to all buttons dynamically in case new buttons are rendered
function applyFontToButtons() {
    if (!siteSettings.fontName) return;
    const fontFamily = `'${siteSettings.fontName}', sans-serif`;
    document.querySelectorAll('a.uk-button').forEach(btn => {
        btn.style.fontFamily = fontFamily;
    });
}

// 6) Hook into renderAllSections to ensure font applies to new sections
const originalRenderAllSections = window.renderAllSections;
window.renderAllSections = function() {
    originalRenderAllSections();
    applyFontLink();
    applyCustomCSS();
    applyFontToButtons();
};

// 7) Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    applyFontLink();
    applyCustomCSS();
    applyFontToButtons();
});
</script>

<script>
let savedSelection = null;

// Save selection when the toolbar button/drop opens
document.querySelector('.uk-inline button[uk-icon="link"]')?.addEventListener('mousedown', (e) => {
  const sel = window.getSelection();
  if (sel.rangeCount > 0) {
    savedSelection = sel.getRangeAt(0);
  }
});

// Add link using the saved selection
function addLinkFromToolbar() {
  const input = document.getElementById('link-input');
  if (!input) return;

  const url = input.value.trim();
  if (!url) return;

  if (!savedSelection) {
    // Nothing selected: silently exit
    input.focus();
    return;
  }

  // Restore selection
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(savedSelection);

  const range = sel.getRangeAt(0);
  const fragment = range.extractContents();

  const a = document.createElement('a');
  a.href = url;
  a.target = "_blank";
  a.classList.add('uk-link');
  a.style.color = 'currentColor';
  a.appendChild(fragment);

  range.insertNode(a);

  // Move caret after link
  const newRange = document.createRange();
  newRange.setStartAfter(a);
  newRange.collapse(true);
  sel.removeAllRanges();
  sel.addRange(newRange);

  // Clear input
  input.value = '';

  // Hide drop
  const drop = input.closest('[uk-drop]');
  if (drop && window.UIkit && UIkit.drop) {
    try { UIkit.drop(drop).hide(); } catch(e) {}
  }

  // Clear savedSelection
  savedSelection = null;
}

// Bind click + Enter
document.getElementById('link-input-add-button')?.addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  addLinkFromToolbar();
});

document.getElementById('link-input')?.addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    e.stopPropagation();
    addLinkFromToolbar();
  }
});
</script>

<script>
function removeLink() {
  const sel = window.getSelection();
  if (!sel.rangeCount) return;

  const range = sel.getRangeAt(0);
  let container = range.commonAncestorContainer;

  // If the selection is inside a text node, climb to the parent element
  while (container && container.nodeType === 3) container = container.parentNode;
  if (!container) return;

  // Find the nearest anchor <a> wrapping the selection
  const anchor = container.closest('a');
  if (!anchor) return;

  // Replace the <a> with its contents
  const parent = anchor.parentNode;
  while (anchor.firstChild) parent.insertBefore(anchor.firstChild, anchor);
  parent.removeChild(anchor);

  // Optional: restore selection at the start of the removed link
  sel.removeAllRanges();
  const newRange = document.createRange();
  newRange.setStart(parent, 0);
  newRange.collapse(true);
  sel.addRange(newRange);
}
</script>

<script>
const saveJSONBtn = document.getElementById('saveJSON');
const saveJSONModalEl = document.getElementById('save-json-modal');
const saveJSONForm = document.getElementById('save-json-form');
const jsonFilenameInput = document.getElementById('json-filename');

saveJSONBtn.addEventListener('click', () => {
  jsonFilenameInput.value = '';
  UIkit.modal(saveJSONModalEl).show();
});

saveJSONForm.addEventListener('submit', async e => {
  e.preventDefault();

  const fileName = jsonFilenameInput.value.trim() || 'homepage.json';

  const settingsToSave = JSON.parse(JSON.stringify(siteSettings));
  delete settingsToSave.faviconBlob;
  delete settingsToSave.socialBlob;
  if (settingsToSave.navbar) delete settingsToSave.navbar.logoBlob;

  const convertBlobToBase64 = blob => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });

  const conversions = [];

  if (siteSettings.navbar && siteSettings.navbar.logoBlob) {
    conversions.push(convertBlobToBase64(siteSettings.navbar.logoBlob).then(b64 => {
      settingsToSave.navbar.logoBase64 = b64;
    }));
  }
  if (siteSettings.faviconBlob) {
    conversions.push(convertBlobToBase64(siteSettings.faviconBlob).then(b64 => {
      settingsToSave.faviconBase64 = b64;
    }));
  }
  if (siteSettings.socialBlob) {
    conversions.push(convertBlobToBase64(siteSettings.socialBlob).then(b64 => {
      settingsToSave.socialBase64 = b64;
    }));
  }

  await Promise.all(conversions);

  const out = JSON.stringify({ settings: settingsToSave, sections: allSections }, null, 2);
  const blob = new Blob([out], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = fileName.endsWith('.json') ? fileName : fileName + '.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  UIkit.modal(saveJSONModalEl).hide();
});
</script>

<script>
(function() {
  const exportHTMLBtn = document.getElementById('exportHTML');
  const exportHTMLModalEl = document.getElementById('export-html-modal');
  const exportFilenameInput = document.getElementById('export-filename');
  const exportConfirmBtn = document.getElementById('export-confirm');

  // 1️⃣ Open modal when Export button is clicked
  exportHTMLBtn.addEventListener('click', () => {
    exportFilenameInput.value = 'homepage.zip'; // default filename
    UIkit.modal(exportHTMLModalEl).show();
  });

  // 2️⃣ Trigger export when modal Save is clicked
  exportConfirmBtn.addEventListener('click', async () => {
    const filename = exportFilenameInput.value.trim() || 'homepage.zip';

    // Directly call your existing export function
    // Make sure you have `async function doExportHTML(fileName) { ... }` in your code
    await doExportHTML(filename);

    // Close the modal
    UIkit.modal(exportHTMLModalEl).hide();
  });
})();
</script>

<script>
// Persist the selected Google Font radio
const fontRadios = document.querySelectorAll('input[name="font-target"]');
const fontModal = document.getElementById('settings-modal');

let selectedFontTarget = document.querySelector('input[name="font-target"]:checked')?.value || 'none';

fontRadios.forEach(radio => {
  radio.addEventListener('change', () => {
    if (radio.checked) selectedFontTarget = radio.value;
  });
});

UIkit.util.on(fontModal, 'beforeshow', () => {
  fontRadios.forEach(r => r.checked = (r.value === selectedFontTarget));
});

fontRadios.forEach(r => {
  r.nextElementSibling.style.display = 'inline-block';
});
</script>

</body>
</html>
