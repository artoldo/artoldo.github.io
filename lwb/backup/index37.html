<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CLASH Creator™ — Landing Animation SEO Homepage | Sacrisoft</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/css/uikit.min.css" />
    <style>
      .editor-section {
        position: relative;
        cursor: grab;
      }
      .editor-remove-btn {
        position: absolute;
        top: 16px;
        right: 32px;
        z-index: 20;
      }
      .editor-edit-btn {
        position: absolute;
        top: 16px;
        left: 20px;
        z-index: 20;
      }
      .live-heading.uk-heading-large { font-size: 2.7rem; }
      .live-heading.uk-heading-xlarge { font-size: 3.6rem;}
      .live-heading.uk-heading-2xlarge { font-size: 4.8rem; line-height:1.05; }
      .live-subtitle.uk-heading-medium { font-size: 1.6rem; font-weight: 500;}
      .live-subtitle.uk-heading-large { font-size: 2.2rem; font-weight: 500;}
      .live-subtitle.uk-heading-xlarge { font-size: 2.9rem; font-weight: 500;}
      .live-paragraph { font-size: 1.13rem; max-width: 40em; margin-left:auto; margin-right:auto;}
      .live-paragraph.large { font-size: 1.45rem; }
      @media (max-width: 640px) {
        .live-heading.uk-heading-2xlarge { font-size: 2.2rem;}
        .live-heading.uk-heading-xlarge { font-size: 1.5rem;}
        .live-heading.uk-heading-large { font-size: 1.2rem;}
        .live-subtitle.uk-heading-xlarge { font-size: 1.4rem;}
        .live-subtitle.uk-heading-large { font-size: 1.1rem;}
        .live-subtitle.uk-heading-medium { font-size: 1.03rem;}
        .live-paragraph { font-size: 1rem;}
        .live-paragraph.large { font-size: 1.1rem;}
      }
      .uk-navbar-container.sticky-colored {
        background: #222 !important;
      }
      .sticky-colored .uk-navbar-item,
      .sticky-colored .uk-navbar-item span,
      .sticky-colored .uk-navbar-item svg,
      .sticky-colored .uk-navbar-item .uk-icon {
        color: #fff !important;
        fill: #fff !important;
      }
      .sticky-colored .uk-navbar-item .uk-icon [stroke] {
        stroke: #fff !important;
      }
      .uk-sortable-handle { cursor: move; }

@media (max-width: 640px) {
  .live-heading, .live-subtitle, .live-paragraph {
    text-align: center !important;
    word-break: break-word;
    white-space: normal;
  }
}      

/* Style the file input button */
#media-file::file-selector-button {
  padding: 10px 20px;       /* make button bigger */
  font-size: 16px;           /* larger text */
  font-weight: bold;         /* optional */
  color: #fff;               /* text color */
  background-color: #000;    /* black button */
  border: none;
  border-radius: 8px;        /* rounded corners */
  cursor: pointer;
  transition: background-color 0.2s;
}

#media-file::file-selector-button:hover {
  background-color: #222;    /* slightly lighter on hover */
}

.navbar-scroll {
  display: flex;
  flex-wrap: nowrap;        /* keep one line */
  gap: 1rem;
  overflow-x: auto;
  white-space: nowrap;      /* keep text on one line */
  -webkit-overflow-scrolling: touch;
  padding: 0.5rem 1rem;
  align-items: center; /* vertical center */
  list-style: none;    /* when used as <ul> */
  margin: 0;
}

.navbar-scroll a {
  flex: 0 0 auto;          /* avoid shrinking/wrapping */
  text-decoration: none;
  color: inherit;
}

.navbar-scroll a.uk-active {
  font-weight: bold;
  border-bottom: 2px solid currentColor;
}

.navbar-group {
  display: flex;
  gap: 0.5rem;
  flex: 0 0 auto;
  align-items: center; /* ensure icons align with text */
}

#nav-title {
  display: flex;
  align-items: center;
  gap: 0.3rem;
}

    
.navbar-logo {
  height: 40px !important;
  width: auto !important;
  max-height: 40px !important;
  object-fit: contain;
  flex-shrink: 0 !important;
  flex-grow: 0 !important;
}
.navbar-scroll {
  display: flex;
  flex-wrap: nowrap;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  white-space: nowrap;
  gap: 1rem;
  padding: 0.5rem 1rem;
}
.navbar-scroll li {
  flex: 0 0 auto;
  list-style: none;
}

.visually-hidden {
  position: absolute !important;
  width: 1px; height: 1px;
  margin: -1px; padding: 0; border: 0;
  overflow: hidden; clip: rect(0 0 0 0); clip-path: inset(50%);
  white-space: nowrap;
}

  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0,0,0,0);
  border: 0;
}


:root {
  --navbar-link-color: #000000;
}

.navbar-scroll::-webkit-scrollbar {
  height: 6px;
}
.navbar-scroll::-webkit-scrollbar-thumb {
  background: var(--navbar-link-color);
  border-radius: 3px;
}
.navbar-scroll::-webkit-scrollbar-track {
  background: var(--gray, #eee);
}

.navbar-scroll {
  -ms-overflow-style: none;  /* IE & Edge */
  scrollbar-width: none;     /* Firefox */
}
.navbar-scroll::-webkit-scrollbar {
  display: none;             /* Chrome, Safari, Opera */
}

#main-navbar .navbar-scroll {
  display: flex;
  justify-content: center; /* centers horizontally */
}

#site-title-h1 {
  display: none !important;
}

#dynamic-navbar-container .navbar-scroll a img {
  display: block;
}
#dynamic-navbar-container .navbar-scroll a:has(img) {
  text-decoration: none !important;
  border-bottom: none !important;
}

</style>
</head>
<body id="top">
<h1 id="site-title-h1" class="visually-hidden">${siteSettings.title}</h1>

   <!-- Sticky Navbar (Toolbar) -->
<nav id="main-navbar" class="uk-navbar-container uk-navbar-transparent uk-sticky" uk-sticky="top: 100; animation: uk-animation-slide-top;">
  <div class="navbar-scroll">
    <div class="navbar-group">
      <a id="settingsBtn" class="uk-icon-button"  uk-tooltip="Site Settings" uk-icon="settings"></a>
      <a id="navBarBtn" class="uk-icon-button"    uk-tooltip="Dynamic Nav Bar" uk-icon="cog"></a>
      <a id="addImageBtn" class="uk-icon-button"  uk-tooltip="Add Image" uk-icon="image"></a>
      <a id="addVideoBtn" class="uk-icon-button"  uk-tooltip="Add Video" uk-icon="video-camera"></a>
      <a id="embedCodeBtn" class="uk-icon-button" uk-tooltip="Embed Code" uk-icon="code"></a>
      <a id="previewBtn" class="uk-icon-button"   uk-tooltip="Preview" uk-icon="eye"></a>
      <a id="saveJSON" class="uk-icon-button"     uk-tooltip="Save as JSON" uk-icon="download"></a>
      <a id="loadJSON" class="uk-icon-button"     uk-tooltip="Load JSON" uk-icon="upload"></a>
      <a id="exportHTML" class="uk-icon-button"   uk-tooltip="Export as HTML" uk-icon="world"></a>
      <input type="file" id="jsonFileInput" accept=".json" style="display:none">
    </div>
  </div>
</nav>

<!-- Second navbar container (rendered dynamically below the toolbar in editor) -->
<div id="dynamic-navbar-container"></div>

    <ul id="live-editor-root" class="uk-list uk-sortable" uk-sortable="handle: .editor-section"></ul>

    <!-- Modal: media edit -->
    <div id="media-modal" uk-modal>
        <div class="uk-modal-dialog uk-modal-body uk-border-rounded">
            <button class="uk-modal-close-default uk-border-rounded" type="button" uk-close></button>
            <h3 id="media-modal-title" class="uk-modal-title">Add Media</h3>
            <form id="media-form">
                <input type="hidden" id="section-index" value="">
                <ul uk-accordion="multiple:true">
                    <li class="uk-open">
                        <a class="uk-accordion-title" href="#">Section Options</a>
                        <div class="uk-accordion-content">
                            <div class="uk-margin">
                                <label class="uk-form-label">From URL</label>
                                <input class="uk-input uk-border-rounded" type="url" id="media-url" placeholder="Paste URL">
                            </div>
                            <div class="uk-margin">
                                <label class="uk-form-label">Or Upload</label><br>
                                <input type="file" id="media-file" accept="">
                                <div id="prev-file" class="uk-text-meta uk-margin-small-top" style="display:none;">
                                    Previous file: <span id="prev-file-name"></span>
                                    <label><input type="checkbox" id="keep-prev-file" checked> Keep previous file</label>
                                </div>
                            </div>
                            <div class="uk-margin">
                                <label class="uk-form-label">Media Size & Position</label>
                                <select class="uk-select uk-border-rounded" id="media-size">
                                    <option value="full">Full Screen</option>
                                    <option value="left">Small Left</option>
                                    <option value="center">Small Center</option>
                                    <option value="right">Small Right</option>
                                </select>
                            </div>
                            <div class="uk-margin">
                                <label class="uk-form-label">Background Color</label>
                                <input type="color" id="bg-color" value="#1e87f0" >
                            </div>
                        </div>
                    </li>
                    <li>
                        <a class="uk-accordion-title" href="#">Heading Options</a>
                        <div class="uk-accordion-content">
                            <div class="uk-margin">
                                <label class="uk-form-label">Heading</label>
                                <input class="uk-input uk-border-rounded" type="text" id="media-heading" value="Your Headline Here">
                            </div>
                            <div class="uk-margin">
                                <label class="uk-form-label">Heading Size</label>
                                <select class="uk-select uk-border-rounded" id="heading-size">
                                    <option value="uk-heading-large">Large</option>
                                    <option value="uk-heading-xlarge">XLarge</option>
                                    <option value="uk-heading-2xlarge" selected>XXLarge</option>
                                </select>
                            </div>
                            <div class="uk-margin">
                                <label class="uk-form-label">Heading Color</label>
                                <input type="color" id="media-color" value="#ffffff" >
                            </div>
                        </div>
                    </li>
                    <li>
                        <a class="uk-accordion-title" href="#">Text Options</a>
                        <div class="uk-accordion-content">
                            <div class="uk-margin">
                                <label class="uk-form-label">Subtitle</label>
                                <input class="uk-input uk-border-rounded" type="text" id="media-subtitle" placeholder="Your Subtitle">
                            </div>
                            <div class="uk-margin">
                                <label class="uk-form-label">Subtitle Size</label>
                                <select class="uk-select uk-border-rounded" id="subtitle-size">
                                    <option value="uk-heading-medium">Medium</option>
                                    <option value="uk-heading-large">Large</option>
                                    <option value="uk-heading-xlarge">XLarge</option>
                                </select>
                            </div>
                            <div class="uk-margin">
                                <label class="uk-form-label">Subtitle Color</label>
                                <input type="color" id="subtitle-color" value="#ffffff" >
                            </div>
                            <div class="uk-margin">
                                <label class="uk-form-label">Paragraph</label>
                                <textarea class="uk-textarea uk-border-rounded" id="media-paragraph" rows="2" placeholder="Add an optional description or paragraph"></textarea>
                            </div>
                            <div class="uk-margin">
                                <label class="uk-form-label">Paragraph Size</label>
                                <select class="uk-select uk-border-rounded" id="paragraph-size">
                                    <option value="">Default</option>
                                    <option value="large">Large</option>
                                </select>
                            </div>
                            <div class="uk-margin">
                                <label class="uk-form-label">Paragraph Color</label>
                                <input type="color" id="paragraph-color" value="#ffffff" >
                            </div>
                        </div>
                    </li>
                    <li>
                        <a class="uk-accordion-title" href="#">Button Options</a>
                        <div class="uk-accordion-content">
                            <div class="uk-margin">
                                <label class="uk-form-label">Button Label</label>
                                <input class="uk-input uk-border-rounded" type="text" id="btn-label" placeholder="(Optional)">
                            </div>
                            <div class="uk-margin">
                                <label class="uk-form-label">Button URL</label>
                                <input class="uk-input uk-border-rounded" type="url" id="btn-url" placeholder="https://your-link.com">
                            </div>
                            <div class="uk-margin">
                                <label class="uk-form-label">Button Color</label>
                                <select class="uk-select uk-border-rounded" id="btn-color">
                                    <option value="default">Default</option>
                                    <option value="primary">Primary</option>
                                    <option value="secondary">Secondary</option>
                                    <option value="text">Text</option>
                                </select>
                            </div>
                        </div>
                    </li>
                </ul>
                <button type="submit" class="uk-button uk-button-primary uk-width-1-1 uk-margin-top uk-border-rounded">Save</button>
            </form>
        </div>
    </div>

 <!-- Modal: embed -->
<div id="embed-modal" uk-modal>
  <div class="uk-modal-dialog uk-modal-body uk-border-rounded">
    <button class="uk-modal-close-default uk-border-rounded" type="button" uk-close></button>
    <h3 id="embed-modal-title" class="uk-modal-title">Add Embed Code</h3>
    <form id="embed-form">
      <input type="hidden" id="embed-index" value="">
      <div class="uk-margin">
        <label class="uk-form-label">Paste Code</label>
        <textarea class="uk-textarea uk-border-rounded" id="embed-code" rows="8" placeholder="Paste HTML, CSS, or JS here"></textarea>
      </div>
      <button type="submit" class="uk-button uk-button-primary uk-width-1-1 uk-margin-top uk-border-rounded">Save</button>
    </form>
  </div>
</div>

<!-- Modal: site settings -->
<div id="settings-modal" uk-modal>
  <div class="uk-modal-dialog uk-modal-body uk-border-rounded">
    <button class="uk-modal-close-default uk-border-rounded" type="button" uk-close></button>
    <h3 class="uk-modal-title">Site Settings</h3>
    <form id="settings-form">
<div class="uk-margin">
  <label class="uk-form-label">Site Language</label>
  <select class="uk-select uk-border-rounded" id="site-language">
    <option value="en" selected>English</option>
    <option value="it">Italian</option>
    <option value="fr">French</option>
    <option value="de">German</option>
    <!-- (list trimmed for brevity, keep your full list if needed) -->
  </select>
</div>
      <div class="uk-margin">
        <label class="uk-form-label">Website Title</label>
        <input class="uk-input uk-border-rounded" type="text" id="site-title" placeholder="My Awesome Site">
      </div>
      <div class="uk-margin">
        <label class="uk-form-label">Description</label>
        <textarea class="uk-textarea uk-border-rounded" id="site-description" placeholder="CLASH Creator™ — Landing Animation SEO Homepage" rows="2"></textarea>
      </div>
      <div class="uk-margin">
        <label class="uk-form-label">Robots</label>
        <select class="uk-select uk-border-rounded" id="site-robots">
          <option value="index, follow">Index, Follow</option>
          <option value="noindex, nofollow">NoIndex, NoFollow</option>
        </select>
      </div>
      <div class="uk-margin">
        <label class="uk-form-label">Author</label>
        <input class="uk-input uk-border-rounded" type="text" id="site-author" placeholder="Sacrisoft">
      </div>
      <div class="uk-margin">
  <label class="uk-form-label">Favicon URL</label>
  <input class="uk-input uk-border-rounded" type="url" id="site-favicon" placeholder="https://example.com/favicon.ico">
  <div class="uk-margin-small-top">
    <label class="uk-form-label">Or Upload Favicon</label>
    <input type="file" id="site-favicon-file" accept="image/x-icon,image/png,image/svg+xml,image/jpeg,image/jpg,image/webp">
    <div id="site-favicon-preview" class="uk-margin-small-top" style="max-height:40px;"></div>
  </div>
</div>

<div class="uk-margin">
  <label class="uk-form-label">Social Preview Image URL</label>
  <input class="uk-input uk-border-rounded" type="url" id="site-social" placeholder="https://example.com/social.png">
  <div class="uk-margin-small-top">
    <label class="uk-form-label">Or Upload Social Image</label>
    <input type="file" id="site-social-file" accept="image/*">
    <div id="site-social-preview" class="uk-margin-small-top" style="max-height:80px;"></div>
  </div>
</div>
      <div class="uk-margin">
        <label class="uk-form-label">Insert custom Schema.org JSON code</label>
        <textarea class="uk-textarea uk-border-rounded" id="site-head-script" rows="4" placeholder='<script type="application/ld+json">...</script>'></textarea>
        <p uk-lightbox> 
        <a class="uk-button uk-button-secondary uk-border-pill uk-margin-small" href="https://artoldo.com/embassyofthefreemind/index.html" data-type="iframe">Generate Code</a>
	</p>
      </div>
      <button type="submit" class="uk-button uk-button-primary uk-width-1-1 uk-margin-top uk-border-rounded">Save</button>
    </form>
  </div>
</div>

    <!-- UIKit modal for delete warning -->
    <div id="delete-modal" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">Really delete item?</h2>
            <p>This action cannot be undone.</p>
            <p class="uk-text-right">
                <button class="uk-button uk-button-default uk-modal-close" type="button">Cancel</button>
                <button id="confirm-delete" class="uk-button uk-button-danger uk-border-rounded" type="button">Delete</button>
            </p>
        </div>
    </div>

<!-- NEW: Dynamic Nav Bar Settings Modal -->
<div id="navbar-modal" uk-modal>
  <div class="uk-modal-dialog uk-modal-body uk-border-rounded">
    <button class="uk-modal-close-default uk-border-rounded" type="button" uk-close></button>
    <h3 class="uk-modal-title">Dynamic Nav Bar Settings</h3>
    <form id="navbar-form">
      <div class="uk-margin"><label><input type="checkbox" id="enable-navbar"> Enable Dynamic Nav Bar</label></div>
      <div class="uk-margin"><label class="uk-form-label">Background Color</label><input type="color" id="navbar-bg" value="#ffffff"></div>
      <div class="uk-margin"><label class="uk-form-label">Text Color</label><input type="color" id="navbar-text" value="#000000"></div>
<div class="uk-margin">
  <label class="uk-form-label">Logo From URL</label>
  <input class="uk-input uk-border-rounded" type="url" id="navbar-logo-url" placeholder="https://example.com/logo.png">
  <div id="navbar-logo-url-preview" class="uk-margin-small-top" style="max-height:50px;"></div>
</div>
<div class="uk-margin">
  <label class="uk-form-label">Or Upload Logo</label>
  <input type="file" id="navbar-logo" accept="image/*">
  <div id="navbar-logo-preview" class="uk-margin-small-top" style="max-height:50px;"></div>
</div>
      <button type="submit" class="uk-button uk-button-primary uk-width-1-1 uk-border-rounded">Save</button>
    </form>
  </div>
</div>

    <!-- JSZip for export -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/js/uikit-icons.min.js"></script>
    <script>
        // Sticky nav color swap
        UIkit.util.on(document, 'DOMContentLoaded', function(){
            var stickyNav = document.getElementById('main-navbar');
            UIkit.util.on(window, 'scroll', function() {
                const stickyActive = stickyNav.classList.contains('uk-sticky-fixed');
                stickyNav.classList.toggle('sticky-colored', stickyActive);
            });
        });

        // Editor logic
        const editorRoot = document.getElementById('live-editor-root');
        const addImageBtn = document.getElementById('addImageBtn');
        const addVideoBtn = document.getElementById('addVideoBtn');
        const mediaModal = UIkit.modal('#media-modal');
        const mediaForm = document.getElementById('media-form');
        const mediaUrl = document.getElementById('media-url');
        const mediaFile = document.getElementById('media-file');
        const prevFile = document.getElementById('prev-file');
        const prevFileName = document.getElementById('prev-file-name');
        const keepPrevFile = document.getElementById('keep-prev-file');
        const mediaHeading = document.getElementById('media-heading');
        const headingSize = document.getElementById('heading-size');
        const mediaColor = document.getElementById('media-color');
        const mediaModalTitle = document.getElementById('media-modal-title');
        const mediaSize = document.getElementById('media-size');
        const bgColor = document.getElementById('bg-color');
        const btnLabel = document.getElementById('btn-label');
        const btnUrl = document.getElementById('btn-url');
        const btnColor = document.getElementById('btn-color');
        const sectionIndex = document.getElementById('section-index');
        const embedCodeBtn = document.getElementById('embedCodeBtn');
        const embedModal = UIkit.modal('#embed-modal');
        const embedForm = document.getElementById('embed-form');
        const embedCode = document.getElementById('embed-code');
        const embedIndex = document.getElementById('embed-index');

        // New fields for subtitle/paragraph
        const mediaSubtitle = document.getElementById('media-subtitle');
        const subtitleSize = document.getElementById('subtitle-size');
        const subtitleColor = document.getElementById('subtitle-color');
        const mediaParagraph = document.getElementById('media-paragraph');
        const paragraphSize = document.getElementById('paragraph-size');
        const paragraphColor = document.getElementById('paragraph-color');

        // JSON/HTML
        const saveJSONBtn = document.getElementById('saveJSON');
        const loadJSONBtn = document.getElementById('loadJSON');
        const exportHTMLBtn = document.getElementById('exportHTML');
        const jsonFileInput = document.getElementById('jsonFileInput');
        const deleteModal = UIkit.modal('#delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete');

        // NEW: Dynamic Nav Bar controls
        const navBarBtn = document.getElementById('navBarBtn');
        const navbarModal = UIkit.modal('#navbar-modal');
        const navbarForm = document.getElementById('navbar-form');
        const enableNavbar = document.getElementById('enable-navbar');
        const navbarBg = document.getElementById('navbar-bg');
        const navbarText = document.getElementById('navbar-text');
const navbarLogoUrl = document.getElementById('navbar-logo-url');
const navbarLogoUrlPreview = document.getElementById('navbar-logo-url-preview');
const navbarLogo = document.getElementById('navbar-logo');
const navbarLogoPreview = document.getElementById('navbar-logo-preview');
        const dynamicNavbarContainer = document.getElementById('dynamic-navbar-container');

        let currentMediaType = "image";
        let editingPrevFileName = '';
        let editingPrevFileData = '';
        let editingPrevFileType = '';
        let allSections = [];
        let toDeleteIndex = null;

        // Default settings
        let siteSettings = {
            language: 'en',
            title: 'CLASH Creator™',
            description: '',
            robots: 'index, follow',
            author: '',
            favicon: '',
            socialImage: '',
            appColor: '#1e87f0',
            headScript: '',
            navbar: { enabled: false, bg: '#ffffff', text: '#000000', logoUrl: '', logo: '', logoFileName: '' }
        };

        function resetPrevFileBox() {
            prevFile.style.display = 'none';
            prevFileName.textContent = '';
            keepPrevFile.checked = true;
            editingPrevFileName = '';
            editingPrevFileData = '';
            editingPrevFileType = '';
        }

        function setupModal(type, data, idx) {
            currentMediaType = type;
            mediaModalTitle.textContent = type === 'image'
                ? (idx !== undefined ? 'Edit Image' : 'Add Image')
                : (idx !== undefined ? 'Edit Video' : 'Add Video');
            sectionIndex.value = idx !== undefined ? idx : '';
            if (data) {
                mediaUrl.value = data.url || '';
                mediaHeading.value = data.heading || '';
                mediaColor.value = data.headingColor || '#ffffff';
                bgColor.value = data.bgColor || '#1e87f0';
                mediaSize.value = data.mediaSize || 'full';
                headingSize.value = data.headingSize || 'uk-heading-2xlarge';
                btnLabel.value = data.btnLabel || '';
                btnUrl.value = data.btnUrl || '';
                btnColor.value = data.btnColor || 'default';

                // new fields
                mediaSubtitle.value = data.subtitle || '';
                subtitleSize.value = data.subtitleSize || 'uk-heading-medium';
                subtitleColor.value = data.subtitleColor || '#ffffff';
                mediaParagraph.value = data.paragraph || '';
                paragraphSize.value = data.paragraphSize || '';
                paragraphColor.value = data.paragraphColor || '#ffffff';

                resetPrevFileBox();
                mediaFile.value = '';
                mediaFile.accept = type === 'image' ? 'image/*' : 'video/*';

                if (!data.url && data.fileName && data.fileData) {
                    editingPrevFileName = data.fileName;
                    editingPrevFileData = data.fileData;
                    editingPrevFileType = data.fileType;
                    prevFile.style.display = '';
                    prevFileName.textContent = data.fileName;
                } else {
                    resetPrevFileBox();
                }
            } else {
                mediaUrl.value = '';
                mediaHeading.value = 'Your Headline Here';
                mediaColor.value = '#ffffff';
                bgColor.value = '#1e87f0';
                mediaSize.value = 'full';
                headingSize.value = 'uk-heading-2xlarge';
                btnLabel.value = '';
                btnUrl.value = '';
                btnColor.value = 'default';

                // new fields
                mediaSubtitle.value = '';
                subtitleSize.value = 'uk-heading-medium';
                subtitleColor.value = '#ffffff';
                mediaParagraph.value = '';
                paragraphSize.value = '';
                paragraphColor.value = '#ffffff';

                mediaFile.value = '';
                mediaFile.accept = type === 'image' ? 'image/*' : 'video/*';
                resetPrevFileBox();
            }
        }

        addImageBtn.addEventListener('click', () => {
            setupModal('image');
            mediaModal.show();
        });
        addVideoBtn.addEventListener('click', () => {
            setupModal('video');
            mediaModal.show();
        });

        function fileToDataURL(file, cb) {
            const reader = new FileReader();
            reader.onload = e => cb(e.target.result, file.name, file.type);
            reader.readAsDataURL(file);
        }

        function makeButtonHtml(label, url, color) {
            if (!label || !url) return '';
            let classes = {
                default: 'uk-button-default',
                primary: 'uk-button-primary',
                secondary: 'uk-button-secondary',
                text: 'uk-button-text'
            };
            return `<a href="${url}" class="uk-button ${classes[color] || 'uk-button-default'} uk-margin-top uk-border-rounded" target="_blank">${label}</a>`;
        }

        function getTextBlockHtml(block) {
            // Subtitle, then Paragraph
            let out = '';
            if (block.subtitle) {
                out += `<div class="live-subtitle ${block.subtitleSize || 'uk-heading-medium'}" style="color:${block.subtitleColor||'#fff'}">${block.subtitle}</div>`;
            }
            if (block.paragraph) {
                out += `<div class="live-paragraph${block.paragraphSize === 'large' ? ' large' : ''}" style="color:${block.paragraphColor||'#fff'};margin-top:0.5em;">${block.paragraph.replace(/\n/g, '<br>')}</div>`;
            }
            return out;
        }

// EMBED modal interactions
embedCodeBtn.addEventListener('click', () => {
    setupEmbedModal();
    UIkit.modal('#embed-modal').show(); // get a fresh modal instance
});

function setupEmbedModal(data, idx) {
    const titleEl = document.getElementById('embed-modal-title');
    titleEl.textContent = (idx !== undefined && idx !== null) ? 'Edit Embed Code' : 'Add Embed Code';
    embedCode.value = data ? data.code : '';
    embedIndex.value = (idx !== undefined && idx !== null) ? idx : '';
}

embedForm.addEventListener('submit', function (e) {
    e.preventDefault();
    let code = embedCode.value.trim();
    if (!code) {
        UIkit.notification({ message: 'Please enter some code.', status: 'warning' });
        return;
    }

    // Correctly parse index
    let idx = parseInt(embedIndex.value, 10);
    if (isNaN(idx)) idx = null;  // null means new section

    let block = { type: 'embed', code };

    if (idx !== null) {
        allSections[idx] = block;   // update existing
    } else {
        allSections.push(block);    // add new
    }

    renderAllSections();
    embedModal.hide();
});


const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = UIkit.modal('#settings-modal');
const settingsForm = document.getElementById('settings-form');

// Open modal
settingsBtn.addEventListener('click', () => {
    document.getElementById('site-language').value = siteSettings.language;
    document.getElementById('site-title').value = siteSettings.title;
    document.getElementById('site-description').value = siteSettings.description;
    document.getElementById('site-robots').value = siteSettings.robots;
    document.getElementById('site-author').value = siteSettings.author;
    document.getElementById('site-favicon').value = siteSettings.favicon;
    document.getElementById('site-social').value = siteSettings.socialImage;
    document.getElementById('site-head-script').value = siteSettings.headScript;
    settingsModal.show();
});

// Save settings
settingsForm.addEventListener('submit', e => {
    e.preventDefault();
    siteSettings.language = document.getElementById('site-language').value;
    siteSettings.title = document.getElementById('site-title').value;
    siteSettings.description = document.getElementById('site-description').value;
    siteSettings.robots = document.getElementById('site-robots').value;
    siteSettings.author = document.getElementById('site-author').value;
    siteSettings.favicon = document.getElementById('site-favicon').value;
    siteSettings.socialImage = document.getElementById('site-social').value;
    siteSettings.headScript = document.getElementById('site-head-script').value;
    settingsModal.hide();
    updateDynamicNavbar();
  updateSiteTitleH1();
});

function getExportSectionHtml(block, exportMap) {
    if (block.type === 'embed') {
        return `
            <div style="position:relative; width:100%; height:100vh; margin:0; padding:0;">
                <iframe srcdoc="${block.code.replace(/"/g, '&quot;')}" 
                        style="position:absolute; top:0; left:0; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden;" 
                        sandbox="allow-scripts allow-same-origin allow-forms allow-popups">
                </iframe>
            </div>
        `;
    }
    return getMediaSectionHtml(block, exportMap);
}


function getMediaSectionHtml(block, exportMap) {
    let { type, src, url, heading, headingColor, headingSize, bgColor, mediaSize, btnLabel, btnUrl, btnColor, fileName } = block;
    let headingClass = `live-heading ${headingSize}`;
    let btnHtml = makeButtonHtml(btnLabel, btnUrl, btnColor);

    function refSrc(val, fileName, exportMap) {
        if (exportMap && fileName && exportMap[fileName]) {
            return 'media/' + exportMap[fileName];
        }
        return val;
    }

    const textBlock = `
        <div uk-scrollspy="cls: uk-animation-slide-top; repeat: true">
            <h2 class="${headingClass}" style="color: ${headingColor};">${heading || ''}</h2>
            ${getTextBlockHtml(block)}
            ${btnHtml}
        </div>
    `;

    // Decide animation for media
    let mediaSpy = '';
    if (mediaSize === 'left') mediaSpy = 'uk-scrollspy="cls: uk-animation-slide-right; repeat: true"';
    else if (mediaSize === 'right') mediaSpy = 'uk-scrollspy="cls: uk-animation-slide-left; repeat: true"';
    else if (mediaSize === 'center' || mediaSize === 'full') mediaSpy = 'uk-scrollspy="cls: uk-animation-slide-bottom; repeat: true"';

// EMBED: Full viewport
if (type === 'embed') {
    return `
        <div style="position:relative; width:100%; height:100vh; margin:0; padding:0;">
            <iframe srcdoc="${block.code.replace(/"/g, '&quot;')}" 
                    style="position:absolute; top:0; left:0; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden;" 
                    sandbox="allow-scripts allow-same-origin allow-forms allow-popups">
            </iframe>
        </div>
    `;
}

    // IMAGE
    if (type === 'image') {
        // FULL (image centered, responsive)
        if (mediaSize === 'full') {
            return `
<div style="position:relative; width:100vw; height:100vh; overflow:hidden; background:${bgColor};">
    <img src="${refSrc(src, fileName, exportMap)}"
         alt="Image"
         style="width:100vw; height:100vh; object-fit:cover; display:block;" 
         ${mediaSpy}>
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:100%;" 
         class="uk-text-center uk-light">
        ${textBlock}
    </div>
</div>
            `;
        }

        // CENTER (small centered media with text below)
        if (mediaSize === 'center') {
            return `
                <div class="uk-padding-large" style="background:${bgColor};">
                    <div class="uk-flex uk-flex-center uk-flex-middle uk-flex-wrap">
                        <div class="uk-text-center">
                            <img src="${refSrc(src, fileName, exportMap)}"
                                 alt="Image"
                                 class="uk-border-rounded uk-box-shadow-large"
                                 style="max-width:620px; width:100%; height:auto; display:block; margin:0 auto;"
                                 ${mediaSpy}>
                            ${textBlock}
                        </div>
                    </div>
                </div>
            `;
        }

        // LEFT (image left, text right)
        if (mediaSize === 'left') {
            return `
                <div class="uk-padding-large" style="background:${bgColor};">
                    <div class="uk-grid uk-grid-medium uk-flex-middle" uk-grid>
                        <div class="uk-width-1-2@m">
                            <img src="${refSrc(src, fileName, exportMap)}"
                                 alt="Image"
                                 class="uk-border-rounded uk-box-shadow-large"
                                 style="max-width:100%; width:100%; height:auto; display:block;"
                                 ${mediaSpy}>
                        </div>
                        <div class="uk-width-expand@m uk-padding-small">
                            ${textBlock}
                        </div>
                    </div>
                </div>
            `;
        }

// RIGHT (image right on desktop, text left; image above text on mobile)
if (mediaSize === 'right') {
    return `
        <div class="uk-padding-large" style="background:${bgColor};">
            <div class="uk-grid uk-grid-medium uk-flex-middle" uk-grid>
                <div class="uk-width-1-2@m uk-flex-last@m">
                    <img src="${refSrc(src, fileName, exportMap)}"
                         alt="Image"
                         class="uk-border-rounded uk-box-shadow-large"
                         style="max-width:100%; width:100%; height:auto; display:block;"
                         ${mediaSpy}>
                </div>
                <div class="uk-width-expand@m uk-padding-small">
                    ${textBlock}
                </div>
            </div>
        </div>
    `;
}

        // fallback (treat as left)
        return `
            <div class="uk-padding-large" style="background:${bgColor};">
                <div class="uk-grid uk-grid-medium uk-flex-middle" uk-grid>
                    <div class="uk-width-1-2@m">
                        <img src="${refSrc(src, fileName, exportMap)}"
                             alt="Image"
                             class="uk-border-rounded uk-box-shadow-large"
                             style="max-width:100%; width:100%; height:auto; display:block;"
                             ${mediaSpy}>
                    </div>
                    <div class="uk-width-expand@m uk-padding-small">
                        ${textBlock}
                    </div>
                </div>
            </div>
        `;
    }



    // VIDEO
    if (type === 'video') {
        // FULL (cover video background, text overlay)
        if (mediaSize === 'full') {
            return `
                <div style="position:relative; width:100vw; height:100vh; overflow:hidden;">
                    <video src="${refSrc(src, fileName, exportMap)}" autoplay loop muted playsinline
                        style="width:100vw;height:100vh;object-fit:cover;display:block;" ${mediaSpy}></video>
                    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:100%;" class="uk-text-center uk-light">
                        ${textBlock}
                    </div>
                </div>
            `;
        }

        // CENTER (small centered video with text below)
        if (mediaSize === 'center') {
            return `
                <div class="uk-padding-large" style="background:${bgColor};">
                    <div class="uk-flex uk-flex-center uk-flex-middle uk-flex-wrap">
                        <div class="uk-text-center">
                            <video src="${refSrc(src, fileName, exportMap)}" autoplay loop muted playsinline
                                   class="uk-border-rounded uk-box-shadow-large"
                                   style="max-width:620px; width:100%; height:auto; display:block; margin:0 auto;"
                                   ${mediaSpy}></video>
                            ${textBlock}
                        </div>
                    </div>
                </div>
            `;
        }

        // LEFT (video left, text right)
        if (mediaSize === 'left') {
            return `
                <div class="uk-padding-large" style="background:${bgColor};">
                    <div class="uk-grid uk-grid-medium uk-flex-middle" uk-grid>
                        <div class="uk-width-1-2@m">
                            <video src="${refSrc(src, fileName, exportMap)}" autoplay loop muted playsinline
                                class="uk-border-rounded uk-box-shadow-large"
                                style="max-width:100%; width:100%; height:auto; display:block;" ${mediaSpy}></video>
                        </div>
                        <div class="uk-width-expand@m uk-padding-small">
                            ${textBlock}
                        </div>
                    </div>
                </div>
            `;
        }

        // RIGHT (video right, text left)
        if (mediaSize === 'right') {
            return `
                <div class="uk-padding-large" style="background:${bgColor};">
                    <div class="uk-grid uk-grid-medium uk-flex-middle" uk-grid>
                        <div class="uk-width-expand@m uk-padding-small uk-text-right">
                            ${textBlock}
                        </div>
                        <div class="uk-width-1-2@m">
                            <video src="${refSrc(src, fileName, exportMap)}" autoplay loop muted playsinline
                                class="uk-border-rounded uk-box-shadow-large"
                                style="max-width:100%; width:100%; height:auto;" ${mediaSpy}></video>
                        </div>
                    </div>
                </div>
            `;
        }

        // fallback
        return `
            <div class="uk-padding-large" style="background:${bgColor};">
                <div class="uk-grid uk-grid-medium uk-flex-middle" uk-grid>
                    <div class="uk-width-1-2@m">
                        <video src="${refSrc(src, fileName, exportMap)}" autoplay loop muted playsinline
                            class="uk-border-rounded uk-box-shadow-large"
                            style="max-width:100%; width:100%; height:auto;" ${mediaSpy}></video>
                    </div>
                    <div class="uk-width-expand@m uk-padding-small">
                        ${textBlock}
                    </div>
                </div>
            </div>
        `;
    }

    // default fallback (if unknown type)
    return `<div class="uk-padding-large" style="background:${bgColor};">${textBlock}</div>`;
}

        // --- RENDER ---
        function renderAllSections() {
            editorRoot.innerHTML = '';
            allSections.forEach((block, idx) => {
                const li = document.createElement('li');
                li.dataset.id = block.id;
                li.className = 'editor-section uk-padding-remove uk-sortable-handle';
                li.style.position = 'relative';
                const removeBtn = `<button class="uk-button uk-button-danger uk-border-rounded editor-remove-btn" type="button" uk-icon="trash" uk-tooltip="Remove section"></button>`;
                const editBtn = `<button class="uk-icon-button uk-button-primary uk-border-rounded editor-edit-btn" type="button" uk-icon="pencil" uk-tooltip="Edit section"></button>`;
                const sectionStyle = `background: ${block.bgColor}; min-height:60vh;`;

                li.innerHTML = `
                    <section id="section-${idx}" class="uk-section uk-section-primary" uk-height-viewport="offset-top: true" style="${sectionStyle};">
                        ${editBtn}
                        ${removeBtn}
                        ${getMediaSectionHtml(block)}
                    </section>
                `;
                // --- Remove button always shows modal ---
                li.querySelector('.editor-remove-btn').addEventListener('click', function() {
                    toDeleteIndex = idx;
                    deleteModal.show();
                });
                // --- Edit ---
                li.querySelector('.editor-edit-btn').addEventListener('click', function () {
    if (block.type === 'embed') {
        setupEmbedModal(block, idx);
    } else {
        setupModal(block.type, block, idx);
    }
    if (block.type === 'embed') {
    UIkit.modal('#embed-modal').show();
} else {
        mediaModal.show();
    }
});

                editorRoot.appendChild(li);
            });
            UIkit.update(editorRoot);
            updateDynamicNavbar();
  updateSiteTitleH1();
        }

        // Confirm Delete modal
        confirmDeleteBtn.addEventListener('click', function() {
            if (toDeleteIndex !== null && allSections[toDeleteIndex]) {
                allSections.splice(toDeleteIndex, 1);
                renderAllSections();
                toDeleteIndex = null;
                deleteModal.hide();
            }
        });

        // Sortable event
UIkit.util.on(editorRoot, 'moved', function(e) {
    let newSections = [];
    Array.from(editorRoot.children).forEach(li => {
        let id = li.dataset.id;                      // use stable id
        let found = allSections.find(b => b.id === id);
        if (found) newSections.push(found);
    });
    if (newSections.length === allSections.length) {
        allSections = newSections;
    }
    renderAllSections(); // re-render to update section-ids and dynamic navbar
});

        // Modal submission
        mediaForm.addEventListener('submit', function(e) {
            e.preventDefault();
            let file = mediaFile.files[0];
            let url = mediaUrl.value.trim();
            let heading = mediaHeading.value || '';
            let headingColor = mediaColor.value || '#ffffff';
            let headingSizeVal = headingSize.value || 'uk-heading-2xlarge';
            let mediaSizeVal = mediaSize.value;
            let bgColorVal = bgColor.value || "#1e87f0";
            let btnLabelVal = btnLabel.value.trim();
            let btnUrlVal = btnUrl.value.trim();
            let btnColorVal = btnColor.value;
            // New
            let subtitleVal = mediaSubtitle.value || '';
            let subtitleSizeVal = subtitleSize.value || 'uk-heading-medium';
            let subtitleColorVal = subtitleColor.value || '#ffffff';
            let paragraphVal = mediaParagraph.value || '';
            let paragraphSizeVal = paragraphSize.value || '';
            let paragraphColorVal = paragraphColor.value || '#ffffff';

            let idx = sectionIndex.value ? parseInt(sectionIndex.value) : null;

function generateId() {
    return 'sec-' + Math.random().toString(36).substr(2, 9);
}

function finishSection(src, fileData, fileName, fileType) {
    let block = {
        id: (idx !== null && allSections[idx]) ? allSections[idx].id : generateId(), // keep old id if editing
        type: currentMediaType,
        src,
        url: url ? url : '',
        heading,
        headingColor,
        headingSize: headingSizeVal,
        bgColor: bgColorVal,
        mediaSize: mediaSizeVal,
        btnLabel: btnLabelVal,
        btnUrl: btnUrlVal,
        btnColor: btnColorVal,
        subtitle: subtitleVal,
        subtitleSize: subtitleSizeVal,
        subtitleColor: subtitleColorVal,
        paragraph: paragraphVal,
        paragraphSize: paragraphSizeVal,
        paragraphColor: paragraphColorVal
    };
                // Always set fileData and fileName if uploading
                if (!url && fileData && fileName) {
                    block.fileData = fileData;
                    block.fileName = fileName;
                    block.fileType = fileType;
                }
                if (idx !== null && !isNaN(idx)) {
                    allSections[idx] = block;
                } else {
                    allSections.push(block);
                }
                renderAllSections();
                mediaModal.hide();
            }

            if (file) {
                fileToDataURL(file, (dataurl, fileName, fileType) => finishSection(dataurl, dataurl, fileName, fileType));
            } else if (url) {
                finishSection(url);
            } else if (prevFile.style.display !== 'none' && keepPrevFile.checked && editingPrevFileData) {
                finishSection(editingPrevFileData, editingPrevFileData, editingPrevFileName, editingPrevFileType);
            } else {
                UIkit.notification({message: 'Please provide a URL or upload a file.', status: 'warning'});
                return;
            }
        });

// Save as JSON (wrap settings + sections)
saveJSONBtn.addEventListener('click', function() {
    const out = JSON.stringify({ settings: siteSettings, sections: allSections }, null, 2);
    const blob = new Blob([out], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
let fileName = prompt("Enter a name for your JSON file:", "homepage.json");
if (!fileName) fileName = "homepage.json"; // fallback
a.download = fileName.endsWith(".json") ? fileName : fileName + ".json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

// Load JSON (unwrap settings + sections)
loadJSONBtn.addEventListener('click', function() {
    jsonFileInput.click();
});

jsonFileInput.addEventListener('change', function(e) {
    if (!e.target.files[0]) return;
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function(evt) {
        try {
            const data = JSON.parse(evt.target.result || '{}');

            // If file only had sections (old format), fallback gracefully
            if (Array.isArray(data)) {
                allSections = data;
            } else {
                siteSettings = data.settings || siteSettings;
                siteSettings.navbar = Object.assign({ enabled:false, bg:'#ffffff', text:'#000000', logoUrl:'', logo:'', logoFileName:'' }, siteSettings.navbar || {});
                allSections = data.sections || [];
            }

            renderAllSections();
        } catch {
            UIkit.notification({message: 'Invalid JSON file!', status:'danger'});
        }
    };
    reader.readAsText(file);
    e.target.value = '';
});


// --- Favicon & Social Upload ---
const faviconFile = document.getElementById('site-favicon-file');
const faviconPreview = document.getElementById('site-favicon-preview');
const socialFile = document.getElementById('site-social-file');
const socialPreview = document.getElementById('site-social-preview');

faviconFile.addEventListener('change', (e) => {
  if (e.target.files[0]) {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = (ev) => {
      siteSettings.favicon = ev.target.result; // base64 dataurl
      siteSettings.faviconFileName = file.name;
      siteSettings.faviconFileType = file.type;
      faviconPreview.innerHTML = `<img src="${siteSettings.favicon}" style="max-height:40px;">`;
    };
    reader.readAsDataURL(file);
  }
});

socialFile.addEventListener('change', (e) => {
  if (e.target.files[0]) {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = (ev) => {
      siteSettings.socialImage = ev.target.result; // base64 dataurl
      siteSettings.socialFileName = file.name;
      siteSettings.socialFileType = file.type;
      socialPreview.innerHTML = `<img src="${siteSettings.socialImage}" style="max-height:80px;">`;
    };
    reader.readAsDataURL(file);
  }
});


// NEW: Navbar modal open/save

navBarBtn.addEventListener('click', () => {
  enableNavbar.checked = siteSettings.navbar.enabled;
  navbarBg.value = siteSettings.navbar.bg;
  navbarText.value = siteSettings.navbar.text;
  navbarLogoUrl.value = siteSettings.navbar.logoUrl || '';
  if (siteSettings.navbar.logoUrl) {
    navbarLogoUrlPreview.innerHTML = `<img src="${siteSettings.navbar.logoUrl}" class="navbar-logo">`;
  } else {
    navbarLogoUrlPreview.innerHTML = '';
  }
if (siteSettings.navbar.logoBlob) {
  navbarLogoPreview.innerHTML = `<img src="${URL.createObjectURL(siteSettings.navbar.logoBlob)}" class="navbar-logo">`;
} else if (siteSettings.navbar.logoUrl) {
  navbarLogoPreview.innerHTML = `<img src="${siteSettings.navbar.logoUrl}" class="navbar-logo">`;
} else {
  navbarLogoPreview.innerHTML = '';
}
  navbarModal.show();
});

navbarLogoUrl.addEventListener('input', () => {
  const url = navbarLogoUrl.value.trim();
  if (url) {
    navbarLogoUrlPreview.innerHTML = `<img src="${url}" class="navbar-logo">`;
  } else {
    navbarLogoUrlPreview.innerHTML = '';
  }
});

navbarLogo.addEventListener('change', (e) => {
  if (e.target.files[0]) {
    const file = e.target.files[0];
    siteSettings.navbar.logoFileName = file.name;
    siteSettings.navbar.logoBlob = file;   // ✅ blob, not base64
    siteSettings.navbar.logo = '';         // clear legacy base64
    navbarLogoPreview.innerHTML = `<img src="${URL.createObjectURL(file)}" class="navbar-logo">`;
  }
});

navbarForm.addEventListener('submit', (e) => {
  e.preventDefault();
  siteSettings.navbar.enabled = enableNavbar.checked;
  siteSettings.navbar.bg = navbarBg.value;
  siteSettings.navbar.text = navbarText.value;
  navbarModal.hide();
  updateDynamicNavbar();
  updateSiteTitleH1();
});

// Build dynamic navbar HTML for the EDITOR page (second navbar under toolbar)
function buildEditorDynamicNavBarHtml() {
  if (!siteSettings.navbar.enabled) return '';
  const links = [];
  
if (siteSettings.navbar.logoUrl) {
  links.push(`<li><a href="#top"><img src="${siteSettings.navbar.logoUrl}" alt="${siteSettings.title}" class="navbar-logo"></a></li>`);
} else if (siteSettings.navbar.logoBlob) {
  links.push(`<li><a href="#top"><img src="${URL.createObjectURL(siteSettings.navbar.logoBlob)}" alt="${siteSettings.title}" class="navbar-logo"></a></li>`);
} else {
  links.push(`<li><a href="#top">${siteSettings.title || 'Home'}</a></li>`);
}

  allSections.forEach((block, idx) => {
    if (block.heading) {
      const safe = String(block.heading).replace(/</g, '&lt;').replace(/>/g, '&gt;');
      links.push(`<li><a href="#section-${idx}">${safe}</a></li>`);
    }
  });
  // place below toolbar; sticky will naturally sit under it since toolbar also sticky
  return `<nav class="uk-navbar-container" style="background:${siteSettings.navbar.bg};position:sticky;top:60px;z-index:999;">
    <ul class="navbar-scroll" uk-scrollspy-nav="closest: a; scroll: true; offset: 100" style="color:${siteSettings.navbar.text};">
      ${links.join('')}
    </ul>
  </nav>`;
}

// Update/inject the dynamic navbar in the editor

// Toggle H1 visibility depending on logo presence
const siteTitleH1 = document.getElementById('site-title-h1');
function updateSiteTitleH1() {
  siteTitleH1.textContent = siteSettings.title || '';
  if (siteSettings.navbar.logoUrl || siteSettings.navbar.logoBlob) {
    siteTitleH1.classList.add('visually-hidden');
  } else {
    siteTitleH1.classList.remove('visually-hidden');
  }
}

function updateDynamicNavbar() {
  if (!dynamicNavbarContainer) return;
  dynamicNavbarContainer.innerHTML = buildEditorDynamicNavBarHtml();
}

// Recompute offset on resize (simple re-render)
window.addEventListener('resize', updateDynamicNavbar);


const previewBtn = document.getElementById('previewBtn');

// Helper: build dynamic navbar for PREVIEW/EXPORT (top:0 since no toolbar)
function buildPreviewDynamicNavBarHtml() {
  if (!siteSettings.navbar.enabled) return '';
  const links = [];

  if (siteSettings.navbar.logoExport) {
    // Exported file path (set during Export) -> use it first
    links.push(`<li><a href="#top"><img src="${siteSettings.navbar.logoExport}" alt="${siteSettings.title}" class="navbar-logo"></a></li>`);
  } else if (siteSettings.navbar.logoUrl) {
    // If a URL is provided, use it next
    links.push(`<li><a href="#top"><img src="${siteSettings.navbar.logoUrl}" alt="${siteSettings.title}" class="navbar-logo"></a></li>`);
  } else if (siteSettings.navbar.logoBlob) {
    // Fallback for Preview: uploaded file not exported yet
    const blobUrl = URL.createObjectURL(siteSettings.navbar.logoBlob);
    links.push(`<li><a href="#top"><img src="${blobUrl}" alt="${siteSettings.title}" class="navbar-logo"></a></li>`);
  } else {
    links.push(`<li><a href="#top">${siteSettings.title || 'Home'}</a></li>`);
  }

  allSections.forEach((block, idx) => {
    if (block.heading) {
      const safe = String(block.heading).replace(/</g, '&lt;').replace(/>/g, '&gt;');
      links.push(`<li><a href="#section-${idx}">${safe}</a></li>`);
    }
  });

  return `<nav class="uk-navbar-container" style="background:${siteSettings.navbar.bg};position:sticky;top:0;z-index:999;">
    <ul class="navbar-scroll" uk-scrollspy-nav="closest: a; scroll: true; offset: 100" style="color:${siteSettings.navbar.text};">
      ${links.join('')}
    </ul>
  </nav>`;
}

// Preview in new window
previewBtn.addEventListener('click', function () {
    const exportMap = {}; // not needed for preview, but avoids errors

let exportBlocks = allSections.map((block, idx) =>
    `<section id="section-${idx}" class="uk-section uk-section-primary" uk-height-viewport="offset-top: true" style="background:${block.bgColor};min-height:60vh;padding:0;margin:0;">
        ${getExportSectionHtml(block, exportMap)}
    </section>`
).join('\n');

    let navBarHtml = buildPreviewDynamicNavBarHtml();

    let html = `
<!DOCTYPE html>
<html lang="${siteSettings.language}">
<head>
  <meta charset="UTF-8">
  <title>${siteSettings.title}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="${siteSettings.description}">
  <meta name="robots" content="${siteSettings.robots}">
  <meta name="author" content="${siteSettings.author}">
  ${siteSettings.faviconExport ? `<link rel="icon" href="${siteSettings.faviconExport}">\n  <link rel="shortcut icon" href="${siteSettings.faviconExport}">` : ''}
  ${siteSettings.socialExport ? `<meta property="og:image" content="${siteSettings.socialExport}">` : ''}
  ${siteSettings.headScript || ''}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/css/uikit.min.css" />
  <style>
    .live-heading.uk-heading-large { font-size: 2.7rem; }
    .live-heading.uk-heading-xlarge { font-size: 3.6rem;}
    .live-heading.uk-heading-2xlarge { font-size: 4.8rem; line-height:1.05; }
    .live-subtitle.uk-heading-medium { font-size: 1.6rem; font-weight: 500;}
    .live-subtitle.uk-heading-large { font-size: 2.2rem; font-weight: 500;}
    .live-subtitle.uk-heading-xlarge { font-size: 2.9rem; font-weight: 500;}
    .live-paragraph { font-size: 1.13rem; max-width: 40em; margin-left:auto; margin-right:auto;}
    .live-paragraph.large { font-size: 1.45rem; }
    @media (max-width: 640px) {
      .live-heading.uk-heading-2xlarge { font-size: 2.2rem;}
      .live-heading.uk-heading-xlarge { font-size: 1.5rem;}
      .live-heading.uk-heading-large { font-size: 1.2rem;}
      .live-subtitle.uk-heading-xlarge { font-size: 1.4rem;}
      .live-subtitle.uk-heading-large { font-size: 1.1rem;}
      .live-subtitle.uk-heading-medium { font-size: 1.03rem;}
      .live-paragraph { font-size: 1rem;}
      .live-paragraph.large { font-size: 1.1rem;}
    }
    img, video { max-width: 100%; height: auto; display: block; }
    @media (max-width: 640px) {
      .live-heading, .live-subtitle, .live-paragraph {
        text-align: center !important;
        word-break: break-word;
        white-space: normal;
      }
    }
    .navbar-scroll {
      display:flex; flex-wrap:nowrap; gap:1rem; overflow-x:auto; white-space:nowrap; -webkit-overflow-scrolling:touch; padding:0.5rem 1rem; align-items:center; list-style:none; margin:0;
    }
    .navbar-scroll a { flex:0 0 auto; text-decoration:none; color:inherit; }
    .navbar-scroll a.uk-active { font-weight:bold; border-bottom:2px solid currentColor; }
  
.navbar-logo {
  height: 40px !important;
  width: auto !important;
  max-height: 40px !important;
  object-fit: contain;
  flex-shrink: 0 !important;
  flex-grow: 0 !important;
}
.navbar-scroll {
  display: flex;
  flex-wrap: nowrap;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  white-space: nowrap;
  gap: 1rem;
  padding: 0.5rem 1rem;
}
.navbar-scroll li {
  flex: 0 0 auto;
  list-style: none;
}

.visually-hidden {
  position: absolute !important;
  width: 1px; height: 1px;
  margin: -1px; padding: 0; border: 0;
  overflow: hidden; clip: rect(0 0 0 0); clip-path: inset(50%);
  white-space: nowrap;
}

  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0,0,0,0);
  border: 0;
}


:root {
  --navbar-link-color: #000000;
}

.navbar-scroll::-webkit-scrollbar {
  height: 6px;
}
.navbar-scroll::-webkit-scrollbar-thumb {
  background: var(--navbar-link-color);
  border-radius: 3px;
}
.navbar-scroll::-webkit-scrollbar-track {
  background: var(--gray, #eee);
}


.navbar-scroll {
  -ms-overflow-style: none;  /* IE & Edge */
  scrollbar-width: none;     /* Firefox */
}
.navbar-scroll::-webkit-scrollbar {
  display: none;             /* Chrome, Safari, Opera */
}

</style>
</head>
<body class="uk-background-muted" id="top">
<h1 id="site-title-h1" class="visually-hidden"></h1>
${navBarHtml}
${exportBlocks}
<script src="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/js/uikit.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/js/uikit-icons.min.js"><\/script>
</body>
</html>
`;

    let previewWindow = window.open("", "_blank");
    previewWindow.document.open();
    previewWindow.document.write(html);
    previewWindow.document.close();
});

        // Export as HTML+media ZIP
 exportHTMLBtn.addEventListener('click', async function() {
    const JSZip = window.JSZip;
    const zip = new JSZip();
    const exportMap = {};
    let promises = [];
    let fileIdx = 0;

    allSections.forEach((block, idx) => {
        if (block.fileData && block.fileName) {
            let ext = block.fileName.split('.').pop().toLowerCase();
            let newName = `mediafile${fileIdx + 1}.${ext}`;
            exportMap[block.fileName] = newName;
            promises.push(fetch(block.fileData).then(res => res.blob()).then(blob => {
                zip.file('media/' + newName, blob);
            }));
            fileIdx++;
        }
    });

// Include navbar logo in export (blob -> /media/logo.<ext>)
if (siteSettings.navbar.logoBlob && siteSettings.navbar.logoFileName) {
  const ext = siteSettings.navbar.logoFileName.split('.').pop().toLowerCase() || 'png';
  const newName = `logo.${ext}`;
  zip.file('media/' + newName, siteSettings.navbar.logoBlob);
  siteSettings.navbar.logoExport = 'media/' + newName;
}    

    // Include favicon in export if uploaded
    if (siteSettings.favicon && siteSettings.faviconFileName) {
        let ext = siteSettings.faviconFileName.split('.').pop().toLowerCase();
        let newName = `favicon.${ext}`;
        exportMap[siteSettings.faviconFileName] = newName;
        promises.push(fetch(siteSettings.favicon).then(res => res.blob()).then(blob => {
            zip.file('media/' + newName, blob);
        }));
        siteSettings.faviconExport = 'media/' + newName;
    }

    // Include social image in export if uploaded
    if (siteSettings.socialImage && siteSettings.socialFileName) {
        let ext = siteSettings.socialFileName.split('.').pop().toLowerCase();
        let newName = `social.${ext}`;
        exportMap[siteSettings.socialFileName] = newName;
        promises.push(fetch(siteSettings.socialImage).then(res => res.blob()).then(blob => {
            zip.file('media/' + newName, blob);
        }));
        siteSettings.socialExport = 'media/' + newName;
    }

    await Promise.all(promises);


let exportBlocks = allSections.map((block, idx) =>
    `<section id="section-${idx}" class="uk-section uk-section-primary" uk-height-viewport="offset-top: true" style="background:${block.bgColor};min-height:60vh;padding:0;margin:0;">
        ${getExportSectionHtml(block, exportMap)}
    </section>`
).join('\n');

    let navBarHtml = buildPreviewDynamicNavBarHtml();

    let html = `
<!DOCTYPE html>
<html lang="${siteSettings.language}">
<head>
  <meta charset="UTF-8">
  <title>${siteSettings.title}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="${siteSettings.description}">
  <meta name="robots" content="${siteSettings.robots}">
  <meta name="author" content="${siteSettings.author}">
  ${siteSettings.faviconExport ? `<link rel="icon" href="${siteSettings.faviconExport}">\n  <link rel="shortcut icon" href="${siteSettings.faviconExport}">` : ''}
  ${siteSettings.socialExport ? `<meta property="og:image" content="${siteSettings.socialExport}">` : ''}
  ${siteSettings.headScript || ''}
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/css/uikit.min.css" />
  <style>
    .live-heading.uk-heading-large { font-size: 2.7rem; }
    .live-heading.uk-heading-xlarge { font-size: 3.6rem;}
    .live-heading.uk-heading-2xlarge { font-size: 4.8rem; line-height:1.05; }
    .live-subtitle.uk-heading-medium { font-size: 1.6rem; font-weight: 500;}
    .live-subtitle.uk-heading-large { font-size: 2.2rem; font-weight: 500;}
    .live-subtitle.uk-heading-xlarge { font-size: 2.9rem; font-weight: 500;}
    .live-paragraph { font-size: 1.13rem; max-width: 40em; margin-left:auto; margin-right:auto;}
    .live-paragraph.large { font-size: 1.45rem; }
    @media (max-width: 640px) {
      .live-heading.uk-heading-2xlarge { font-size: 2.2rem;}
      .live-heading.uk-heading-xlarge { font-size: 1.5rem;}
      .live-heading.uk-heading-large { font-size: 1.2rem;}
      .live-subtitle.uk-heading-xlarge { font-size: 1.4rem;}
      .live-subtitle.uk-heading-large { font-size: 1.1rem;}
      .live-subtitle.uk-heading-medium { font-size: 1.03rem;}
      .live-paragraph { font-size: 1rem;}
      .live-paragraph.large { font-size: 1.1rem;}
    }
    /* Make exported images/videos responsive */
    img, video {
      max-width: 100%;
      height: auto;
      display: block;
    }

@media (max-width: 640px) {
  .live-heading, .live-subtitle, .live-paragraph {
    text-align: center !important;
    word-break: break-word;
    white-space: normal;
  }
}
    .navbar-scroll { display:flex; flex-wrap:nowrap; gap:1rem; overflow-x:auto; white-space:nowrap; -webkit-overflow-scrolling:touch; padding:0.5rem 1rem; align-items:center; list-style:none; margin:0; }
    .navbar-scroll a { flex:0 0 auto; text-decoration:none; color:inherit; }
    .navbar-scroll a.uk-active { font-weight:bold; border-bottom:2px solid currentColor; }
  
.navbar-logo {
  height: 40px !important;
  width: auto !important;
  max-height: 40px !important;
  object-fit: contain;
  flex-shrink: 0 !important;
  flex-grow: 0 !important;
}
.navbar-scroll {
  display: flex;
  flex-wrap: nowrap;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  white-space: nowrap;
  gap: 1rem;
  padding: 0.5rem 1rem;
}
.navbar-scroll li {
  flex: 0 0 auto;
  list-style: none;
}

.visually-hidden {
  position: absolute !important;
  width: 1px; height: 1px;
  margin: -1px; padding: 0; border: 0;
  overflow: hidden; clip: rect(0 0 0 0); clip-path: inset(50%);
  white-space: nowrap;
}

  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0,0,0,0);
  border: 0;
}


:root {
  --navbar-link-color: #000000;
}

.navbar-scroll::-webkit-scrollbar {
  height: 6px;
}
.navbar-scroll::-webkit-scrollbar-thumb {
  background: var(--navbar-link-color);
  border-radius: 3px;
}
.navbar-scroll::-webkit-scrollbar-track {
  background: var(--gray, #eee);
}


.navbar-scroll {
  -ms-overflow-style: none;  /* IE & Edge */
  scrollbar-width: none;     /* Firefox */
}
.navbar-scroll::-webkit-scrollbar {
  display: none;             /* Chrome, Safari, Opera */
}

</style>
</head>
<body class="uk-background-muted" id="top">
<h1 id="site-title-h1" class="visually-hidden">${siteSettings.title}</h1>
${navBarHtml}
${exportBlocks}
<script src="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/js/uikit.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/uikit@3.21.6/dist/js/uikit-icons.min.js"><\/script>
</body>
</html>
`;

    zip.file('index.html', html);

    const blob = await zip.generateAsync({ type: "blob" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
let fileName = prompt("Enter a name for your exported ZIP file:", "homepage.zip");
if (!fileName) fileName = "homepage.zip"; // fallback
a.download = fileName.endsWith(".zip") ? fileName : fileName + ".zip";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});
        // UIKit tooltips
        UIkit.util.on(document, 'DOMContentLoaded', function() {
            UIkit.tooltip('[uk-tooltip]');
        });

    </script>
</body>
</html>